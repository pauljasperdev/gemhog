---
phase: 01-testing-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - vitest.config.ts
  - apps/web/vitest.config.ts
  - apps/server/vitest.config.ts
  - packages/api/vitest.config.ts
  - packages/auth/vitest.config.ts
  - packages/env/vitest.config.ts
autonomous: true

must_haves:
  truths:
    - "Developer can run static analysis via single command with clear pass/fail"
    - "Developer can run unit tests via single command"
    - "Static analysis exits non-zero on warnings (CI-safe)"
  artifacts:
    - path: "vitest.config.ts"
      provides: "Root Vitest configuration with projects"
      contains: "projects:"
    - path: "apps/server/vitest.config.ts"
      provides: "Server unit test config"
      contains: "defineProject"
    - path: "apps/web/vitest.config.ts"
      provides: "Web unit test config"
      contains: "defineProject"
  key_links:
    - from: "vitest.config.ts"
      to: "apps/*/vitest.config.ts"
      via: "projects array glob"
      pattern: "projects.*apps"
    - from: "package.json"
      to: "vitest"
      via: "test:unit script"
      pattern: "test:unit.*vitest"
---

<objective>
Set up static analysis commands and unit testing framework with Vitest

Purpose: Establish the first two testing layers (static + unit) that can run independently and fast, enabling quick feedback during development.

Output: Working `pnpm check` (static analysis) and `pnpm test:unit` (Vitest unit tests) commands
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-testing-infrastructure/01-CONTEXT.md
@.planning/phases/01-testing-infrastructure/01-RESEARCH.md

# Existing configs
@package.json
@biome.json
@apps/server/package.json
@apps/web/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Vitest and configure root projects</name>
  <files>
    - package.json
    - vitest.config.ts
    - apps/web/vitest.config.ts
    - apps/server/vitest.config.ts
    - packages/api/vitest.config.ts
    - packages/auth/vitest.config.ts
    - packages/env/vitest.config.ts
  </files>
  <action>
Install Vitest and coverage dependencies at workspace root:
```bash
pnpm add -D vitest @vitest/coverage-v8 happy-dom
```

Create root `vitest.config.ts` using Vitest 3.2+ `projects` configuration (NOT workspace files - those are deprecated):

```typescript
import { defineConfig } from 'vitest/config'

export default defineConfig({
  test: {
    projects: [
      'apps/*',
      'packages/*',
    ],
    reporters: ['default'],
    coverage: {
      provider: 'v8',
      reporter: ['text'],
      include: ['**/src/**'],
      exclude: ['**/node_modules/**', '**/dist/**', '**/*.test.ts', '**/*.spec.ts'],
    },
  },
})
```

Create project-specific configs using `defineProject` (not `defineConfig`):

For `apps/server/vitest.config.ts`:
```typescript
import { defineProject } from 'vitest/config'

export default defineProject({
  test: {
    name: 'server',
    environment: 'node',
    include: ['src/**/*.test.ts'],
  },
})
```

For `apps/web/vitest.config.ts`:
```typescript
import { defineProject } from 'vitest/config'

export default defineProject({
  test: {
    name: 'web',
    environment: 'happy-dom',
    include: ['src/**/*.test.ts', 'app/**/*.test.ts'],
  },
})
```

For each package (`packages/api`, `packages/auth`, `packages/env`), create similar configs with `environment: 'node'` and appropriate name (e.g., `@gemhog/api`).

Skip `packages/db` (will be configured in Plan 02 with globalSetup for Docker) and `packages/config` (no testable code).
  </action>
  <verify>
Run `pnpm vitest --run` - should complete with no test files found (expected, no tests written yet) but no configuration errors.
  </verify>
  <done>
Vitest configured with projects for apps/server, apps/web, packages/api, packages/auth, packages/env. Root config aggregates all projects.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add test and check scripts to package.json</name>
  <files>
    - package.json
  </files>
  <action>
Update root `package.json` scripts section to add:

```json
{
  "scripts": {
    "check": "biome check --error-on-warnings .",
    "check:fix": "biome check --write .",
    "test:unit": "vitest run",
    "test:unit:watch": "vitest"
  }
}
```

Key changes:
- `check`: Add `--error-on-warnings` flag (CI-safe exit code on warnings)
- `check:fix`: Rename existing `check` behavior to explicit fix command
- `test:unit`: Run all unit tests once (for CI/verification)
- `test:unit:watch`: Interactive watch mode (for development)

Keep existing scripts intact. The `check` script replaces the existing one that had `--write`.
  </action>
  <verify>
Run these commands and verify exit codes:
- `pnpm check` - exits 0 if no issues, non-zero on warnings/errors
- `pnpm test:unit` - exits 0 (no tests found is OK)
  </verify>
  <done>
Root package.json has `check` (static analysis), `check:fix` (auto-fix), `test:unit` (run tests), `test:unit:watch` (dev mode) scripts.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add example unit test to verify setup</name>
  <files>
    - packages/api/src/example.test.ts
  </files>
  <action>
Create a minimal example test to verify the Vitest setup works end-to-end:

```typescript
// packages/api/src/example.test.ts
import { describe, it, expect } from 'vitest'

describe('example', () => {
  it('should pass a basic test', () => {
    expect(1 + 1).toBe(2)
  })
})
```

This test confirms:
1. Vitest can discover tests via project config
2. Test imports work correctly
3. The test runner executes and reports results
  </action>
  <verify>
Run `pnpm test:unit` - should show 1 test passing in `@gemhog/api` project.
  </verify>
  <done>
Example test passes, proving Vitest setup is complete and functional.
  </done>
</task>

</tasks>

<verification>
Run full verification sequence:
1. `pnpm check` - static analysis passes with no warnings
2. `pnpm test:unit` - unit tests pass (1 example test)
3. `echo $?` after each command shows exit code 0
</verification>

<success_criteria>
- [ ] `pnpm check` runs Biome with `--error-on-warnings` flag
- [ ] `pnpm test:unit` runs Vitest across all configured projects
- [ ] Root vitest.config.ts uses `projects` array (not deprecated workspace files)
- [ ] Each app/package has its own vitest.config.ts with `defineProject`
- [ ] At least one test passes to prove setup works
- [ ] All commands return proper exit codes (0 on success, non-zero on failure)
</success_criteria>

<output>
After completion, create `.planning/phases/01-testing-infrastructure/01-01-SUMMARY.md`
</output>
