---
phase: 01-testing-infrastructure
plan: 03
type: execute
wave: 2
depends_on: ["01-01", "01-02"]
files_modified:
  - playwright.config.ts
  - apps/web/tests/e2e/home.spec.ts
  - lefthook.yml
  - scripts/verify.sh
  - package.json
autonomous: true

must_haves:
  truths:
    - "E2E tests auto-start both web and server dev servers"
    - "E2E tests can run via Playwright against localhost dev server"
    - "Pre-commit hook runs lint + unit tests + typecheck"
    - "Full verify command runs all stages in sequence with fail-fast"
    - "All test commands have clear pass/fail exit codes"
  artifacts:
    - path: "playwright.config.ts"
      provides: "E2E test configuration with webServer auto-start"
      contains: "webServer"
    - path: "apps/web/tests/e2e/home.spec.ts"
      provides: "Example E2E test"
      contains: "@playwright/test"
    - path: "lefthook.yml"
      provides: "Pre-commit hook configuration"
      contains: "pre-commit"
    - path: "scripts/verify.sh"
      provides: "Full test orchestration script"
      contains: "set -e"
  key_links:
    - from: "playwright.config.ts"
      to: "apps/web"
      via: "webServer command"
      pattern: "pnpm dev:web"
    - from: "playwright.config.ts"
      to: "apps/server"
      via: "webServer command"
      pattern: "pnpm dev:server"
    - from: "package.json"
      to: "scripts/verify.sh"
      via: "verify script"
      pattern: "verify.*verify.sh"
---

<objective>
Set up E2E testing with Playwright, pre-commit hooks with Lefthook, and test orchestration script

Purpose: Complete the testing pyramid with E2E tests and establish developer workflow automation (pre-commit checks, full verification script).

Output: Working `pnpm test:e2e` (Playwright), `pnpm verify:commit` (pre-commit check), and `pnpm verify` (full test suite) commands
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-testing-infrastructure/01-CONTEXT.md
@.planning/phases/01-testing-infrastructure/01-RESEARCH.md

# Prior plan summaries (if needed for context)
@.planning/phases/01-testing-infrastructure/01-01-SUMMARY.md
@.planning/phases/01-testing-infrastructure/01-02-SUMMARY.md

# Existing configs
@package.json
@apps/web/package.json
@apps/server/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install and configure Playwright</name>
  <files>
    - playwright.config.ts
    - apps/web/tests/e2e/home.spec.ts
    - package.json
  </files>
  <action>
Install Playwright at workspace root:
```bash
pnpm add -D @playwright/test
npx playwright install chromium
```

Create `playwright.config.ts` at project root with webServer auto-start for both frontend and backend:

```typescript
// playwright.config.ts
import { defineConfig, devices } from '@playwright/test'

export default defineConfig({
  testDir: './apps/web/tests/e2e',
  fullyParallel: true,
  forbidOnly: !!process.env.CI,
  retries: process.env.CI ? 2 : 0,
  workers: process.env.CI ? 1 : undefined,
  reporter: 'list',

  use: {
    baseURL: 'http://localhost:3001',
    trace: 'on-first-retry',
  },

  webServer: [
    {
      command: 'pnpm dev:server',
      url: 'http://localhost:3000',
      reuseExistingServer: !process.env.CI,
      timeout: 120 * 1000,
      stdout: 'ignore',
      stderr: 'pipe',
    },
    {
      command: 'pnpm dev:web',
      url: 'http://localhost:3001',
      reuseExistingServer: !process.env.CI,
      timeout: 120 * 1000,
      stdout: 'ignore',
      stderr: 'pipe',
    },
  ],

  projects: [
    {
      name: 'chromium',
      use: { ...devices['Desktop Chrome'] },
    },
  ],
})
```

Create example E2E test `apps/web/tests/e2e/home.spec.ts`:

```typescript
// apps/web/tests/e2e/home.spec.ts
import { test, expect } from '@playwright/test'

test('homepage loads', async ({ page }) => {
  await page.goto('/')
  // Verify the page loads without error
  await expect(page).toHaveURL('/')
})

test('page has content', async ({ page }) => {
  await page.goto('/')
  // Basic check that something renders
  const body = page.locator('body')
  await expect(body).toBeVisible()
})
```

Add E2E test script to root `package.json`:
```json
{
  "scripts": {
    "test:e2e": "playwright test"
  }
}
```

Key design:
- `reuseExistingServer: !process.env.CI` - In CI, always start fresh. Locally, reuse if already running.
- Both servers must be healthy before tests run (Playwright waits for URLs)
- Chromium-only (faster, sufficient for most E2E needs)
  </action>
  <verify>
Run `pnpm test:e2e` - should auto-start both servers and pass the basic tests. If servers are already running, should reuse them.
  </verify>
  <done>
Playwright configured with webServer auto-start for both apps. E2E tests run via `pnpm test:e2e`.
  </done>
</task>

<task type="auto">
  <name>Task 2: Install and configure Lefthook pre-commit hooks</name>
  <files>
    - lefthook.yml
    - package.json
  </files>
  <action>
Install Lefthook:
```bash
pnpm add -D lefthook
```

Create `lefthook.yml` at project root:

```yaml
# lefthook.yml
# Pre-commit hook runs fast checks only
pre-commit:
  parallel: true
  commands:
    biome:
      glob: "*.{js,ts,cjs,mjs,jsx,tsx,json,jsonc}"
      run: npx biome check --no-errors-on-unmatched --files-ignore-unknown=true {staged_files}
    typecheck:
      run: pnpm check-types

# Post-checkout hook for dependency updates (optional quality of life)
post-checkout:
  commands:
    install:
      run: pnpm install --frozen-lockfile
      skip:
        - rebase
        - merge
```

Add setup scripts to root `package.json`:
```json
{
  "scripts": {
    "prepare": "lefthook install",
    "verify:commit": "pnpm check && pnpm check-types && pnpm test:unit"
  }
}
```

The `prepare` script runs automatically after `pnpm install`, ensuring hooks are always installed.

Run `pnpm prepare` to install hooks for current session.

Note: The pre-commit hook runs Biome on staged files only (fast). The `verify:commit` script runs the full pre-commit equivalent manually (useful for agents or CI).
  </action>
  <verify>
1. Run `lefthook install` to ensure hooks are active
2. Stage a file with a lint issue, attempt commit - should be blocked
3. Run `pnpm verify:commit` - should pass if code is clean
  </verify>
  <done>
Lefthook installed with pre-commit hook (Biome + typecheck). `verify:commit` script available for manual/agent use.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create full verification orchestration script</name>
  <files>
    - scripts/verify.sh
    - package.json
  </files>
  <action>
Create `scripts/verify.sh` with fail-fast behavior:

```bash
#!/bin/bash
# scripts/verify.sh
# Full verification pipeline - run before completing features
# Fail-fast: stops on first error
set -e

echo "=== Static Analysis ==="
pnpm check
pnpm check-types
echo "OK static"
echo ""

echo "=== Unit Tests ==="
pnpm test:unit
echo "OK unit"
echo ""

echo "=== Integration Tests ==="
pnpm test:integration
echo "OK integration"
echo ""

echo "=== E2E Tests ==="
pnpm test:e2e
echo "OK e2e"
echo ""

echo "========================================="
echo "ALL TESTS PASSED"
echo "========================================="
```

Make it executable:
```bash
chmod +x scripts/verify.sh
```

Add to root `package.json`:
```json
{
  "scripts": {
    "verify": "./scripts/verify.sh"
  }
}
```

This script:
- Runs stages in order: static -> unit -> integration -> e2e
- `set -e` ensures fail-fast (stops on first failure)
- Clear output showing which stage is running
- Summary at end confirms all passed
  </action>
  <verify>
1. Run `pnpm verify` with all services working - should complete all stages
2. Introduce a deliberate lint error, run `pnpm verify` - should stop at static analysis
3. Verify exit code is non-zero on failure: `pnpm verify; echo "Exit code: $?"`
  </verify>
  <done>
`pnpm verify` runs complete test pipeline with fail-fast behavior and clear output.
  </done>
</task>

</tasks>

<verification>
Complete verification sequence:
1. `pnpm verify` - runs all test stages in order, all pass
2. `pnpm verify:commit` - runs pre-commit equivalent, passes
3. Create a commit with staged files - pre-commit hook runs
4. Verify CI-safe: All scripts return proper exit codes
5. Check TEST-06: All commands have clear pass/fail exit codes for automation
</verification>

<success_criteria>
- [ ] `pnpm test:e2e` runs Playwright with auto-starting servers
- [ ] Playwright waits for both web (3001) and server (3000) to be ready
- [ ] Pre-commit hook runs Biome + typecheck on staged files
- [ ] `pnpm verify:commit` runs lint + types + unit (for agents)
- [ ] `pnpm verify` runs full pipeline: static -> unit -> integration -> e2e
- [ ] `set -e` in verify.sh ensures fail-fast behavior
- [ ] All commands return 0 on success, non-zero on failure
</success_criteria>

<output>
After completion, create `.planning/phases/01-testing-infrastructure/01-03-SUMMARY.md`
</output>
