---
phase: 01-testing-infrastructure
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - playwright.config.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "pnpm test:integration runs packages/db tests successfully"
    - "pnpm test:e2e starts webServer without env validation errors"
    - "pnpm verify completes all stages including integration and E2E"
  artifacts:
    - path: "package.json"
      provides: "Correct test:integration script"
      contains: "--config packages/db/vitest.config.ts"
    - path: "playwright.config.ts"
      provides: "Test environment variables for webServer"
      contains: "BETTER_AUTH_SECRET"
  key_links:
    - from: "package.json"
      to: "packages/db/vitest.config.ts"
      via: "--config flag in test:integration"
      pattern: "--config packages/db/vitest.config.ts"
    - from: "playwright.config.ts"
      to: "webServer processes"
      via: "env object in webServer config"
      pattern: "env:.*BETTER_AUTH_SECRET"
---

<objective>
Fix UAT gaps in testing infrastructure: integration tests and E2E tests

Purpose: Close verification gaps from UAT testing where test:integration and test:e2e commands fail due to configuration issues
Output: Working pnpm test:integration and pnpm test:e2e commands
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@packages/db/vitest.config.ts
@packages/env/src/server.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix integration test script</name>
  <files>package.json</files>
  <action>
Update the test:integration script in package.json.

Current (broken):
```json
"test:integration": "vitest run --project @gemhog/db",
```

Change to (working):
```json
"test:integration": "vitest run --config packages/db/vitest.config.ts",
```

Why: The root vitest.config.ts uses a projects array that explicitly excludes packages/db with `!packages/db`. The --project flag tries to find a matching project in that array, which fails. Using --config directly points Vitest to the packages/db config file which has its own globalSetup for Docker.
  </action>
  <verify>Run `pnpm test:integration` with Docker running. Should execute tests from packages/db successfully (or skip if no tests exist yet).</verify>
  <done>test:integration script uses --config flag and can find/run packages/db tests</done>
</task>

<task type="auto">
  <name>Task 2: Add test environment variables for Playwright webServer</name>
  <files>playwright.config.ts</files>
  <action>
Add environment variables to the webServer configurations in playwright.config.ts so that the dev servers can start without env validation failures.

The server requires these env vars (from packages/env/src/server.ts):
- DATABASE_URL: string (min 1 char)
- BETTER_AUTH_SECRET: string (min 32 chars)
- BETTER_AUTH_URL: valid URL
- POLAR_ACCESS_TOKEN: string (min 1 char)
- POLAR_SUCCESS_URL: valid URL
- CORS_ORIGIN: valid URL

Add an `env` property to both webServer entries with test values:

```typescript
webServer: [
  {
    command: "pnpm dev:server",
    url: "http://localhost:3000",
    reuseExistingServer: !process.env.CI,
    timeout: 120 * 1000,
    stdout: "ignore",
    stderr: "pipe",
    env: {
      ...process.env,
      DATABASE_URL: process.env.DATABASE_URL || "postgresql://postgres:postgres@localhost:5432/gemhog_test",
      BETTER_AUTH_SECRET: process.env.BETTER_AUTH_SECRET || "test-secret-key-for-e2e-minimum-32-chars",
      BETTER_AUTH_URL: process.env.BETTER_AUTH_URL || "http://localhost:3000",
      POLAR_ACCESS_TOKEN: process.env.POLAR_ACCESS_TOKEN || "test-polar-token",
      POLAR_SUCCESS_URL: process.env.POLAR_SUCCESS_URL || "http://localhost:3001/success",
      CORS_ORIGIN: process.env.CORS_ORIGIN || "http://localhost:3001",
    },
  },
  {
    command: "pnpm dev:web",
    url: "http://localhost:3001",
    reuseExistingServer: !process.env.CI,
    timeout: 120 * 1000,
    stdout: "ignore",
    stderr: "pipe",
  },
],
```

Note: Only the server needs the env vars. The web app doesn't import @gemhog/env server module. Using `...process.env` allows real env vars to override test defaults when available.
  </action>
  <verify>Run `pnpm test:e2e`. The webServer should start successfully without BETTER_AUTH_SECRET validation errors.</verify>
  <done>E2E tests can start dev servers with test environment variables</done>
</task>

</tasks>

<verification>
After completing both tasks:

1. `pnpm test:integration` - Should run packages/db tests (or report no tests if none exist)
2. `pnpm test:e2e` - Should start webServer successfully and run Playwright tests
3. `pnpm verify` - Full verification pipeline should complete all stages

All three UAT gaps (Tests 3, 4, 5) should now pass.
</verification>

<success_criteria>
- test:integration script correctly targets packages/db/vitest.config.ts
- Playwright webServer starts without env validation errors
- pnpm verify completes successfully through all stages
</success_criteria>

<output>
After completion, create `.planning/phases/01-testing-infrastructure/01-04-SUMMARY.md`
</output>
