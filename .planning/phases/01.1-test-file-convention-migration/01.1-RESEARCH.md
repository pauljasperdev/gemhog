# Phase 1.1: Test File Convention Migration - Research

**Researched:** 2026-01-19
**Domain:** Test file naming conventions, Vitest/Playwright configuration
**Confidence:** HIGH

## Summary

This research inventories all test files in the codebase and analyzes what configuration changes are needed to migrate from the current naming convention to the new standard:
- Unit tests: `*.test.ts` (no change)
- Integration tests: `*.integration.test.ts` -> `*.int.test.ts`
- E2E tests: `*.spec.ts` -> `*.e2e.test.ts`

The migration is straightforward with only 3 test files in the project. The main work is updating configuration files and documentation to match the new glob patterns.

**Primary recommendation:** Rename test files first, then update all configs atomically, then update docs. This order prevents config-file mismatch during migration.

## Current Test Inventory

### Complete File Listing

| File | Current Suffix | New Suffix | Test Type | Change Required |
|------|---------------|------------|-----------|-----------------|
| `packages/api/src/example.test.ts` | `.test.ts` | `.test.ts` | Unit | None |
| `packages/db/src/connection.integration.test.ts` | `.integration.test.ts` | `.int.test.ts` | Integration | Rename |
| `apps/web/tests/e2e/home.spec.ts` | `.spec.ts` | `.e2e.test.ts` | E2E | Rename |

**Total:** 3 test files
- 1 unit test (no change)
- 1 integration test (rename)
- 1 E2E test (rename)

### Files That Need Renaming

1. `packages/db/src/connection.integration.test.ts` -> `packages/db/src/connection.int.test.ts`
2. `apps/web/tests/e2e/home.spec.ts` -> `apps/web/tests/e2e/home.e2e.test.ts`

## Configuration Analysis

### Current vs New Glob Patterns

| Config File | Current Pattern | New Pattern | Location |
|-------------|-----------------|-------------|----------|
| `vitest.config.ts` | `**/*.integration.test.ts` (exclude) | `**/*.int.test.ts` (exclude) | Root |
| `vitest.integration.config.ts` | `*.integration.test.ts` (include) | `*.int.test.ts` (include) | Root |
| `playwright.config.ts` | `*.spec.ts` (implicit) | `*.e2e.test.ts` (explicit?) | Root |
| `packages/db/vitest.config.ts` | `**/*.integration.test.ts` (exclude) | `**/*.int.test.ts` (exclude) | Package |

### Detailed Config Changes

#### 1. Root `vitest.config.ts`

**Current (line 10-11, 22):**
```typescript
exclude: [
  "**/node_modules/**",
  "**/dist/**",
  "**/*.integration.test.ts", // Integration tests have their own config
],
// ...
exclude: [
  // ...
  "**/*.integration.test.ts",
],
```

**New:**
```typescript
exclude: [
  "**/node_modules/**",
  "**/dist/**",
  "**/*.int.test.ts", // Integration tests have their own config
],
// ...
exclude: [
  // ...
  "**/*.int.test.ts",
],
```

#### 2. Root `vitest.integration.config.ts`

**Current (lines 10-13):**
```typescript
include: [
  "apps/**/src/**/*.integration.test.ts",
  "packages/**/src/**/*.integration.test.ts",
],
```

**New:**
```typescript
include: [
  "apps/**/src/**/*.int.test.ts",
  "packages/**/src/**/*.int.test.ts",
],
```

#### 3. Root `playwright.config.ts`

**Current (line 5):**
```typescript
testDir: "./apps/web/tests/e2e",
// No explicit testMatch - Playwright defaults to *.spec.ts
```

**New (add explicit testMatch):**
```typescript
testDir: "./apps/web/tests/e2e",
testMatch: "**/*.e2e.test.ts",
```

#### 4. `packages/db/vitest.config.ts`

**Current (line 9):**
```typescript
exclude: ["**/*.integration.test.ts"],
```

**New:**
```typescript
exclude: ["**/*.int.test.ts"],
```

## Documentation Updates Required

### TESTING.md Changes

**Section: Test File Naming Convention (lines 92-99)**

Current:
```markdown
| Suffix | Type | Command | Description |
|--------|------|---------|-------------|
| `*.test.ts` | Unit | `pnpm test:unit` | Fast, mocked externals |
| `*.integration.test.ts` | Integration | `pnpm test:integration` | Real DB, Docker required |
| `*.spec.ts` | E2E | `pnpm test:e2e` | Playwright, full app |
```

New:
```markdown
| Suffix | Type | Command | Description |
|--------|------|---------|-------------|
| `*.test.ts` | Unit | `pnpm test:unit` | Fast, mocked externals |
| `*.int.test.ts` | Integration | `pnpm test:integration` | Real DB, Docker required |
| `*.e2e.test.ts` | E2E | `pnpm test:e2e` | Playwright, full app |
```

**Section: Example structure (lines 102-110)** - Update example file names

**Section: Adding Integration Tests (lines 112-122)** - Update pattern description

**Section: Test Framework Integration Tests (lines 76-79)** - Update pattern

### STATE.md Changes

**Section: Test File Convention (lines 100-104)**

Current:
```markdown
**Test File Convention:**
- `*.test.ts` - Unit tests (mocked, fast)
- `*.integration.test.ts` - Integration tests (real DB, Docker)
- `*.spec.ts` - E2E tests (Playwright)
```

New:
```markdown
**Test File Convention:**
- `*.test.ts` - Unit tests (mocked, fast)
- `*.int.test.ts` - Integration tests (real DB, Docker)
- `*.e2e.test.ts` - E2E tests (Playwright)
```

## Migration Risks

### Low Risk

1. **Import paths unchanged** - File renames don't affect imports (tests don't import each other)
2. **Git history preserved** - Using `git mv` tracks renames properly
3. **No CI changes needed** - CI runs `pnpm test:*` commands, not globs directly

### Medium Risk

1. **Config-file mismatch during migration** - If configs are updated before/after files, tests may not run
   - **Mitigation:** Rename files first, then update all configs atomically in one commit

2. **Playwright default pattern** - Playwright defaults to `*.spec.ts`
   - **Mitigation:** Add explicit `testMatch` to prevent future confusion

### Zero Risk

1. **verify.sh script** - Uses command names (`pnpm test:*`), not globs - no changes needed
2. **package.json scripts** - Use config file paths, not globs - no changes needed

## Migration Approach

### Recommended Order

1. **Rename test files** (git mv for proper tracking)
   ```bash
   git mv packages/db/src/connection.integration.test.ts packages/db/src/connection.int.test.ts
   git mv apps/web/tests/e2e/home.spec.ts apps/web/tests/e2e/home.e2e.test.ts
   ```

2. **Update vitest configs** (root + packages/db)
   - Change all `*.integration.test.ts` patterns to `*.int.test.ts`

3. **Update playwright.config.ts**
   - Add explicit `testMatch: "**/*.e2e.test.ts"`

4. **Update documentation**
   - TESTING.md: All pattern references
   - STATE.md: Test file convention section

5. **Verify all tests run**
   ```bash
   pnpm test:unit
   pnpm test:integration  # requires pnpm db:start
   pnpm test:e2e          # requires running servers
   ```

### Single Commit Approach

All changes can be made in a single commit since:
- Only 3 files being renamed
- Only 4 config files being updated
- Only 2 documentation files being updated
- Changes are atomic and related

## Don't Hand-Roll

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Batch file renaming | Custom script | `git mv` commands | Git tracks renames correctly |
| Pattern matching | Regex replacement | Simple find/replace | Patterns are simple strings |

## Common Pitfalls

### Pitfall 1: Forgetting Playwright testMatch

**What goes wrong:** After renaming to `.e2e.test.ts`, Playwright finds no tests (defaults to `*.spec.ts`)
**Why it happens:** Playwright's default test pattern isn't documented prominently
**How to avoid:** Always add explicit `testMatch` when deviating from defaults
**Warning signs:** `0 tests found` in Playwright output

### Pitfall 2: Partial Config Updates

**What goes wrong:** Some configs updated, others not - tests run in wrong mode or not at all
**Why it happens:** Multiple config files with same pattern
**How to avoid:** Update all configs in same commit, run all test commands to verify
**Warning signs:** Integration tests running as unit tests, or tests not found

### Pitfall 3: Documentation Drift

**What goes wrong:** Code uses new convention, docs still reference old one
**Why it happens:** Docs updated in separate PR or forgotten
**How to avoid:** Include documentation updates in same PR as code changes
**Warning signs:** New developers confused by mismatched docs

## Code Examples

### git mv Commands (Verified)

```bash
# Rename integration test
git mv packages/db/src/connection.integration.test.ts packages/db/src/connection.int.test.ts

# Rename E2E test
git mv apps/web/tests/e2e/home.spec.ts apps/web/tests/e2e/home.e2e.test.ts
```

### Updated vitest.config.ts (Root)

```typescript
// vitest.config.ts
import { defineConfig } from "vitest/config";

export default defineConfig({
  test: {
    projects: ["apps/*", "packages/*"],
    exclude: [
      "**/node_modules/**",
      "**/dist/**",
      "**/*.int.test.ts", // Integration tests have their own config
    ],
    reporters: ["default"],
    coverage: {
      provider: "v8",
      reporter: ["text"],
      include: ["**/src/**"],
      exclude: [
        "**/node_modules/**",
        "**/dist/**",
        "**/*.test.ts",
        "**/*.int.test.ts",
      ],
    },
  },
});
```

### Updated vitest.integration.config.ts

```typescript
// vitest.integration.config.ts
import { defineConfig } from "vitest/config";

export default defineConfig({
  test: {
    name: "integration",
    environment: "node",
    include: [
      "apps/**/src/**/*.int.test.ts",
      "packages/**/src/**/*.int.test.ts",
    ],
    exclude: ["**/node_modules/**", "**/dist/**"],
    hookTimeout: 30000,
    testTimeout: 10000,
    isolate: false,
    fileParallelism: false,
  },
});
```

### Updated playwright.config.ts (Relevant Section)

```typescript
// playwright.config.ts
export default defineConfig({
  testDir: "./apps/web/tests/e2e",
  testMatch: "**/*.e2e.test.ts",  // Add explicit pattern
  fullyParallel: true,
  // ... rest unchanged
});
```

### Updated packages/db/vitest.config.ts

```typescript
// packages/db/vitest.config.ts
import { defineProject } from "vitest/config";

export default defineProject({
  test: {
    name: "@gemhog/db",
    environment: "node",
    include: ["src/**/*.test.ts"],
    exclude: ["**/*.int.test.ts"],
  },
});
```

## Verification Commands

After migration, run all test types to verify:

```bash
# Unit tests (should find 1 test)
pnpm test:unit

# Integration tests (requires Docker - should find 1 test)
pnpm db:start
pnpm test:integration

# E2E tests (requires env - should find 2 tests in 1 file)
pnpm test:e2e
```

## Open Questions

None - this is a straightforward mechanical migration with no ambiguity.

## Sources

### Primary (HIGH confidence)

All information derived from direct codebase inspection:
- `/home/lima/repo/vitest.config.ts`
- `/home/lima/repo/vitest.integration.config.ts`
- `/home/lima/repo/playwright.config.ts`
- `/home/lima/repo/packages/db/vitest.config.ts`
- `/home/lima/repo/.planning/codebase/TESTING.md`
- `/home/lima/repo/.planning/STATE.md`
- `/home/lima/repo/package.json`

### Verification

Glob/find commands confirmed exact test file inventory.

## Metadata

**Confidence breakdown:**
- Test inventory: HIGH - verified via filesystem search
- Config changes: HIGH - derived from reading actual config files
- Documentation: HIGH - direct inspection of markdown files
- Migration risks: HIGH - based on codebase structure analysis

**Research date:** 2026-01-19
**Valid until:** 2026-02-19 (stable - no external dependencies)
