---
phase: 02-email-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/env/src/server.ts
  - packages/env/src/server.test.ts
  - packages/core/src/auth/auth.service.ts
  - packages/core/src/auth/auth.test.ts
  - packages/core/src/auth/auth.int.test.ts
  - apps/server/src/app.ts
  - apps/server/src/startup.int.test.ts
  - apps/server/.env.example
  - apps/web/.env.example
  - playwright.config.ts
  - infra/web.ts
  - infra/api.ts
autonomous: true

must_haves:
  truths:
    - "Every reference to CORS_ORIGIN in the codebase now reads APP_URL"
    - "pnpm test passes with zero failures"
    - "pnpm dev still starts successfully with .env files using APP_URL"
  artifacts:
    - path: "packages/env/src/server.ts"
      provides: "APP_URL env var definition (replaces CORS_ORIGIN)"
      contains: "APP_URL: z.url()"
    - path: "packages/env/src/server.test.ts"
      provides: "Tests for APP_URL env var"
      contains: "APP_URL"
    - path: "apps/server/.env.example"
      provides: "APP_URL example value"
      contains: "APP_URL="
    - path: "apps/web/.env.example"
      provides: "APP_URL example value"
      contains: "APP_URL="
  key_links:
    - from: "packages/env/src/server.ts"
      to: "packages/core/src/auth/auth.service.ts"
      via: "env.APP_URL import"
      pattern: "env\\.APP_URL"
    - from: "packages/env/src/server.ts"
      to: "apps/server/src/app.ts"
      via: "env.APP_URL for CORS origin"
      pattern: "env\\.APP_URL"
---

<objective>
Rename CORS_ORIGIN env var to APP_URL across the entire codebase.

Purpose: CORS_ORIGIN already holds the app URL value everywhere. Renaming to APP_URL makes it semantically correct for its expanded use (CORS, token URLs, redirect URLs). This eliminates the need for a separate APP_URL env var in later plans.

Output: Every file referencing CORS_ORIGIN now uses APP_URL. All tests pass. .env.example files updated.
</objective>

<execution_context>
@/home/lima/.claude/get-shit-done/workflows/execute-plan.md
@/home/lima/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/TESTING.md
@.planning/codebase/CONVENTIONS.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rename CORS_ORIGIN to APP_URL in application code and env schema</name>
  <files>
    packages/env/src/server.ts
    packages/core/src/auth/auth.service.ts
    apps/server/src/app.ts
  </files>
  <action>
    Rename the env var CORS_ORIGIN to APP_URL in all application code files:

    1. `packages/env/src/server.ts`: Change `CORS_ORIGIN: z.url()` to `APP_URL: z.url()` in the server schema.

    2. `packages/core/src/auth/auth.service.ts`: Change `env.CORS_ORIGIN` to `env.APP_URL` in the trustedOrigins array.

    3. `apps/server/src/app.ts`: Change `env.CORS_ORIGIN` to `env.APP_URL` in the CORS origin config.

    This is a pure mechanical rename. No logic changes. The z.url() validator and all usage patterns stay identical.
  </action>
  <verify>
    Run `grep -r "CORS_ORIGIN" packages/ apps/server/src/app.ts` and confirm zero matches.
    Run `grep -r "APP_URL" packages/env/src/server.ts packages/core/src/auth/auth.service.ts apps/server/src/app.ts` and confirm all three files reference APP_URL.
  </verify>
  <done>CORS_ORIGIN is replaced by APP_URL in env schema, auth service, and server CORS config.</done>
</task>

<task type="auto">
  <name>Task 2: Update all tests, .env.example files, config files, and infra</name>
  <files>
    packages/env/src/server.test.ts
    packages/core/src/auth/auth.test.ts
    packages/core/src/auth/auth.int.test.ts
    apps/server/src/startup.int.test.ts
    apps/server/.env.example
    apps/web/.env.example
    playwright.config.ts
    infra/web.ts
    infra/api.ts
  </files>
  <action>
    Rename every remaining reference to CORS_ORIGIN across the codebase:

    1. `packages/env/src/server.test.ts`: Replace ALL occurrences of `CORS_ORIGIN` with `APP_URL` (env var name in tests, process.env assignments, expect assertions, delete statements). There are 6+ references â€” get every one. The guardrail test in this file will automatically detect the rename since it reads server.ts schema vars.

    2. `packages/core/src/auth/auth.test.ts`: Replace `CORS_ORIGIN: "http://localhost:3001"` with `APP_URL: "http://localhost:3001"` in mock env setup.

    3. `packages/core/src/auth/auth.int.test.ts`: Replace `CORS_ORIGIN: "http://localhost:3001"` with `APP_URL: "http://localhost:3001"` in test env setup.

    4. `apps/server/src/startup.int.test.ts`: Replace ALL `CORS_ORIGIN` references with `APP_URL` in env var test cases. Update the test name from "should fail when CORS_ORIGIN is missing" to "should fail when APP_URL is missing". Update the runServer calls that include CORS_ORIGIN in the env object.

    5. `apps/server/.env.example`: Change `CORS_ORIGIN=http://localhost:3001` to `APP_URL=http://localhost:3001`.

    6. `apps/web/.env.example`: Change `CORS_ORIGIN=http://localhost:3001` to `APP_URL=http://localhost:3001`.

    7. `playwright.config.ts`: Change `CORS_ORIGIN: process.env.CORS_ORIGIN || "http://localhost:3001"` to `APP_URL: process.env.APP_URL || "http://localhost:3001"`.

    8. `infra/web.ts`: Change `CORS_ORIGIN: $dev ? "http://localhost:3001" : \`https://${domain}\`` to `APP_URL: $dev ? "http://localhost:3001" : \`https://${domain}\``.

    9. `infra/api.ts`: Change `CORS_ORIGIN: $dev ? "http://localhost:3001" : \`https://${domain}\`` to `APP_URL: $dev ? "http://localhost:3001" : \`https://${domain}\``.

    After all renames, do a final codebase-wide search for any remaining CORS_ORIGIN references. The ONLY acceptable remaining references are in git history or node_modules. If any .ts, .js, .env, or config files still reference CORS_ORIGIN, fix them.

    ALSO update the local .env files if they exist (apps/server/.env, apps/web/.env, packages/core/.env) to use APP_URL instead of CORS_ORIGIN. These are gitignored but need to work for local dev.
  </action>
  <verify>
    Run `grep -rn "CORS_ORIGIN" --include="*.ts" --include="*.env*" --include="*.json" . | grep -v node_modules | grep -v .git` and confirm zero matches.
    Run `pnpm test` and confirm all tests pass.
  </verify>
  <done>Zero references to CORS_ORIGIN remain in the codebase (excluding node_modules and git history). All tests pass. .env.example files use APP_URL.</done>
</task>

</tasks>

<verification>
1. `grep -rn "CORS_ORIGIN" --include="*.ts" --include="*.env*" . | grep -v node_modules | grep -v .git` returns zero results
2. `grep -rn "APP_URL" packages/env/src/server.ts` shows the env var definition
3. `pnpm test` passes with zero failures
4. `pnpm dev` starts successfully (manual spot-check if needed)
</verification>

<success_criteria>
- Every CORS_ORIGIN reference in application code, tests, config, infra, and .env.example files is renamed to APP_URL
- The env schema validates APP_URL as z.url()
- All existing tests pass without modification beyond the rename
- The guardrail test in server.test.ts passes (detects APP_URL in schema)
</success_criteria>

<output>
After completion, create `.planning/phases/02-email-infrastructure/02-01-SUMMARY.md`
</output>
