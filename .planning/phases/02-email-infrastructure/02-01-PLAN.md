---
phase: 02-email-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - infra/email.ts
  - infra/secrets.ts
  - infra/web.ts
  - sst.config.ts
  - packages/env/src/server.ts
  - packages/env/src/server.test.ts
  - apps/web/.env.example
  - apps/server/.env.example
  - .env.example
autonomous: false
user_setup:
  - service: aws-ses
    why: "Email sending via SES"
    env_vars:
      - name: SUBSCRIBER_TOKEN_SECRET
        source: "Generate with: openssl rand -hex 32"
    dashboard_config:
      - task: "SST deploy to create SES domain identity and DNS records"
        location: "Run: npx sst deploy --stage dev"
      - task: "Request SES production access (optional, sandbox is fine for dev)"
        location: "AWS Console -> SES -> Account dashboard -> Request production access"

must_haves:
  truths:
    - "SST Email component provisions SES domain identity for gemhog.com"
    - "DKIM/SPF/DMARC DNS records are created via Cloudflare"
    - "Environment variables for email sending are validated at startup"
    - "New env vars have test coverage and .env.example entries"
  artifacts:
    - path: "infra/email.ts"
      provides: "SST Email component with Cloudflare DNS"
      contains: "sst.aws.Email"
    - path: "packages/env/src/server.ts"
      provides: "Email env var validation"
      contains: "SES_FROM_EMAIL"
  key_links:
    - from: "infra/email.ts"
      to: "infra/web.ts"
      via: "environment variable injection"
      pattern: "SES_FROM_EMAIL"
    - from: "infra/secrets.ts"
      to: "infra/web.ts"
      via: "secret value reference"
      pattern: "SubscriberTokenSecret"
---

<objective>
Set up SST Email infrastructure for SES domain verification and wire new environment variables for email sending throughout the stack.

Purpose: Without SES domain identity and DKIM/SPF/DMARC, emails will not be deliverable. Without env vars, the email service cannot be configured. This is the infrastructure foundation for all email functionality.

Output: `infra/email.ts` with SST Email component, updated secrets, env var validation with tests, and .env.example entries.
</objective>

<execution_context>
@/home/lima/.claude/get-shit-done/workflows/execute-plan.md
@/home/lima/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-email-infrastructure/02-CONTEXT.md
@.planning/phases/02-email-infrastructure/02-RESEARCH.md
@.planning/codebase/ARCHITECTURE.md
@.planning/codebase/CONVENTIONS.md
@.planning/codebase/TESTING.md
@.planning/codebase/STACK.md

Reference files for existing patterns:
@infra/secrets.ts
@infra/web.ts
@infra/router.ts
@sst.config.ts
@packages/env/src/server.ts
@apps/web/.env.example
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SST Email infrastructure and update secrets</name>
  <files>
    infra/email.ts
    infra/secrets.ts
    infra/web.ts
    sst.config.ts
  </files>
  <action>
    1. Create `infra/email.ts`:
       - Use `sst.aws.Email` component with sender `"gemhog.com"`
       - Use `sst.cloudflare.dns()` with `secrets.CloudflareZoneId.value` for DNS (same pattern as `infra/router.ts`)
       - Add DMARC policy: `"v=DMARC1; p=quarantine; adkim=s; aspf=s;"`
       - Export the email component and its properties

    2. Update `infra/secrets.ts`:
       - Add `SubscriberTokenSecret: new sst.Secret("SubscriberTokenSecret")` for HMAC token signing

    3. Update `infra/web.ts`:
       - Add these environment variables to the `environment` block:
         - `SES_FROM_EMAIL`: Use template literal `hello@gemhog.com` (the sender address from CONTEXT.md)
         - `SUBSCRIBER_TOKEN_SECRET`: `secrets.SubscriberTokenSecret.value`
         - `APP_URL`: `$dev ? "http://localhost:3001" : \`https://${domain}\``
       - Import `email` from `./email` to ensure the email infrastructure is provisioned
       - NOTE: SES_FROM_EMAIL is a static string derived from the domain, NOT a secret. It does not need an SST secret.

    4. Update `sst.config.ts`:
       - Add `await import("./infra/email");` in the `run()` function, BEFORE the api and web imports (email must be provisioned before web references it)

    IMPORTANT: Do NOT import SST SDK in application code. The infra files are SST-only. Application code reads env vars.
  </action>
  <verify>
    - `infra/email.ts` exists and uses `sst.aws.Email`
    - `infra/secrets.ts` includes `SubscriberTokenSecret`
    - `infra/web.ts` includes `SES_FROM_EMAIL`, `SUBSCRIBER_TOKEN_SECRET`, and `APP_URL`
    - `sst.config.ts` imports `./infra/email`
    - No SST SDK imports in `packages/` or `apps/` code
  </verify>
  <done>SST Email infrastructure file exists with domain verification config. Secrets and web environment updated with email-related variables.</done>
</task>

<task type="auto">
  <name>Task 2: Add env var validation, tests, and .env.example entries</name>
  <files>
    packages/env/src/server.ts
    packages/env/src/server.test.ts
    apps/web/.env.example
    apps/server/.env.example
    .env.example
  </files>
  <action>
    1. Update `packages/env/src/server.ts`:
       - Add `SES_FROM_EMAIL: z.string().email().optional()` (optional because local dev uses console logging, not SES)
       - Add `SUBSCRIBER_TOKEN_SECRET: z.string().min(32).optional()` (optional for local dev; required in production but enforced at service level)
       - Add `APP_URL: z.url().optional()` (optional for local dev, defaults in application code)
       - Keep all existing env vars unchanged

    2. Update `packages/env/src/server.test.ts` (TDD approach):
       - Add test cases for the new env vars following existing test patterns
       - Test that `SES_FROM_EMAIL` accepts valid email format
       - Test that `SUBSCRIBER_TOKEN_SECRET` requires min 32 chars when provided
       - Test that `APP_URL` accepts valid URL when provided
       - Follow the existing test file structure exactly

    3. Update `.env.example` files:
       - `apps/web/.env.example`: Add `SES_FROM_EMAIL=hello@gemhog.com`, `SUBSCRIBER_TOKEN_SECRET=replace-with-at-least-32-char-secret-key-here`, `APP_URL=http://localhost:3001`
       - `apps/server/.env.example`: Add same entries if server env validation uses them (check if server app needs these)
       - Root `.env.example`: No changes needed (root only has Cloudflare + DATABASE_URL)

    IMPORTANT: New env vars must be optional (`.optional()`) to avoid breaking existing `pnpm dev` and test workflows. The email service will enforce their presence at runtime when email sending is attempted.
  </action>
  <verify>
    - `pnpm check` passes (types + lint)
    - Run env var tests: `pnpm vitest run --project env`
    - All new env vars have corresponding test coverage
    - `.env.example` files include new entries
  </verify>
  <done>Environment validation schema includes email-related env vars with proper types. Tests cover new vars. .env.example files updated for developer onboarding.</done>
</task>

<task type="checkpoint:human-verify" gate="soft">
  <what-built>SST Email infrastructure config and environment variable wiring. The infra/email.ts file is ready but has NOT been deployed yet.</what-built>
  <how-to-verify>
    1. Review `infra/email.ts` - should use `sst.aws.Email` with `gemhog.com` sender and Cloudflare DNS
    2. Review `infra/web.ts` - should include SES_FROM_EMAIL, SUBSCRIBER_TOKEN_SECRET, APP_URL
    3. Run `pnpm test` to confirm all tests pass including new env var tests
    4. NOTE: Actual SES deployment happens when you run `npx sst deploy --stage dev`. This is optional for now - Plans 02 and 03 use mocks/console logging and do not require live SES.
  </how-to-verify>
  <resume-signal>Type "approved" to continue, or describe any issues. Deployment to AWS can be done later.</resume-signal>
</task>

</tasks>

<verification>
- `pnpm check` passes (lint + types)
- `pnpm vitest run --project env` passes (env var tests)
- `pnpm test` passes (full pipeline)
- `infra/email.ts` exists and exports SST Email component
- No SST SDK imports in packages/ or apps/ directories
</verification>

<success_criteria>
- SST Email infrastructure is defined in `infra/email.ts`
- DKIM/DMARC config specified for deliverability
- SubscriberTokenSecret added to SST secrets
- SES_FROM_EMAIL, SUBSCRIBER_TOKEN_SECRET, APP_URL added to env validation
- All new env vars have test coverage
- .env.example files updated
- `pnpm test` passes
</success_criteria>

<output>
After completion, create `.planning/phases/02-email-infrastructure/02-01-SUMMARY.md`
</output>
