---
phase: 02-email-infrastructure
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/core/src/email/email.service.ts
  - packages/core/src/email/email.errors.ts
  - packages/core/src/email/email.templates.ts
  - packages/core/src/email/email.mock.ts
  - packages/core/src/email/email.test.ts
  - packages/core/src/email/index.ts
  - packages/core/package.json
autonomous: true

must_haves:
  truths:
    - "Email service can send HTML emails with subject and custom headers"
    - "Verification email template includes confirm button with URL"
    - "Email templates include List-Unsubscribe and List-Unsubscribe-Post headers"
    - "Dev mode logs email content to console instead of sending via SES"
    - "Email service is testable via Effect mock layer"
  artifacts:
    - path: "packages/core/src/email/email.service.ts"
      provides: "Effect service wrapping AWS SES v2 for email sending"
      exports: ["EmailService", "EmailServiceTag", "EmailServiceLive", "EmailServiceDev"]
    - path: "packages/core/src/email/email.templates.ts"
      provides: "Email template builders for verification and unsubscribe"
      exports: ["verificationEmail", "unsubscribeHeaders"]
    - path: "packages/core/src/email/email.errors.ts"
      provides: "Tagged errors for email domain"
      contains: "EmailSendError"
  key_links:
    - from: "packages/core/src/email/email.service.ts"
      to: "@aws-sdk/client-sesv2"
      via: "SendEmailCommand"
      pattern: "SESv2Client"
    - from: "packages/core/src/email/email.templates.ts"
      to: "verification flow"
      via: "HTML email content with confirm button"
      pattern: "verificationEmail"
---

<objective>
Build the email sending domain in packages/core: Effect service wrapping AWS SES v2, email templates for verification, and List-Unsubscribe header support.

Purpose: This provides the email sending capability used by the subscriber flow. The Effect service pattern enables dependency injection -- production uses SES, dev uses console logging, tests use mocks. Templates ensure consistent, on-brand email content.

Output: Complete `packages/core/src/email/` domain with SES service, dev console logger, templates, errors, mock, and tests.
</objective>

<execution_context>
@/home/lima/.claude/get-shit-done/workflows/execute-plan.md
@/home/lima/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-email-infrastructure/02-CONTEXT.md
@.planning/phases/02-email-infrastructure/02-RESEARCH.md
@.planning/codebase/ARCHITECTURE.md
@.planning/codebase/CONVENTIONS.md
@.planning/codebase/TESTING.md

Reference files for existing domain pattern:
@packages/core/src/auth/auth.errors.ts
@packages/core/src/auth/index.ts
@packages/core/package.json
@packages/core/src/drizzle/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create email errors, templates, and template tests</name>
  <files>
    packages/core/src/email/email.errors.ts
    packages/core/src/email/email.templates.ts
    packages/core/src/email/email.test.ts
  </files>
  <action>
    TDD: Write template tests first, then implement.

    1. Create `packages/core/src/email/email.errors.ts`:
       - `EmailSendError extends Data.TaggedError("EmailSendError")<{ message: string; cause?: unknown }>`
       - `EmailConfigError extends Data.TaggedError("EmailConfigError")<{ message: string }>`
       - Follow exact pattern from `packages/core/src/auth/auth.errors.ts`

    2. Write template tests FIRST in `packages/core/src/email/email.test.ts`:
       - Test `verificationEmail`:
         - Returns object with `subject` and `html` fields
         - Subject contains "Gemhog"
         - HTML contains the verify URL passed as parameter
         - HTML contains a styled confirm button/link
         - HTML contains expiry notice
       - Test `unsubscribeHeaders`:
         - Returns object with `List-Unsubscribe` header containing the URL
         - Returns `List-Unsubscribe-Post` header with value `"List-Unsubscribe=One-Click"`
         - Both headers are present (RFC 8058 compliance)
       - Run tests -- they MUST FAIL (red)

    3. Create `packages/core/src/email/email.templates.ts`:
       - `verificationEmail(params: { verifyUrl: string }): { subject: string; html: string }`
         - Subject: "Confirm your Gemhog subscription"
         - HTML: Warm welcome message + styled confirm button + expiry notice + safe-to-ignore note
         - Sender personality: "Gemhog" brand, warm but brief (per CONTEXT.md)
         - Simple inline CSS (no external stylesheet), max-width 600px container
         - CAN-SPAM footer placeholder: `<!-- CAN-SPAM address placeholder -->` comment
       - `unsubscribeHeaders(params: { unsubscribeUrl: string }): Record<string, string>`
         - Returns `{ "List-Unsubscribe": "<{unsubscribeUrl}>", "List-Unsubscribe-Post": "List-Unsubscribe=One-Click" }`
         - The angle brackets around the URL are required by RFC 2369
       - Run tests -- they MUST PASS (green)

    IMPORTANT: Templates are pure functions with no side effects. They take data, return strings. No async, no dependencies.
  </action>
  <verify>
    - Template tests pass: `pnpm vitest run packages/core/src/email/email.test.ts`
    - Tests were written BEFORE implementation (TDD red-green)
    - `pnpm check` passes
  </verify>
  <done>Email templates produce correct HTML and headers. Verification email is on-brand with confirm button. List-Unsubscribe headers comply with RFC 8058.</done>
</task>

<task type="auto">
  <name>Task 2: Create email Effect service with SES, dev console, and mock layers</name>
  <files>
    packages/core/src/email/email.service.ts
    packages/core/src/email/email.mock.ts
    packages/core/src/email/email.test.ts
    packages/core/src/email/index.ts
    packages/core/package.json
  </files>
  <action>
    1. Create `packages/core/src/email/email.service.ts`:
       - Define `EmailService` interface:
         ```
         send(params: {
           to: string;
           subject: string;
           html: string;
           headers?: Record<string, string>;
         }): Effect<void, EmailSendError>
         ```
       - Define `EmailServiceTag` using `Context.Tag("EmailService")`

       - Create `EmailServiceLive` layer (production SES):
         - Instantiate `SESv2Client` with region from `process.env.AWS_REGION ?? "eu-central-1"`
         - Read sender from `process.env.SES_FROM_EMAIL ?? "hello@gemhog.com"`
         - `send` method: Use `SendEmailCommand` with `Simple` content type
         - Include custom headers if provided (for List-Unsubscribe)
         - Wrap in `Effect.tryPromise` with `EmailSendError`
         - See RESEARCH.md Pattern 1 for exact implementation reference
         - NOTE: Read env vars directly with `process.env` (SST-agnostic pattern). Do NOT import from `@gemhog/env/server` inside the service -- it creates circular dependency issues. The env package validates at startup; the service reads raw env vars.

       - Create `EmailServiceDev` layer (local development):
         - `send` method: Log email details to console (to, subject, html snippet, headers)
         - Format nicely for developer readability: show subject, recipient, and a truncated HTML preview
         - Use `Effect.sync` (no async needed for console.log)
         - This is used when `NODE_ENV=development` or when SES is not configured

    2. Create `packages/core/src/email/email.mock.ts`:
       - `EmailServiceTest` layer for unit tests
       - Records sent emails in an array for assertion
       - Export `getSentEmails(): Array<{to, subject, html, headers}>` helper for tests
       - Use `Layer.succeed(EmailServiceTag, {...})`

    3. Add service tests to `packages/core/src/email/email.test.ts`:
       - Test mock layer: send records email, getSentEmails returns it
       - Test dev layer: send completes without error (console.log side effect)
       - Do NOT test SES live layer in unit tests (that requires real AWS credentials)

    4. Create `packages/core/src/email/index.ts`:
       - Export all from `email.errors.ts`
       - Export service: `EmailService`, `EmailServiceTag`, `EmailServiceLive`, `EmailServiceDev`
       - Export templates: `verificationEmail`, `unsubscribeHeaders`
       - Export mock: `EmailServiceTest`, `getSentEmails`

    5. Update `packages/core/package.json` exports:
       - Add `"./email": { "default": "./src/email/index.ts" }`

    6. Install `@aws-sdk/client-sesv2` dependency:
       - Run `pnpm add @aws-sdk/client-sesv2 --filter @gemhog/core`

    IMPORTANT: The SES client is only instantiated in the Live layer. Dev and Mock layers never touch AWS. Tests always use Mock or Dev layer.
  </action>
  <verify>
    - `pnpm check` passes (types + lint)
    - Email service tests pass: `pnpm vitest run packages/core/src/email/email.test.ts`
    - `pnpm test` passes (full pipeline)
    - `@aws-sdk/client-sesv2` is in packages/core/package.json dependencies
    - Package export resolves: `@gemhog/core/email`
  </verify>
  <done>EmailService Effect layer wraps SES v2 for production, logs to console for dev, and provides mock layer for tests. All three layers satisfy the same interface. Templates and headers are accessible via clean exports.</done>
</task>

</tasks>

<verification>
- `pnpm check` passes
- All email domain tests pass (templates + service layers)
- TDD evidence: template tests written before implementation
- `@aws-sdk/client-sesv2` installed
- Package export `@gemhog/core/email` resolves correctly
- `pnpm test` passes (full pipeline)
</verification>

<success_criteria>
- EmailService interface defined with send method accepting to/subject/html/headers
- EmailServiceLive wraps SES v2 SendEmailCommand
- EmailServiceDev logs to console for local development
- EmailServiceTest mock records sent emails for assertions
- Verification email template is on-brand with confirm button
- List-Unsubscribe + List-Unsubscribe-Post headers generated per RFC 8058
- Full test coverage for templates and service layers
- `pnpm test` passes
</success_criteria>

<output>
After completion, create `.planning/phases/02-email-infrastructure/02-03-SUMMARY.md`
</output>
