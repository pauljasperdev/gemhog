---
phase: 02-email-infrastructure
plan: 06
type: execute
wave: 6
depends_on: ["02-05"]
files_modified:
  - packages/core/src/email/token.ts
  - packages/core/src/email/subscriber.service.ts
  - packages/core/src/email/email.service.ts
  - packages/core/src/email/email.mock.ts
  - packages/core/src/email/index.ts
  - packages/core/src/email/email.service.test.ts
  - packages/core/src/email/subscriber.int.test.ts
  - packages/core/src/email/test-fixtures.ts
  - packages/env/src/server.ts
  - packages/env/src/server.test.ts
  - pnpm-workspace.yaml
  - .planning/codebase/CONVENTIONS.md
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "token.ts uses Effect.gen with Effect.fail instead of throw/catch inside Effect.try"
    - "subscriber.service.ts uses mapError instead of catchAll so SubscriberNotFoundError propagates correctly"
    - "subscriber.service.ts has flat control flow without nested if statements"
    - "email.service.ts EmailServiceConsole uses Effect Console.log instead of console.log"
    - "email.service.ts EmailServiceLive uses a factory function accepting senderEmail parameter"
    - "email.service.ts does not use process.env for region (hardcoded eu-central-1)"
    - "EmailServiceAuto is removed from core package (moved to app layer)"
    - "SUBSCRIBER_TOKEN_SECRET is removed from env schema"
    - "effect is in the pnpm catalog"
    - "Test files remain co-located (tests/ subfolder deferred per documented decision)"
    - "All tests pass with pnpm db:start && pnpm test"
  artifacts:
    - path: "packages/core/src/email/token.ts"
      provides: "Token create/verify using Effect patterns"
      contains: "Effect.gen"
    - path: "packages/core/src/email/subscriber.service.ts"
      provides: "Subscriber CRUD with proper error propagation"
      contains: "mapError"
    - path: "packages/core/src/email/email.service.ts"
      provides: "Email service with factory pattern"
      exports: ["EmailServiceTag", "EmailServiceConsole", "makeEmailServiceLive"]
    - path: "packages/env/src/server.ts"
      provides: "Env schema without SUBSCRIBER_TOKEN_SECRET"
    - path: "pnpm-workspace.yaml"
      provides: "pnpm catalog with effect entry"
      contains: "effect"
  key_links:
    - from: "packages/core/src/email/subscriber.service.ts"
      to: "subscriber.int.test.ts"
      via: "mapError preserves SubscriberNotFoundError"
      pattern: "mapError"
    - from: "packages/core/src/email/email.service.ts"
      to: "packages/core/src/email/index.ts"
      via: "barrel exports makeEmailServiceLive instead of EmailServiceAuto"
      pattern: "makeEmailServiceLive"
---

<objective>
Fix core package Effect-TS patterns and remove SUBSCRIBER_TOKEN_SECRET from env schema.

Purpose: Address code review items covering non-idiomatic Effect code (throw/catch inside Effect.try, catchAll swallowing typed errors, console.log instead of Effect Console, process.env in service layer), env cleanup, pnpm catalog, conventions update, and explicit deferral of schema/test-organization improvements.

**Code review item mapping:**
- Items 10, 11, 14, 15, 16, 17, 20, 21, 22 -- Task 1 (Effect-TS refactoring)
- Items 1, 23 -- Task 1 (root cause: catchAll -> mapError fixes test failures)
- Items 2, 6, 9 -- Task 2 (SUBSCRIBER_TOKEN_SECRET removal makes token a hash of BETTER_AUTH_SECRET)
- Items 3, 12, 13 -- Task 2 (catalog, hardcoded region, conventions update)
- Items 18, 19 -- Task 2 (explicitly documented as deferred decisions)

Output: Refactored token.ts, subscriber.service.ts, email.service.ts, updated env schema, updated tests, pnpm catalog with effect, documented deferrals for items 18 and 19.
</objective>

<execution_context>
@/home/lima/.claude/get-shit-done/workflows/execute-plan.md
@/home/lima/.claude/get-shit-done/templates/summary.md
</execution_context>

<skills>
Use `/effect-ts` skill before writing ANY Effect code. It has the correct, up-to-date APIs
for Effect.gen, Layer, Context.Tag, Effect.fail, Console.log, Effect.mapError, etc.
This is critical -- do NOT guess Effect APIs from memory. Invoke the skill first.
</skills>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/CONVENTIONS.md

@packages/core/src/email/token.ts
@packages/core/src/email/subscriber.service.ts
@packages/core/src/email/email.service.ts
@packages/core/src/email/email.errors.ts
@packages/core/src/email/email.mock.ts
@packages/core/src/email/index.ts
@packages/core/src/email/test-fixtures.ts
@packages/core/src/email/token.test.ts
@packages/core/src/email/email.service.test.ts
@packages/core/src/email/subscriber.test.ts
@packages/core/src/email/subscriber.int.test.ts
@packages/env/src/server.ts
@packages/env/src/server.test.ts
@pnpm-workspace.yaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor core email services to idiomatic Effect-TS</name>
  <files>
    packages/core/src/email/token.ts
    packages/core/src/email/subscriber.service.ts
    packages/core/src/email/email.service.ts
    packages/core/src/email/email.mock.ts
    packages/core/src/email/index.ts
    packages/core/src/email/email.service.test.ts
    packages/core/src/email/subscriber.int.test.ts
  </files>
  <action>
**Code review items addressed: 1, 10, 11, 14, 15, 16, 17, 20, 21, 22, 23**

**token.ts (items 20, 21, 22)** -- Replace the Effect.try with throw/catch pattern with Effect.gen using Effect.fail for each error case:

1. Keep `createToken` as-is (it uses Effect.sync correctly).
2. Rewrite `verifyToken` using `Effect.gen`:
   - Decode the base64url token. If lastDot === -1, `yield* Effect.fail(new InvalidTokenError({ reason: "malformed" }))`.
   - Compute expected HMAC. If signature length mismatch or timingSafeEqual fails, `yield* Effect.fail(new InvalidTokenError({ reason: "invalid_signature" }))`.
   - Parse JSON. If Date.now() > payload.expiresAt, `yield* Effect.fail(new InvalidTokenError({ reason: "expired" }))`.
   - Wrap the JSON.parse in a local try/catch and yield Effect.fail for parse failure (malformed). Or use `Effect.try` for just the JSON.parse line.
   - The key change: each distinct failure mode uses `Effect.fail` directly, not throwing Error strings and catching them all in a single catch block.
   - Item 22: The existing InvalidTokenError is already an Effect tagged error (`Data.TaggedError`). The rewrite ensures all error paths yield proper Effect errors, not thrown exceptions.

**subscriber.service.ts (items 1, 14, 15, 16, 17, 23)** -- Fix three issues:

1. **ROOT CAUSE FIX (items 1, 23): Replace `catchAll` with `mapError` on DB queries.** This is the critical bug causing all 10 integration test failures. The current `findByEmailQuery` uses `Effect.catchAll` which intercepts ALL errors in the downstream pipeline. `Effect.catchAll` recovers from errors and produces a new Effect -- meaning that when the DB query succeeds (returning null for a non-existent subscriber), subsequent operations that fail with `SubscriberNotFoundError` get caught by `catchAll` if they're piped after it. The fix is `Effect.mapError` which only transforms the error type without intercepting the success path. Apply the same fix to ALL db operation pipes in subscribe(), verify(), and unsubscribe() methods -- every `.pipe(Effect.catchAll(...))` after a db operation becomes `.pipe(Effect.mapError(...))`:

   ```typescript
   // BEFORE (broken -- catchAll intercepts downstream SubscriberNotFoundError):
   db.select().from(subscriber).where(eq(subscriber.email, email)).pipe(
     Effect.map((rows: Subscriber[]) => rows[0] ?? null),
     Effect.catchAll((error) =>
       Effect.fail(new SubscriberError({ message: `Failed to find subscriber: ${email}`, cause: error }))
     ),
   );

   // AFTER (correct -- mapError only transforms the error type, does not intercept):
   db.select().from(subscriber).where(eq(subscriber.email, email)).pipe(
     Effect.map((rows: Subscriber[]) => rows[0] ?? null),
     Effect.mapError((error) =>
       new SubscriberError({ message: `Failed to find subscriber: ${email}`, cause: error })
     ),
   );
   ```

2. **Flatten nested if statements in `subscribe` (item 14).** Current code has nested `if (existing) { if (existing.status === "unsubscribed") { ... } }`. Refactor to flat early-return guard clauses:
   - If existing AND status === "unsubscribed": update and return `{ id, isNew: true }`
   - If existing (any other status): return `{ id, isNew: false }`
   - Otherwise: insert and return

3. **Happy-path coding for verify and unsubscribe (items 15, 16, 17).** Extract a `requireByEmail` helper that calls findByEmailQuery and fails with SubscriberNotFoundError if null. Then verify/unsubscribe become flat pipes:
   ```typescript
   const requireByEmail = (email: string) =>
     findByEmailQuery(email).pipe(
       Effect.flatMap((sub) =>
         sub ? Effect.succeed(sub) : Effect.fail(new SubscriberNotFoundError({ email }))
       ),
     );

   // verify becomes:
   verify: (email) =>
     requireByEmail(email).pipe(
       Effect.flatMap(() =>
         db.update(subscriber).set({ status: "active", verifiedAt: new Date() })
           .where(eq(subscriber.email, email))
       ),
       Effect.mapError((error) =>
         error._tag === "SubscriberNotFoundError" ? error :
         new SubscriberError({ message: `Failed to verify: ${email}`, cause: error })
       ),
       Effect.asVoid,
     ),
   ```
   The key is: no explicit null-check-then-fail pattern in the public methods. The `requireByEmail` helper encapsulates that. Errors propagate naturally -- no `catchAll` swallowing them.

**email.service.ts (items 10, 11, 12)** -- Fix three issues:

1. **EmailServiceConsole (items 10, 11)**: Replace `console.log` with `Console.log` from effect. Import `Console` from "effect". The send function should use Effect.gen with yield* Console.log calls:
   ```typescript
   import { Console, Context, Effect, Layer } from "effect";

   // In EmailServiceConsole:
   send: (params) =>
     Effect.gen(function* () {
       const preview = params.html.length > 200
         ? `${params.html.slice(0, 200)}...`
         : params.html;
       yield* Console.log(`[EMAIL] To: ${params.to} | Subject: ${params.subject}`);
       yield* Console.log(`[EMAIL] HTML: ${preview}`);
       if (params.headers) {
         yield* Console.log(`[EMAIL] Headers: ${JSON.stringify(params.headers)}`);
       }
     }),
   ```

2. **EmailServiceLive (item 12)**: Convert to a factory function `makeEmailServiceLive(senderEmail: string)`. Hardcode region to `"eu-central-1"` (not from process.env). Remove the `process.env.SES_FROM_EMAIL` and `process.env.AWS_REGION` reads. The factory returns a Layer:
   ```typescript
   export const makeEmailServiceLive = (senderEmail: string) =>
     Layer.sync(EmailServiceTag, () => {
       const client = new SESv2Client({ region: "eu-central-1" });
       return {
         send: ({ to, subject, html, headers }) =>
           Effect.tryPromise({ ... using senderEmail param ... }),
       };
     });
   ```

3. **Remove `EmailServiceAuto`** entirely. The auto-selection logic moves to the app layer (email-layers.ts in plan 02-07).

**email.mock.ts**: No changes needed -- already correct.

**index.ts (barrel exports)**: Update exports:
- Remove `EmailServiceAuto` and `EmailServiceLive` from named exports.
- Add `makeEmailServiceLive` to exports.
- Keep `EmailServiceConsole` and `EmailServiceTag`.

**email.service.test.ts**: Update tests to work with Console.log instead of console.log. Effect's Console.log delegates to `console.log` in the standard runtime, so existing spy-based tests may still work. Verify and adjust if needed. Run tests to confirm.

**subscriber.int.test.ts (items 1, 23)**: The tests themselves are correct but had failures due to the catchAll bug. After fixing mapError in subscriber.service.ts, ALL 10 integration tests should pass because SubscriberNotFoundError now propagates correctly instead of being swallowed by catchAll. No test code changes needed for this -- just verify they pass.
  </action>
  <verify>
Run `pnpm test --filter @gemhog/core` and verify:
- All token.test.ts tests pass
- All subscriber.test.ts tests pass
- All email.service.test.ts tests pass
- All email.templates.test.ts tests pass

Run `pnpm db:start` then verify subscriber.int.test.ts: all 10 integration tests pass (especially the verify/unsubscribe SubscriberNotFoundError tests that were failing).

Run `pnpm check` to verify formatting/linting passes.

Grep verification:
- `grep -r "catchAll" packages/core/src/email/subscriber.service.ts` -- zero results
- `grep -r "console\.log" packages/core/src/email/email.service.ts` -- zero results (only Console.log)
- `grep -r "EmailServiceAuto" packages/core/src/email/` -- zero results
- `grep -r "process\.env" packages/core/src/email/email.service.ts` -- zero results
  </verify>
  <done>
- token.ts uses Effect.gen with Effect.fail for each error case (no throw/catch inside Effect.try) [items 21, 22]
- subscriber.service.ts uses mapError (not catchAll), has a requireByEmail helper, flat control flow [items 1, 14, 15, 16, 17, 23]
- email.service.ts EmailServiceConsole uses Console.log from effect [items 10, 11]
- email.service.ts exports makeEmailServiceLive factory (not EmailServiceLive with process.env) [item 12]
- EmailServiceAuto removed from core package
- All 10 subscriber integration tests pass (root cause fixed)
- All core email unit tests pass
  </done>
</task>

<task type="auto">
  <name>Task 2: Remove SUBSCRIBER_TOKEN_SECRET, update catalog, conventions, and document deferred items 18 and 19</name>
  <files>
    packages/env/src/server.ts
    packages/env/src/server.test.ts
    pnpm-workspace.yaml
    .planning/codebase/CONVENTIONS.md
  </files>
  <action>
**Code review items addressed: 2, 3, 6, 9, 12 (env side), 13, 18, 19**

**packages/env/src/server.ts (items 2, 6, 9)**: Remove the `SUBSCRIBER_TOKEN_SECRET` line from the env schema entirely. Token signing now uses BETTER_AUTH_SECRET which is already required. This addresses:
- Item 2: The suggestion was to use a hash of the email instead of a static token secret. The approach taken is better: use BETTER_AUTH_SECRET (already exists, already secured) to HMAC-sign tokens that contain the email. No new env var needed.
- Item 6: "no need for dev secret when we make this a hash" -- addressed by using BETTER_AUTH_SECRET.
- Item 9: "can be removed with hash" -- SubscriberTokenSecret removed from SST infra (done in plan 02-07).

**packages/env/src/server.test.ts**: Remove the entire `describe("optional SUBSCRIBER_TOKEN_SECRET", ...)` block. Also remove any `SUBSCRIBER_TOKEN_SECRET` references in other test blocks. The guardrail test should still pass since the var is removed from both schema and tests.

**pnpm-workspace.yaml (item 3)**: Add `effect` to the catalog section. Check the version used in packages/core/package.json (currently `"effect": "^3.19"` or similar) and add `effect: ^3.19` to the catalog. This allows other packages to use `"effect": "catalog:"` instead of hardcoding versions. Do NOT update packages/core/package.json in this plan -- just add the catalog entry. Plan 02-07 will update package.json files to use `"effect": "catalog:"`.

**CONVENTIONS.md (item 13)**: Add a subsection under "Effect-TS Patterns" for observability:

```markdown
### Observability with Effect

**Sentry tracing:** Use Effect's built-in tracing (`Effect.withSpan`) which
integrates with OpenTelemetry. Sentry's Node SDK auto-instruments via
OpenTelemetry, so `Effect.withSpan` annotations become Sentry spans
automatically. Do NOT manually call `Sentry.startSpan` inside Effect code.

\`\`\`typescript
// GOOD: Effect.withSpan integrates with Sentry via OpenTelemetry
myEffect.pipe(Effect.withSpan("subscriber.subscribe"))

// BAD: Manual Sentry calls inside Effect code
Effect.gen(function* () {
  return Sentry.startSpan({ name: "subscribe" }, () => { ... })
})
\`\`\`

**Logging:** Use `Console.log` from Effect (not `console.log`) in Effect
pipelines. This enables consistent logging behavior and testability.

\`\`\`typescript
import { Console, Effect } from "effect";

// GOOD: Effect Console
yield* Console.log("Processing subscriber");

// BAD: Direct console in Effect pipeline
console.log("Processing subscriber");
\`\`\`
```

**CONVENTIONS.md (item 18 -- deferred decision)**: Add a note under a new "Deferred Improvements" section at the end of CONVENTIONS.md:

```markdown
## Deferred Improvements

Items identified during code review that are deferred to future phases:

### Database ID Strategy (Code Review Item 18)

**Current:** UUIDs as primary keys (`text("id").$defaultFn(() => crypto.randomUUID())`).
**Proposed:** `bigserial` primary key with `nanoid` public_id column for fast lookups and no internal ID exposure.
**Why deferred:** Requires migration of existing data, schema changes across all tables, and updates to all code referencing `id` fields. Better done as a dedicated schema migration phase when there are more tables and the pattern is established project-wide.
**When to implement:** Before public beta launch, as part of a dedicated database schema hardening phase.
```

**CONVENTIONS.md (item 19 -- deferred decision)**: Add under "Deferred Improvements":

```markdown
### Test File Organization (Code Review Item 19)

**Current:** Test files co-located with implementation (`email.service.ts` + `email.service.test.ts` in same directory).
**Proposed:** Move test files into a `tests/` subfolder per domain (e.g., `packages/core/src/email/tests/email.service.test.ts`).
**Why deferred:** The current co-location pattern is already documented in TESTING.md and used project-wide. Changing now would require updating vitest configs, glob patterns in `vitest.config.ts` and `vitest.integration.config.ts`, and all import paths in test files. The benefit is organizational clarity, but the cost is significant churn across all domains.
**When to implement:** When a domain grows beyond ~8 files and the flat structure becomes hard to navigate. Can be done incrementally per domain.
```
  </action>
  <verify>
Run `pnpm test --filter @gemhog/env` and verify all env tests pass (the guardrail test confirms every schema var has a test, so removing SUBSCRIBER_TOKEN_SECRET from both schema and tests should keep it green).

Run `pnpm check` for formatting.

Verify:
- `grep "SUBSCRIBER_TOKEN_SECRET" packages/env/src/server.ts` -- zero results
- `grep "SUBSCRIBER_TOKEN_SECRET" packages/env/src/server.test.ts` -- zero results
- `grep "effect:" pnpm-workspace.yaml` -- finds the catalog entry
- `grep "withSpan" .planning/codebase/CONVENTIONS.md` -- finds the observability section
- `grep "Deferred Improvements" .planning/codebase/CONVENTIONS.md` -- finds the section
- `grep "bigserial" .planning/codebase/CONVENTIONS.md` -- finds item 18 deferral
- `grep "Test File Organization" .planning/codebase/CONVENTIONS.md` -- finds item 19 deferral
  </verify>
  <done>
- SUBSCRIBER_TOKEN_SECRET removed from env schema and tests [items 2, 6, 9]
- pnpm-workspace.yaml catalog includes effect [item 3]
- CONVENTIONS.md has Sentry tracing + Effect logging guidance [items 12 (env side), 13]
- Item 18 (bigserial + nanoid public_id) explicitly documented as deferred improvement with rationale
- Item 19 (test file organization into tests/ subfolder) explicitly documented as deferred improvement with rationale
- All env tests pass
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. `pnpm db:start && pnpm test` -- ALL tests pass (unit, integration, e2e)
2. `pnpm check` -- no formatting or lint errors
3. Verify no `console.log` in EmailServiceConsole (grep packages/core/src/email/email.service.ts)
4. Verify no `catchAll` in subscriber.service.ts (grep packages/core/src/email/subscriber.service.ts)
5. Verify no `EmailServiceAuto` in core barrel exports (grep packages/core/src/email/)
6. Verify no `SUBSCRIBER_TOKEN_SECRET` in env schema (grep packages/env/src/server.ts)
7. Verify no `process.env` in email.service.ts (grep packages/core/src/email/email.service.ts)
8. Verify `effect` appears in pnpm-workspace.yaml catalog
9. Verify CONVENTIONS.md has observability section and deferred improvements for items 18 and 19
10. Verify all 10 subscriber.int.test.ts tests pass (the root cause fix)
</verification>

<success_criteria>
- Core email services follow idiomatic Effect-TS patterns from CONVENTIONS.md
- Error types propagate correctly (mapError, not catchAll -- root cause of test failures fixed)
- EmailServiceLive is a factory function accepting senderEmail
- SUBSCRIBER_TOKEN_SECRET fully removed from env layer
- pnpm catalog includes effect
- Items 18 and 19 explicitly documented as deferred improvements in CONVENTIONS.md
- All tests green (pnpm db:start && pnpm test)
</success_criteria>

<output>
After completion, create `.planning/phases/02-email-infrastructure/02-06-SUMMARY.md`
</output>
