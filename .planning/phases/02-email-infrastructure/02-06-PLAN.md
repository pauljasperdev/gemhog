---
phase: 02-email-infrastructure
plan: 06
type: execute
wave: 6
depends_on: ["02-05"]
files_modified:
  - packages/core/src/email/token.ts
  - packages/core/src/email/subscriber.service.ts
  - packages/core/src/email/email.service.ts
  - packages/core/src/email/email.mock.ts
  - packages/core/src/email/index.ts
  - packages/core/src/email/email.service.test.ts
  - packages/core/src/email/subscriber.int.test.ts
  - packages/env/src/server.ts
  - packages/env/src/server.test.ts
  - pnpm-workspace.yaml
  - .planning/codebase/CONVENTIONS.md
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "token.ts uses Effect.gen with Effect.fail instead of throw/catch inside Effect.try"
    - "subscriber.service.ts uses mapError instead of catchAll so SubscriberNotFoundError propagates correctly"
    - "subscriber.service.ts has flat control flow without nested if statements"
    - "email.service.ts EmailServiceConsole uses Effect Console.log instead of console.log"
    - "email.service.ts EmailServiceLive uses a factory function accepting senderEmail parameter"
    - "email.service.ts does not use process.env for region (hardcoded eu-central-1)"
    - "EmailServiceAuto is removed from core package (moved to app layer)"
    - "SUBSCRIBER_TOKEN_SECRET is removed from env schema"
    - "effect is in the pnpm catalog"
    - "All unit tests pass with pnpm test"
  artifacts:
    - path: "packages/core/src/email/token.ts"
      provides: "Token create/verify using Effect patterns"
      contains: "Effect.gen"
    - path: "packages/core/src/email/subscriber.service.ts"
      provides: "Subscriber CRUD with proper error propagation"
      contains: "mapError"
    - path: "packages/core/src/email/email.service.ts"
      provides: "Email service with factory pattern"
      exports: ["EmailServiceTag", "EmailServiceConsole", "makeEmailServiceLive"]
    - path: "packages/env/src/server.ts"
      provides: "Env schema without SUBSCRIBER_TOKEN_SECRET"
    - path: "pnpm-workspace.yaml"
      provides: "pnpm catalog with effect entry"
      contains: "effect"
  key_links:
    - from: "packages/core/src/email/subscriber.service.ts"
      to: "subscriber.int.test.ts"
      via: "mapError preserves SubscriberNotFoundError"
      pattern: "mapError"
    - from: "packages/core/src/email/email.service.ts"
      to: "packages/core/src/email/index.ts"
      via: "barrel exports makeEmailServiceLive instead of EmailServiceAuto"
      pattern: "makeEmailServiceLive"
---

<objective>
Fix core package Effect-TS patterns and remove SUBSCRIBER_TOKEN_SECRET from env schema.

Purpose: Address code review items 2, 3, 6, 9, 10, 11, 12, 13, 14, 15, 16, 17, 21, 22. The core email package has non-idiomatic Effect code (throw/catch inside Effect.try, catchAll swallowing typed errors, console.log instead of Effect Console, process.env in service layer). Token signing will use BETTER_AUTH_SECRET (already exists) instead of a separate SUBSCRIBER_TOKEN_SECRET.

Output: Refactored token.ts, subscriber.service.ts, email.service.ts, updated env schema, updated tests, pnpm catalog with effect.
</objective>

<execution_context>
@/home/lima/.claude/get-shit-done/workflows/execute-plan.md
@/home/lima/.claude/get-shit-done/templates/summary.md
</execution_context>

<skills>
Use `/effect-ts` skill before writing ANY Effect code. It has the correct, up-to-date APIs
for Effect.gen, Layer, Context.Tag, Effect.fail, Console.log, Effect.mapError, etc.
This is critical â€” do NOT guess Effect APIs from memory. Invoke the skill first.
</skills>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/CONVENTIONS.md

@packages/core/src/email/token.ts
@packages/core/src/email/subscriber.service.ts
@packages/core/src/email/email.service.ts
@packages/core/src/email/email.errors.ts
@packages/core/src/email/email.mock.ts
@packages/core/src/email/index.ts
@packages/core/src/email/token.test.ts
@packages/core/src/email/email.service.test.ts
@packages/core/src/email/subscriber.test.ts
@packages/core/src/email/subscriber.int.test.ts
@packages/env/src/server.ts
@packages/env/src/server.test.ts
@pnpm-workspace.yaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor core email services to idiomatic Effect-TS</name>
  <files>
    packages/core/src/email/token.ts
    packages/core/src/email/subscriber.service.ts
    packages/core/src/email/email.service.ts
    packages/core/src/email/email.mock.ts
    packages/core/src/email/index.ts
    packages/core/src/email/email.service.test.ts
    packages/core/src/email/subscriber.int.test.ts
  </files>
  <action>
**token.ts** -- Replace the Effect.try with throw/catch pattern with Effect.gen using Effect.fail for each error case:

1. Keep `createToken` as-is (it uses Effect.sync correctly).
2. Rewrite `verifyToken` using `Effect.gen`:
   - Decode the base64url token. If lastDot === -1, `yield* Effect.fail(new InvalidTokenError({ reason: "malformed" }))`.
   - Compute expected HMAC. If signature length mismatch or timingSafeEqual fails, `yield* Effect.fail(new InvalidTokenError({ reason: "invalid_signature" }))`.
   - Parse JSON. If Date.now() > payload.expiresAt, `yield* Effect.fail(new InvalidTokenError({ reason: "expired" }))`.
   - Wrap the entire outer decode/parse in a try/catch only for truly unexpected errors (JSON.parse failure, Buffer issues) and map those to `InvalidTokenError({ reason: "malformed" })` using a local try/catch around just the JSON.parse, or use `Effect.try` for that one line.
   - The key change: each distinct failure mode uses `Effect.fail` directly, not throwing Error strings and catching them.

**subscriber.service.ts** -- Fix three issues:

1. **Replace `catchAll` with `mapError` on DB queries.** The current `findByEmailQuery` uses `Effect.catchAll` which swallows ALL errors including SubscriberNotFoundError. Change to `Effect.mapError` so only the actual Drizzle/SQL error type is remapped, and tagged errors like SubscriberNotFoundError pass through. Apply the same fix to all other DB operations in subscribe, verify, and unsubscribe methods.

2. **Flatten nested if statements in `subscribe`.** Current code has:
   ```
   if (existing) {
     if (existing.status === "unsubscribed") { ... }
     return ...
   }
   ```
   Refactor to flat early-return style:
   - If existing AND status === "unsubscribed": update and return `{ id, isNew: true }`
   - If existing (any other status): return `{ id, isNew: false }`
   - Otherwise: insert and return

3. **Use happy-path coding for verify and unsubscribe.** Extract a `requireByEmail` helper that calls findByEmailQuery and fails with SubscriberNotFoundError if null. Then verify/unsubscribe become flat pipes:
   ```typescript
   verify: (email) =>
     requireByEmail(email).pipe(
       Effect.flatMap(() =>
         db.update(subscriber).set({ status: "active", verifiedAt: new Date() })
           .where(eq(subscriber.email, email))
       ),
       Effect.mapError((error) =>
         error._tag === "SubscriberNotFoundError" ? error :
         new SubscriberError({ message: `Failed to verify: ${email}`, cause: error })
       ),
       Effect.asVoid,
     ),
   ```
   Or use Effect.gen if the control flow warrants it. The key is: no explicit null-check-then-fail pattern. The `requireByEmail` helper encapsulates that.

**email.service.ts** -- Fix three issues:

1. **EmailServiceConsole**: Replace `console.log` with `Console.log` from effect. Import `Console` from "effect". The send function should pipe Console.log calls. Since Console.log returns an Effect, the send implementation needs to use `Effect.gen` or pipe multiple Console.log effects together with `Effect.all` or sequential `Effect.flatMap`. Example:
   ```typescript
   send: (params) =>
     Effect.gen(function* () {
       const preview = params.html.length > 200
         ? `${params.html.slice(0, 200)}...`
         : params.html;
       yield* Console.log(`[EMAIL] To: ${params.to} | Subject: ${params.subject}`);
       yield* Console.log(`[EMAIL] HTML: ${preview}`);
       if (params.headers) {
         yield* Console.log(`[EMAIL] Headers: ${JSON.stringify(params.headers)}`);
       }
     }),
   ```

2. **EmailServiceLive**: Convert to a factory function `makeEmailServiceLive(senderEmail: string)`. Hardcode region to `"eu-central-1"` (not from process.env). Remove the `process.env.SES_FROM_EMAIL` read. The factory returns a Layer. Example:
   ```typescript
   export const makeEmailServiceLive = (senderEmail: string) =>
     Layer.sync(EmailServiceTag, () => {
       const client = new SESv2Client({ region: "eu-central-1" });
       return {
         send: ({ to, subject, html, headers }) =>
           Effect.tryPromise({ ... }),
       };
     });
   ```

3. **Remove `EmailServiceAuto`** entirely. The auto-selection logic moves to the app layer (email-layers.ts in plan 02-07).

**email.mock.ts**: No changes needed -- already correct.

**index.ts (barrel exports)**: Update exports:
- Remove `EmailServiceAuto` and `EmailServiceLive` from named exports.
- Add `makeEmailServiceLive` to exports.
- Keep `EmailServiceConsole` and `EmailServiceTag`.
- The barrel should export: `EmailServiceConsole`, `EmailServiceTag`, `makeEmailServiceLive`.

**email.service.test.ts**: Update tests to work with Console.log instead of console.log. The EmailServiceConsole now uses Effect's Console.log which outputs to stdout differently. The existing tests spy on `console.log` -- since Effect's Console.log delegates to `console.log` by default in the standard runtime, the tests should still work. However, verify and adjust if needed. Run tests to confirm.

**subscriber.int.test.ts**: The tests themselves are correct but had failures due to the catchAll bug. After fixing mapError in subscriber.service.ts, tests 7 and 8 (verify/unsubscribe SubscriberNotFoundError) should pass because the error now propagates correctly. No test code changes needed for this -- just verify they pass.
  </action>
  <verify>
Run `pnpm test --filter @gemhog/core` and verify:
- All token.test.ts tests pass
- All subscriber.test.ts tests pass
- All email.service.test.ts tests pass
- subscriber.int.test.ts tests pass (if DB available -- tests 7+8 for SubscriberNotFoundError)

Run `pnpm check` to verify formatting/linting passes.
  </verify>
  <done>
- token.ts uses Effect.gen with Effect.fail for each error case (no throw/catch inside Effect.try)
- subscriber.service.ts uses mapError (not catchAll), has a requireByEmail helper, flat control flow
- email.service.ts EmailServiceConsole uses Console.log from effect
- email.service.ts exports makeEmailServiceLive factory (not EmailServiceLive with process.env)
- EmailServiceAuto removed from core package
- All core email tests pass
  </done>
</task>

<task type="auto">
  <name>Task 2: Remove SUBSCRIBER_TOKEN_SECRET from env and infra, update catalog and conventions</name>
  <files>
    packages/env/src/server.ts
    packages/env/src/server.test.ts
    pnpm-workspace.yaml
    .planning/codebase/CONVENTIONS.md
  </files>
  <action>
**packages/env/src/server.ts**: Remove the `SUBSCRIBER_TOKEN_SECRET` line from the env schema entirely. Token signing now uses BETTER_AUTH_SECRET which is already required.

**packages/env/src/server.test.ts**: Remove the entire `describe("optional SUBSCRIBER_TOKEN_SECRET", ...)` block (lines 229-266). Also remove any `SUBSCRIBER_TOKEN_SECRET` references in other test blocks (e.g., check that the guardrail test still passes since the var is removed from both schema and tests).

**pnpm-workspace.yaml**: Add `effect` to the catalog section. Check the version used in packages/core/package.json (currently `"effect": "^3.19"`) and add `effect: ^3.19` to the catalog. This allows other packages to use `"effect": "catalog:"` instead of hardcoding versions.

**CONVENTIONS.md**: Add a note about Sentry tracing with Effect under the "Effect-TS Patterns" section. Add a subsection:

```markdown
### Observability with Effect

**Sentry tracing:** When adding Sentry spans/traces to Effect pipelines, use
Effect's built-in tracing (Effect.withSpan) which integrates with OpenTelemetry.
Sentry's Node SDK auto-instruments via OpenTelemetry, so Effect.withSpan
annotations become Sentry spans automatically. Do NOT manually call
Sentry.startSpan inside Effect code.

```typescript
// GOOD: Effect.withSpan integrates with Sentry via OpenTelemetry
myEffect.pipe(Effect.withSpan("subscriber.subscribe"))

// BAD: Manual Sentry calls inside Effect code
Effect.gen(function* () {
  return Sentry.startSpan({ name: "subscribe" }, () => { ... })
})
```
```

This addresses code review item 13.
  </action>
  <verify>
Run `pnpm test --filter @gemhog/env` and verify all env tests pass (the guardrail test confirms every schema var has a test, so removing SUBSCRIBER_TOKEN_SECRET from both schema and tests should keep it green).

Run `pnpm check` for formatting.

Verify CONVENTIONS.md has the new observability section.
  </verify>
  <done>
- SUBSCRIBER_TOKEN_SECRET removed from env schema and tests
- pnpm-workspace.yaml catalog includes `effect: ^3.19`
- CONVENTIONS.md has Sentry tracing guidance for Effect code
- All env tests pass
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. `pnpm test --filter @gemhog/core` -- all email module tests pass
2. `pnpm test --filter @gemhog/env` -- all env tests pass
3. `pnpm check` -- no formatting or lint errors
4. Verify no `console.log` in EmailServiceConsole (grep)
5. Verify no `catchAll` in subscriber.service.ts (grep)
6. Verify no `EmailServiceAuto` in core barrel exports (grep)
7. Verify no `SUBSCRIBER_TOKEN_SECRET` in env schema (grep)
8. Verify `effect` appears in pnpm-workspace.yaml catalog
</verification>

<success_criteria>
- Core email services follow idiomatic Effect-TS patterns from CONVENTIONS.md
- Error types propagate correctly (no catchAll swallowing typed errors)
- EmailServiceLive is a factory function accepting senderEmail
- SUBSCRIBER_TOKEN_SECRET fully removed from env layer
- pnpm catalog includes effect
- All tests green
</success_criteria>

<output>
After completion, create `.planning/phases/02-email-infrastructure/02-06-SUMMARY.md`
</output>
