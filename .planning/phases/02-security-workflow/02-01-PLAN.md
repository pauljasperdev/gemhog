---
phase: 02-security-workflow
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - CLAUDE.md
  - .planning/codebase/SECURITY-REVIEW.md
  - .planning/codebase/CONCERNS.md
  - scripts/verify.sh
  - package.json
autonomous: true

must_haves:
  truths:
    - "Agent knows to run security review before declaring work complete"
    - "Agent can find and follow security review workflow instructions"
    - "Security findings are recorded in cumulative SECURITY-REVIEW.md"
    - "Critical/High/Medium findings block completion (only Low is non-blocking)"
    - "pnpm audit runs as part of verification pipeline"
  artifacts:
    - path: "CLAUDE.md"
      provides: "Security Verification workflow instructions"
      contains: "Security Verification (MANDATORY)"
    - path: ".planning/codebase/SECURITY-REVIEW.md"
      provides: "Cumulative security findings log"
      contains: "Security Review Log"
    - path: ".planning/codebase/CONCERNS.md"
      provides: "Reference to SECURITY-REVIEW.md"
      contains: "SECURITY-REVIEW.md"
    - path: "scripts/verify.sh"
      provides: "pnpm audit integration"
      contains: "pnpm audit"
  key_links:
    - from: "CLAUDE.md"
      to: ".planning/codebase/SECURITY-REVIEW.md"
      via: "workflow instructions reference"
      pattern: "SECURITY-REVIEW\\.md"
    - from: "CLAUDE.md"
      to: ".planning/codebase/SECURITY-CHECKLIST.md"
      via: "review against checklist"
      pattern: "SECURITY-CHECKLIST\\.md"
    - from: ".planning/codebase/CONCERNS.md"
      to: ".planning/codebase/SECURITY-REVIEW.md"
      via: "reference pointer"
      pattern: "SECURITY-REVIEW\\.md"
---

<objective>
Establish agent-driven security review workflow as a blocking gate before work completion.

Purpose: Security issues must be caught and fixed before code can be considered complete. This integrates security verification into the existing verification workflow (static -> unit -> integration -> security -> E2E).

Output:
- CLAUDE.md updated with Security Verification workflow section
- SECURITY-REVIEW.md created as cumulative findings log
- CONCERNS.md updated to reference SECURITY-REVIEW.md
- verify.sh updated to include pnpm audit
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-security-workflow/02-CONTEXT.md
@.planning/phases/02-security-workflow/02-RESEARCH.md
@.planning/codebase/SECURITY-CHECKLIST.md
@.planning/codebase/CONCERNS.md
@CLAUDE.md
@scripts/verify.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Security Verification workflow to CLAUDE.md and create SECURITY-REVIEW.md</name>
  <files>CLAUDE.md, .planning/codebase/SECURITY-REVIEW.md</files>
  <action>
1. Update CLAUDE.md to add a "Security Verification (MANDATORY)" section after the existing "Verification Requirements" section. The section must include:

   - Clear statement that security review is MANDATORY before declaring work complete
   - Trigger: Every commit, not just "sensitive" changes
   - Workflow steps:
     a. Check for pre-existing blocking findings in SECURITY-REVIEW.md
     b. Determine scope (changed files + imports + callers via git diff)
     c. Run `pnpm audit --audit-level low`
     d. Review code against SECURITY-CHECKLIST.md
     e. Record findings in SECURITY-REVIEW.md
     f. Resolve any Critical/High/Medium findings
     g. Update CONCERNS.md summary if findings changed
   - Severity blocking table: Critical=YES, High=YES, Medium=YES, Low=NO
   - Update "What Complete Means" section to include security criteria

2. Create .planning/codebase/SECURITY-REVIEW.md as a cumulative log with:
   - Header explaining purpose (cumulative findings, append-only)
   - Section for "Current Status Summary" (quick reference for blocking check)
   - Template for review session entries (date, reviewer, scope, dependency audit, files reviewed, findings, summary, sign-off)
   - Initial state: No open findings, ready for first review

Use the patterns from 02-RESEARCH.md for both files. Match the existing CLAUDE.md formatting style (markdown with code blocks, tables).
  </action>
  <verify>
    - grep -q "Security Verification (MANDATORY)" CLAUDE.md
    - grep -q "pnpm audit" CLAUDE.md
    - grep -q "SECURITY-REVIEW.md" CLAUDE.md
    - test -f .planning/codebase/SECURITY-REVIEW.md
    - grep -q "Security Review Log" .planning/codebase/SECURITY-REVIEW.md
  </verify>
  <done>
    - CLAUDE.md contains Security Verification workflow with all steps
    - Severity blocking table shows Critical/High/Medium block, Low does not
    - SECURITY-REVIEW.md exists with proper template structure
    - "What Complete Means" section includes security criteria
  </done>
</task>

<task type="auto">
  <name>Task 2: Update CONCERNS.md to reference SECURITY-REVIEW.md</name>
  <files>.planning/codebase/CONCERNS.md</files>
  <action>
Update the "Security Considerations" section in CONCERNS.md to:

1. Change the section to reference SECURITY-REVIEW.md as the source of truth (not duplicate findings)
2. Keep a summary format showing:
   - Current status summary (Critical: N, High: N, Medium: N, Low: N)
   - List of open findings by ID with brief description (links to SECURITY-REVIEW.md for details)
   - Last synced date
3. Move existing security findings (SEC-001, SEC-002, SEC-003) into SECURITY-REVIEW.md as historical entries, then update CONCERNS.md to reference them
4. Add note that full audit trail is in SECURITY-REVIEW.md

The existing findings should become the initial content of SECURITY-REVIEW.md (as "Pre-existing findings from codebase analysis").
  </action>
  <verify>
    - grep -q "See.*SECURITY-REVIEW.md" .planning/codebase/CONCERNS.md
    - grep -q "SEC-001" .planning/codebase/SECURITY-REVIEW.md
    - grep -q "SEC-002" .planning/codebase/SECURITY-REVIEW.md
    - grep -q "SEC-003" .planning/codebase/SECURITY-REVIEW.md
  </verify>
  <done>
    - CONCERNS.md Security section references SECURITY-REVIEW.md for details
    - CONCERNS.md shows summary counts, not full finding details
    - Existing findings (SEC-001, SEC-002, SEC-003) moved to SECURITY-REVIEW.md
    - No duplication between files
  </done>
</task>

<task type="auto">
  <name>Task 3: Update verify.sh with pnpm audit integration</name>
  <files>scripts/verify.sh, package.json</files>
  <action>
1. Update scripts/verify.sh to add a "Dependency Security" step that runs pnpm audit:
   - Add after Integration Tests, before E2E Tests (security should run before expensive E2E)
   - Run `pnpm audit --audit-level moderate` (moderate and above are blocking per user decision)
   - If audit fails, print message pointing to `pnpm audit` for details
   - Add echo reminder that agent must complete full security review (not just automated audit)

2. Add convenience script to package.json:
   - Add "security:audit": "pnpm audit --audit-level low" for running standalone

The verify.sh structure should be:
```
Static Analysis -> Unit Tests -> Integration Tests -> Dependency Security -> E2E Tests
```
  </action>
  <verify>
    - grep -q "pnpm audit" scripts/verify.sh
    - grep -q "Dependency Security" scripts/verify.sh
    - grep -q "security:audit" package.json
    - bash -n scripts/verify.sh (syntax check)
  </verify>
  <done>
    - verify.sh includes pnpm audit step between integration and E2E
    - verify.sh shows agent reminder for full security review
    - package.json has security:audit script
    - verify.sh passes syntax check
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Documentation verification:
   - CLAUDE.md has complete Security Verification workflow
   - SECURITY-REVIEW.md exists with template and initial findings
   - CONCERNS.md references SECURITY-REVIEW.md correctly

2. Automation verification:
   - `pnpm security:audit` runs successfully
   - `bash -n scripts/verify.sh` passes syntax check

3. Workflow verification:
   - An agent reading CLAUDE.md knows exactly what to do for security review
   - Severity blocking is clear (Critical/High/Medium block, Low does not)
   - Pre-existing findings are documented and trackable
</verification>

<success_criteria>
SEC-01 SATISFIED: Security review workflow documented, produces SECURITY-REVIEW.md
SEC-02 SATISFIED: Severity table shows Critical/High block, workflow enforces this
SEC-03 SATISFIED: CONCERNS.md references SECURITY-REVIEW.md for ongoing tracking

Measurable outcomes:
- grep "Security Verification (MANDATORY)" CLAUDE.md returns match
- test -f .planning/codebase/SECURITY-REVIEW.md returns 0
- grep "SECURITY-REVIEW.md" .planning/codebase/CONCERNS.md returns match
- pnpm security:audit runs without script error
</success_criteria>

<output>
After completion, create `.planning/phases/02-security-workflow/02-01-SUMMARY.md`
</output>
