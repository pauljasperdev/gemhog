---
phase: 03-core-consolidation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/core/package.json
  - packages/core/tsconfig.json
  - packages/core/drizzle.config.ts
  - packages/core/docker-compose.yml
  - packages/core/src/drizzle/index.ts
  - packages/core/src/drizzle/client.ts
  - packages/core/src/drizzle/errors.ts
  - packages/core/vitest.config.ts
autonomous: true

must_haves:
  truths:
    - "packages/core exists with domain-driven folder structure"
    - "Effect SQL packages installed and configured"
    - "Drizzle client can be created via Effect Layer"
    - "Database connection works via Effect PgClient"
  artifacts:
    - path: "packages/core/package.json"
      provides: "Package definition with Effect dependencies"
      contains: "@effect/sql-pg"
    - path: "packages/core/src/drizzle/index.ts"
      provides: "DatabaseLive layer export"
      exports: ["DatabaseLive", "PgLive", "DrizzleLive"]
    - path: "packages/core/src/drizzle/client.ts"
      provides: "Effect PgClient configuration"
      exports: ["PgLive"]
  key_links:
    - from: "packages/core/src/drizzle/index.ts"
      to: "@effect/sql-pg"
      via: "PgClient.layerConfig"
      pattern: "PgClient\\.layer"
    - from: "packages/core/src/drizzle/index.ts"
      to: "@effect/sql-drizzle"
      via: "PgDrizzle.layer"
      pattern: "PgDrizzle\\.layer"
---

<objective>
Create packages/core with Effect TS database layer foundation

Purpose: Establish the domain-driven package structure and Effect database infrastructure before migrating domain code. This is the foundation that auth and payment domains will build upon.

Output: Working packages/core with Effect-based database layers (PgLive, DrizzleLive) that can be composed with domain services.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-core-consolidation/03-CONTEXT.md
@.planning/phases/03-core-consolidation/03-RESEARCH.md

# Current package structures to migrate
@packages/db/package.json
@packages/db/drizzle.config.ts
@packages/db/docker-compose.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create packages/core package structure</name>
  <files>
    packages/core/package.json
    packages/core/tsconfig.json
    packages/core/vitest.config.ts
    packages/core/docker-compose.yml
    packages/core/drizzle.config.ts
    packages/core/.gitignore
  </files>
  <action>
Create the packages/core package with:

1. **package.json** with:
   - name: "@gemhog/core"
   - type: "module"
   - Dependencies from both packages/db and packages/auth:
     - "@gemhog/env": "workspace:*"
     - "effect": "^3.19"
     - "@effect/sql-pg": "^0.45"
     - "@effect/sql-drizzle": "^0.45"
     - "drizzle-orm": "^0.45.1"
     - "pg": "^8.16.3"
     - "better-auth": "catalog:"
     - "@polar-sh/better-auth": "catalog:"
     - "@polar-sh/sdk": "^0.34.16"
     - "dotenv": "catalog:"
     - "zod": "catalog:"
   - devDependencies:
     - "@gemhog/config": "workspace:*"
     - "@effect/vitest": "^0.45"
     - "@types/pg": "^8.15.6"
     - "drizzle-kit": "^0.31.8"
     - "typescript": "catalog:"
   - exports (subpath exports for domain imports):
     ```json
     {
       ".": { "default": "./src/drizzle/index.ts" },
       "./drizzle": { "default": "./src/drizzle/index.ts" },
       "./auth": { "default": "./src/auth/index.ts" },
       "./auth/auth.sql": { "default": "./src/auth/auth.sql.ts" },
       "./payment": { "default": "./src/payment/index.ts" }
     }
     ```
   - scripts: same db:* scripts from packages/db

2. **tsconfig.json** extending @gemhog/config/tsconfig.base.json with strict mode

3. **vitest.config.ts** similar to packages/db pattern

4. **docker-compose.yml** copied from packages/db (PostgreSQL container config)

5. **drizzle.config.ts** updated to use schema glob pattern `./src/*/*.sql.ts`

6. **.gitignore** with node_modules, dist, .env patterns
  </action>
  <verify>
    - File exists: packages/core/package.json
    - package.json contains "@effect/sql-pg"
    - package.json exports include "./auth" and "./drizzle"
  </verify>
  <done>packages/core package.json created with Effect dependencies and subpath exports</done>
</task>

<task type="auto">
  <name>Task 2: Create Effect database layers</name>
  <files>
    packages/core/src/drizzle/index.ts
    packages/core/src/drizzle/client.ts
    packages/core/src/drizzle/errors.ts
  </files>
  <action>
Create Effect-based database layer infrastructure:

1. **src/drizzle/errors.ts** - Database error types:
   ```typescript
   import { Data } from "effect";

   export class DatabaseError extends Data.TaggedError("DatabaseError")<{
     message: string;
     cause?: unknown;
   }> {}

   export class ConnectionError extends Data.TaggedError("ConnectionError")<{
     message: string;
     cause?: unknown;
   }> {}
   ```

2. **src/drizzle/client.ts** - PgClient layer using Effect Config:
   ```typescript
   import { Config, Layer } from "effect";
   import { PgClient } from "@effect/sql-pg";

   // PostgreSQL connection layer - reads DATABASE_URL at construction time
   export const PgLive = PgClient.layerConfig({
     url: Config.redacted("DATABASE_URL"),
   });
   ```

3. **src/drizzle/index.ts** - Composed database layer:
   ```typescript
   import { Layer } from "effect";
   import * as PgDrizzle from "@effect/sql-drizzle/Pg";
   import { PgLive } from "./client";

   // Drizzle layer composed on top of PgClient
   export const DrizzleLive = PgDrizzle.layer.pipe(Layer.provide(PgLive));

   // Combined database layer for app composition
   export const DatabaseLive = Layer.mergeAll(PgLive, DrizzleLive);

   // Re-export client for direct access
   export { PgLive } from "./client";
   export * from "./errors";
   ```

Follow Effect patterns from RESEARCH.md. Use `Config.redacted` for DATABASE_URL (sensitive value). The layers will be provided at app entry point.
  </action>
  <verify>
    - `pnpm check-types` passes (after pnpm install in next task)
    - Files export DatabaseLive, PgLive, DrizzleLive
  </verify>
  <done>Effect database layers created with PgClient and PgDrizzle composition</done>
</task>

<task type="auto">
  <name>Task 3: Install dependencies and verify</name>
  <files>pnpm-lock.yaml</files>
  <action>
Install dependencies and verify the package works:

1. Run `pnpm install` from monorepo root to install new packages/core dependencies

2. Verify TypeScript compilation: `pnpm --filter @gemhog/core check-types`

3. Verify Effect imports resolve correctly by checking no import errors

Note: We cannot test database connection yet (no DATABASE_URL in CI). The integration test will be added in plan 02 after auth domain is migrated.
  </action>
  <verify>
    - `pnpm install` succeeds
    - `pnpm --filter @gemhog/core check-types` passes (or no errors from core)
  </verify>
  <done>packages/core dependencies installed and TypeScript compiles</done>
</task>

</tasks>

<verification>
1. packages/core directory exists with package.json, tsconfig.json, drizzle.config.ts
2. src/drizzle/ directory contains index.ts, client.ts, errors.ts
3. pnpm install succeeds without errors
4. Type checking passes for packages/core
</verification>

<success_criteria>
- packages/core exists as a valid workspace package
- Effect SQL packages (@effect/sql-pg, @effect/sql-drizzle) are installed
- DatabaseLive layer is exported and typed correctly
- Foundation is ready for auth domain migration
</success_criteria>

<output>
After completion, create `.planning/phases/03-core-consolidation/03-01-SUMMARY.md`
</output>
