---
phase: 03-core-consolidation
plan: 04
type: execute
wave: 3
depends_on: ["03-02", "03-03"]
files_modified:
  - packages/api/src/context.ts
  - packages/api/package.json
  - apps/server/src/index.ts
  - apps/server/package.json
autonomous: true

must_haves:
  truths:
    - "All imports of @gemhog/auth updated to @gemhog/core/auth"
    - "All imports of @gemhog/db updated to use @gemhog/core"
    - "apps/server starts without import errors"
    - "packages/api type checks without errors"
  artifacts:
    - path: "packages/api/src/context.ts"
      provides: "Updated context with @gemhog/core/auth import"
      contains: "@gemhog/core/auth"
    - path: "apps/server/src/index.ts"
      provides: "Updated server with @gemhog/core/auth import"
      contains: "@gemhog/core/auth"
    - path: "packages/api/package.json"
      provides: "Updated dependencies"
      contains: "@gemhog/core"
  key_links:
    - from: "packages/api/src/context.ts"
      to: "packages/core/src/auth/index.ts"
      via: "workspace import"
      pattern: "from \"@gemhog/core/auth\""
    - from: "apps/server/src/index.ts"
      to: "packages/core/src/auth/index.ts"
      via: "workspace import"
      pattern: "from \"@gemhog/core/auth\""
---

<objective>
Update all consumers to import from @gemhog/core

Purpose: Update packages/api and apps/server to use the new @gemhog/core package instead of @gemhog/db and @gemhog/auth. This completes the migration before removing old packages.

Output: All consumers updated to use new import paths, type checking passes, server starts.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-core-consolidation/03-CONTEXT.md

# Current consumers to update
@packages/api/src/context.ts
@packages/api/package.json
@apps/server/src/index.ts
@apps/server/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update packages/api imports and dependencies</name>
  <files>
    packages/api/src/context.ts
    packages/api/package.json
  </files>
  <action>
1. **packages/api/package.json** - Update dependencies:
   - Remove: "@gemhog/auth": "workspace:*"
   - Remove: "@gemhog/db": "workspace:*"
   - Add: "@gemhog/core": "workspace:*"
   - Keep all other dependencies unchanged

2. **packages/api/src/context.ts** - Update import:
   ```typescript
   // Before
   import { auth } from "@gemhog/auth";

   // After
   import { auth } from "@gemhog/core/auth";
   ```

   The rest of the file remains unchanged — createContext function uses auth.api.getSession which works with the exported auth instance.
  </action>
  <verify>
    - packages/api/package.json contains "@gemhog/core"
    - packages/api/package.json does NOT contain "@gemhog/auth" or "@gemhog/db"
    - packages/api/src/context.ts imports from "@gemhog/core/auth"
  </verify>
  <done>packages/api updated to use @gemhog/core</done>
</task>

<task type="auto">
  <name>Task 2: Update apps/server imports and dependencies</name>
  <files>
    apps/server/src/index.ts
    apps/server/package.json
  </files>
  <action>
1. **apps/server/package.json** - Update dependencies:
   - Remove: "@gemhog/auth": "workspace:*"
   - Remove: "@gemhog/db": "workspace:*"
   - Add: "@gemhog/core": "workspace:*"
   - Keep all other dependencies unchanged

2. **apps/server/src/index.ts** - Update import:
   ```typescript
   // Before
   import { auth } from "@gemhog/auth";

   // After
   import { auth } from "@gemhog/core/auth";
   ```

   The rest of the file remains unchanged — auth.handler usage works with the exported auth instance.
  </action>
  <verify>
    - apps/server/package.json contains "@gemhog/core"
    - apps/server/package.json does NOT contain "@gemhog/auth" or "@gemhog/db"
    - apps/server/src/index.ts imports from "@gemhog/core/auth"
  </verify>
  <done>apps/server updated to use @gemhog/core</done>
</task>

<task type="auto">
  <name>Task 3: Verify imports resolve and types check</name>
  <files></files>
  <action>
Run verification to ensure all imports resolve correctly:

1. Run `pnpm install` to update workspace links

2. Run `pnpm check-types` to verify TypeScript compilation across all packages

3. Verify no remaining @gemhog/db or @gemhog/auth imports exist:
   ```bash
   grep -r "@gemhog/db\|@gemhog/auth" packages/api/ apps/server/ --include="*.ts" || echo "No old imports found"
   ```

4. Verify @gemhog/core imports are present:
   ```bash
   grep -r "@gemhog/core" packages/api/ apps/server/ --include="*.ts"
   ```

Note: The old packages/db and packages/auth still exist at this point — they will be removed in the next plan.
  </action>
  <verify>
    - `pnpm install` succeeds
    - `pnpm check-types` passes
    - No @gemhog/db or @gemhog/auth imports in packages/api or apps/server
  </verify>
  <done>All consumers updated and verified</done>
</task>

</tasks>

<verification>
1. packages/api and apps/server use @gemhog/core imports
2. No references to @gemhog/db or @gemhog/auth in consumer code
3. pnpm install succeeds
4. pnpm check-types passes
</verification>

<success_criteria>
- All consumer imports updated to @gemhog/core/auth
- Package.json dependencies updated (removed old, added new)
- Type checking passes across monorepo
- Ready for old package removal
</success_criteria>

<output>
After completion, create `.planning/phases/03-core-consolidation/03-04-SUMMARY.md`
</output>
