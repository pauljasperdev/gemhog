# Phase 3.1: Code Review Cleanup - Context

**Gathered:** 2026-01-20
**Status:** Ready for planning

<domain>
## Phase Boundary

Address all items identified in CODE_REVIEW.md to improve code quality and fix blocking issues. Includes: removing unused payment code, regenerating auth schema, migrating env config to Effect, simplifying auth service, setting up migrations, and auditing dependencies.

</domain>

<decisions>
## Implementation Decisions

### Execution Order
- Payment removal FIRST (cleanest schema starting point)
- Regenerate auth schema with better-auth CLI after payment removal
- Env config migration to Effect Config
- Auth service simplification
- Migration workflow setup
- Dependency audit last

### Plan Granularity
- One plan per step (6 small plans)
- Atomic commits for each change
- Easier to review and revert if needed

### Payment Removal
- Payment system is fully unused — safe to remove completely
- Remove all payment-related files from packages/core/src/payment/
- Remove payment exports from packages/core
- Remove Polar-related fields from auth.sql.ts before regenerating

### Auth Schema
- Use better-auth CLI to regenerate auth.sql.ts from scratch
- Generates clean schema without payment fields
- Run db:generate to create initial migration from clean schema

### Migration Workflow
- Keep db:start and db:migrate as separate commands (explicit control)
- Auto-migrate in test globalSetup.ts (zero manual steps for tests)
- Generate migrations from current schema (not db:push)
- Tests always run against up-to-date schema

### Auth Service
- Full removal of Effect constructs (AuthService tag, AuthLive layer)
- Eager initialization following better-auth docs pattern
- Module-level: `export const auth = betterAuth({...})`
- Add integration tests for auth (auth.int.test.ts)

### Env Config
- Replace t3-env/Zod with Effect Config
- Use Config.redacted() for sensitive vars (DATABASE_URL, secrets)
- Fail at import time if required vars missing (Effect.runSync)
- Add unit tests for env validation

### Claude's Discretion
- Exact file structure for migration workflow
- Error message formatting details
- Integration test coverage depth

</decisions>

<specifics>
## Specific Ideas

- better-auth CLI regenerates auth.sql.ts cleanly
- Follow better-auth docs for eager initialization pattern
- Config.redacted() hides secrets in error messages
- One plan per step enables atomic, reviewable commits

</specifics>

<deferred>
## Deferred Ideas

None — discussion stayed within phase scope

</deferred>

---

*Phase: 03.1-code-review-cleanup*
*Context gathered: 2026-01-20*
