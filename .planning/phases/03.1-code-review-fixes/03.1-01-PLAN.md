---
phase: 03.1-code-review-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/core/src/migrations/0000_initial_schema.sql
  - packages/core/src/migrations/meta/_journal.json
autonomous: true

must_haves:
  truths:
    - "Database migrations exist in packages/core/src/migrations/"
    - "pnpm db:generate succeeds without errors"
    - "pnpm db:migrate applies schema to database"
  artifacts:
    - path: "packages/core/src/migrations/0000_initial_schema.sql"
      provides: "Initial schema migration SQL"
      contains: "CREATE TABLE"
    - path: "packages/core/src/migrations/meta/_journal.json"
      provides: "Migration journal tracking"
      contains: "entries"
  key_links:
    - from: "packages/core/drizzle.config.ts"
      to: "packages/core/src/migrations/"
      via: "out: './src/migrations'"
      pattern: "out:.*migrations"
---

<objective>
Generate initial database migrations from auth schema

Purpose: Integration tests cannot work without database schema. This is a
BLOCKING dependency for all subsequent work. Output: Migration files in
packages/core/src/migrations/ </objective>

<execution_context> @~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md </execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/TESTING.md
@.planning/codebase/CONVENTIONS.md

# Schema to generate migrations from

@packages/core/src/auth/auth.sql.ts

# Current drizzle config

@packages/core/drizzle.config.ts </context>

<tasks>

<task type="auto">
  <name>Task 1: Generate initial database migrations</name>
  <files>packages/core/src/migrations/*</files>
  <action>
1. Ensure DATABASE_URL is set (use apps/server/.env via dotenv temporarily - drizzle.config.ts already does this)

2. Run migration generation:

   ```bash
   cd packages/core && pnpm db:generate
   ```

3. Verify migration files were created in packages/core/src/migrations/

4. The generated SQL should include CREATE TABLE statements for:
   - user (id, name, email, emailVerified, image, createdAt, updatedAt)
   - session (id, expiresAt, token, createdAt, updatedAt, ipAddress, userAgent,
     userId)
   - account (id, accountId, providerId, userId, accessToken, refreshToken,
     idToken, accessTokenExpiresAt, refreshTokenExpiresAt, scope, password,
     createdAt, updatedAt)
   - verification (id, identifier, value, expiresAt, createdAt, updatedAt)

Note: drizzle.config.ts currently uses dotenv directly. This will be fixed in a
later plan. For now, it works as-is. </action> <verify>

- ls packages/core/src/migrations/\*.sql shows at least one migration file
- cat packages/core/src/migrations/meta/\_journal.json shows entries array
- grep "CREATE TABLE" packages/core/src/migrations/\*.sql returns matches
  </verify> <done>Migration files exist with CREATE TABLE statements for user,
  session, account, verification tables</done> </task>

<task type="auto">
  <name>Task 2: Verify migrations apply successfully</name>
  <files>None (verification only)</files>
  <action>
1. Start the database:
   ```bash
   pnpm db:start
   ```

2. Apply migrations:

   ```bash
   cd packages/core && pnpm db:migrate
   ```

3. Verify tables exist by running a quick query or checking with db:studio

4. Run integration tests to confirm they can connect:
   ```bash
   pnpm test:integration
   ```

If migrations fail, check:

- DATABASE_URL is correct in apps/server/.env
- Docker is running
- Migration SQL syntax is valid </action> <verify>
- pnpm db:migrate exits with code 0
- pnpm test:integration passes (or at least connects to DB successfully)
  </verify> <done>Migrations apply without errors, integration tests can query
  database</done> </task>

</tasks>

<verification>
```bash
# Migration files exist
ls packages/core/src/migrations/*.sql

# Migrations can be applied

pnpm db:start && cd packages/core && pnpm db:migrate

# Integration tests work

pnpm test:integration

```
</verification>

<success_criteria>
- packages/core/src/migrations/ contains at least one .sql file
- pnpm db:migrate succeeds
- Integration tests can connect and query the database
</success_criteria>

<output>
After completion, create `.planning/phases/03.1-code-review-fixes/03.1-01-SUMMARY.md`
</output>
```
