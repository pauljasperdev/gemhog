---
phase: 03.1-code-review-fixes
plan: 03
type: execute
wave: 2
depends_on:
  - "03.1-01"
files_modified:
  - packages/env/src/server.ts
  - packages/env/src/web.ts
  - packages/env/package.json
autonomous: true

must_haves:
  truths:
    - "packages/env uses Effect Config instead of t3-env"
    - "Sensitive values (DATABASE_URL, secrets) use Config.redacted()"
    - "Import-time validation via Effect.runSync()"
    - "Same export API: env object with typed properties"
  artifacts:
    - path: "packages/env/src/server.ts"
      provides: "Server environment config with Effect"
      contains: "Config.redacted"
      exports: ["env"]
    - path: "packages/env/src/web.ts"
      provides: "Web environment config with Effect"
      contains: "Config.string"
      exports: ["env"]
    - path: "packages/env/package.json"
      provides: "Package dependencies"
      contains: "effect"
  key_links:
    - from: "packages/env/src/server.ts"
      to: "effect"
      via: "import"
      pattern: 'import.*from "effect"'
---

<objective>
Replace t3-env with Effect Config in packages/env

Purpose: Consolidate on Effect for schema validation. Effect Config provides
Config.redacted() for sensitive values and Effect.runSync() for import-time
validation. Removes need for dynamic require() hack in auth/payment services.
Output: packages/env using Effect Config with same external API </objective>

<execution_context> @~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md </execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03.1-code-review-fixes/03.1-RESEARCH.md
@.planning/codebase/CONVENTIONS.md

# Current implementation

@packages/env/src/server.ts @packages/env/src/web.ts @packages/env/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update packages/env with Effect Config</name>
  <files>
    packages/env/src/server.ts
    packages/env/src/web.ts
    packages/env/package.json
  </files>
  <action>
1. Update packages/env/package.json:
   - Add "effect": "^3.19" to dependencies (or use catalog: if available)
   - Remove "@t3-oss/env-core" and "@t3-oss/env-nextjs"
   - Remove "zod" (no longer needed)
   - Keep "dotenv" for loading .env files

2. Rewrite packages/env/src/server.ts:

```typescript
import "dotenv/config";
import { Config, Effect, Redacted } from "effect";

const ServerConfig = Config.all({
  DATABASE_URL: Config.redacted("DATABASE_URL"),
  BETTER_AUTH_SECRET: Config.redacted("BETTER_AUTH_SECRET"),
  BETTER_AUTH_URL: Config.string("BETTER_AUTH_URL"),
  POLAR_ACCESS_TOKEN: Config.redacted("POLAR_ACCESS_TOKEN"),
  POLAR_SUCCESS_URL: Config.string("POLAR_SUCCESS_URL"),
  CORS_ORIGIN: Config.string("CORS_ORIGIN"),
  NODE_ENV: Config.string("NODE_ENV").pipe(Config.withDefault("development")),
});

// Validates at import time - fails fast if env missing
export const env = Effect.runSync(ServerConfig);

// Type helper for consumers that need the raw string
export type ServerEnv = typeof env;
```

3. Rewrite packages/env/src/web.ts:

```typescript
import { Config, Effect } from "effect";

const WebConfig = Config.all({
  NEXT_PUBLIC_SERVER_URL: Config.string("NEXT_PUBLIC_SERVER_URL"),
});

// Validates at import time
export const env = Effect.runSync(WebConfig);

export type WebEnv = typeof env;
```

IMPORTANT: Config.redacted() returns Redacted<string>, not string. Consumers
must use Redacted.value(env.DATABASE_URL) to get the actual string. </action>
<verify>

- packages/env/package.json has "effect" in dependencies
- packages/env/package.json does NOT have "@t3-oss/env-core" or
  "@t3-oss/env-nextjs"
- grep "Config.redacted" packages/env/src/server.ts returns matches
- grep "Effect.runSync" packages/env/src/server.ts returns matches </verify>
  <done>packages/env uses Effect Config with Config.redacted for sensitive
  values</done> </task>

<task type="auto">
  <name>Task 2: Update consumers to use Redacted.value()</name>
  <files>
    packages/core/src/auth/auth.service.ts
    packages/core/drizzle.config.ts
  </files>
  <action>
1. Update packages/core/src/auth/auth.service.ts:
   - Remove dynamic require() hack - use static import
   - Add `import { Redacted } from "effect"`
   - Replace `env.DATABASE_URL` with `Redacted.value(env.DATABASE_URL)`
   - Replace `env.POLAR_ACCESS_TOKEN` with `Redacted.value(env.POLAR_ACCESS_TOKEN)`
   - Replace `env.BETTER_AUTH_SECRET` with `Redacted.value(env.BETTER_AUTH_SECRET)` if used

2. Update packages/core/drizzle.config.ts:
   - Replace dotenv import with `import { env } from "@gemhog/env/server"`
   - Add `import { Redacted } from "effect"`
   - Replace `process.env.DATABASE_URL || ""` with
     `Redacted.value(env.DATABASE_URL)`
   - Remove the dotenv.config() call

3. Run type check to find any other consumers:
   ```bash
   pnpm check-types
   ```
   Fix any type errors related to Redacted<string> vs string mismatch. </action>
   <verify>

- grep "require.\*@gemhog/env" packages/core/src/ returns no results
- grep "dotenv" packages/core/drizzle.config.ts returns no results
- grep "Redacted.value" packages/core/src/auth/auth.service.ts returns matches
- pnpm check-types passes </verify> <done>All consumers updated to use static
  imports and Redacted.value()</done> </task>

<task type="auto">
  <name>Task 3: Verify Effect Config works end-to-end</name>
  <files>None (verification only)</files>
  <action>
1. Install updated dependencies:
   ```bash
   pnpm install
   ```

2. Run type check:

   ```bash
   pnpm check-types
   ```

3. Run unit tests:

   ```bash
   pnpm test:unit
   ```

4. Test that missing env vars fail at import time:
   - Temporarily rename apps/server/.env to .env.bak
   - Try to import @gemhog/env/server (should throw ConfigError)
   - Restore .env file

5. Run integration tests (needs DATABASE_URL):

   ```bash
   pnpm db:start && pnpm test:integration
   ```

6. Verify db:migrate still works (tests drizzle.config.ts):
   ```bash
   cd packages/core && pnpm db:migrate
   ```
   </action>
   <verify>

- pnpm check-types exits 0
- pnpm test:unit passes
- pnpm test:integration passes
- pnpm db:migrate succeeds </verify> <done>Effect Config validates env at import
  time, all tests pass</done> </task>

</tasks>

<verification>
```bash
# Dependencies updated
grep "effect" packages/env/package.json
grep -v "t3-oss" packages/env/package.json

# No more dynamic require

grep -r "require.\*@gemhog/env" packages/core/src/

# Types pass

pnpm check-types

# Tests pass

pnpm test:unit && pnpm test:integration

```
</verification>

<success_criteria>
- packages/env uses Effect Config (no t3-env)
- Sensitive values use Config.redacted()
- No dynamic require() hacks in auth/payment services
- drizzle.config.ts uses @gemhog/env (no dotenv)
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/03.1-code-review-fixes/03.1-03-SUMMARY.md`
</output>
```
