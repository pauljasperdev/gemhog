---
phase: 03.1-code-review-fixes
plan: 03
subsystem: env, config
tags: [effect, config, redacted, env-validation, t3-env]

# Dependency graph
requires:
  - phase: 03-core
    provides: Effect TS infrastructure, auth service
  - phase: 03.1-01
    provides: Database migrations
provides:
  - Effect Config for env validation with Config.redacted()
  - Import-time validation via Effect.runSync()
  - Type-safe env access across packages
affects: [04-api, 05-payments]

# Tech tracking
tech-stack:
  added: []
  patterns: [deferred-env-import, config-redacted]

key-files:
  created: []
  modified:
    - packages/env/src/server.ts
    - packages/env/src/web.ts
    - packages/env/package.json
    - packages/core/src/auth/auth.service.ts
    - packages/core/drizzle.config.ts

key-decisions:
  - "Use deferred require() for auth.service.ts to enable unit testing without
    env vars"
  - "Use dotenv directly in drizzle.config.ts since drizzle-kit only needs
    DATABASE_URL"
  - "Simplified auth to remove Effect wrapper per external refactor"

patterns-established:
  - "Deferred env import: Use type-only import + require() for testability"
  - "Config.redacted(): Sensitive values wrapped in Redacted<string>"

# Metrics
duration: 15min
completed: 2026-01-21
---

# Phase 03.1 Plan 03: Effect Config Migration Summary

**Replaced t3-env with Effect Config using Config.redacted() for sensitive
values, with deferred import pattern for testability**

## Performance

- **Duration:** 15 min
- **Started:** 2026-01-21T09:11:14Z
- **Completed:** 2026-01-21T09:26:12Z
- **Tasks:** 3
- **Files modified:** 5

## Accomplishments

- Migrated packages/env from t3-env to Effect Config
- Sensitive values (DATABASE_URL, secrets, tokens) use Config.redacted()
- Consumers use Redacted.value() to access string values
- Unit tests run without env vars via deferred import pattern
- drizzle-kit migrations work with minimal env (DATABASE_URL only)

## Task Commits

1. **Tasks 1+2: Update packages/env and consumers** - `249d66a` (feat)
2. **Fix: Deferred env import for testability** - `b1aa4b6` (fix)
3. **External: Simplify auth by removing Effect wrapper** - `f09139c` (refactor)
4. **Fix: drizzle.config.ts use dotenv directly** - `4fd9e20` (fix)

## Files Created/Modified

- `packages/env/package.json` - Replaced t3-env with effect dependency
- `packages/env/src/server.ts` - Effect Config with Config.redacted()
- `packages/env/src/web.ts` - Effect Config for client env
- `packages/core/src/auth/auth.service.ts` - Deferred env import,
  Redacted.value()
- `packages/core/drizzle.config.ts` - dotenv for DATABASE_URL only

## Decisions Made

| Decision                                      | Rationale                                                                                       |
| --------------------------------------------- | ----------------------------------------------------------------------------------------------- |
| Deferred require() for env in auth.service.ts | Static import triggers validation at module load, breaking unit tests that import AuthService   |
| dotenv directly in drizzle.config.ts          | @gemhog/env validates ALL env vars, but drizzle-kit only needs DATABASE_URL                     |
| Simplified auth (external refactor)           | Removed Effect wrapper (AuthService, AuthLive) - better-auth is self-contained at HTTP boundary |

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] Static env import broke unit tests**

- **Found during:** Task 2 verification
- **Issue:** `import { env } from "@gemhog/env/server"` validates all env vars
  at import time, causing auth.test.ts to fail without env vars
- **Fix:** Changed to type-only import + deferred `require()` via `getEnv()`
  function
- **Files modified:** packages/core/src/auth/auth.service.ts
- **Verification:** `pnpm test:unit` passes
- **Committed in:** b1aa4b6

**2. [Rule 3 - Blocking] drizzle.config.ts required all env vars**

- **Found during:** Task 3 verification (db:migrate)
- **Issue:** `import { env } from "@gemhog/env/server"` validates ALL env vars,
  but drizzle-kit only has DATABASE_URL
- **Fix:** Reverted to dotenv direct import with explicit comment
- **Files modified:** packages/core/drizzle.config.ts
- **Verification:** `pnpm db:migrate` passes
- **Committed in:** 4fd9e20

**3. [External - Architectural] Auth simplified to remove Effect wrapper**

- **Found during:** Execution
- **Issue:** External process committed refactor removing AuthService
  Context.Tag and AuthLive Layer
- **Impact:** Simplified auth module, removed auth.mock.ts, updated exports
- **Committed in:** f09139c (by external process)

---

**Total deviations:** 3 (2 auto-fixed blocking issues, 1 external architectural
change) **Impact on plan:** Plan goal of "no dynamic require()" partially
achieved - require() still needed in auth.service.ts for testability.
drizzle.config.ts reverted to dotenv. Auth simplified externally.

## Issues Encountered

- **External tool interference:** An external process (likely IDE plugin)
  continuously modified files, removing "unused" imports and deleting
  auth.mock.ts. Required multiple restores from git and careful commit timing.
- **Env validation at import time:** Effect Config's `Effect.runSync()`
  validates immediately on import, which is desirable for runtime but
  problematic for unit tests.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- packages/env uses Effect Config with proper redaction
- All tests pass (unit, integration)
- db:migrate works
- Auth module simplified (no Effect wrapper, plain functions)

**Note:** The plan's goal of "no dynamic require() hack" was partially achieved.
While the env package itself uses static Effect.runSync(), auth.service.ts still
uses a deferred require() pattern for testability. This is a pragmatic
compromise.

---

_Phase: 03.1-code-review-fixes_ _Completed: 2026-01-21_
