---
phase: 03.1-code-review-fixes
plan: 04
type: execute
wave: 2
depends_on:
  - "03.1-03"
files_modified:
  - packages/core/src/auth/auth.service.ts
  - packages/core/src/auth/auth.mock.ts
  - packages/core/src/auth/auth.test.ts
  - packages/core/src/auth/index.ts
autonomous: true

must_haves:
  truths:
    - "AuthService Context.Tag is removed"
    - "AuthLive Layer is removed"
    - "getAuth(), auth proxy, and getSession() remain as plain functions"
    - "Auth still works via better-auth at HTTP boundary"
  artifacts:
    - path: "packages/core/src/auth/auth.service.ts"
      provides: "Simplified auth without Effect wrapper"
      exports: ["getAuth", "auth", "getSession"]
    - path: "packages/core/src/auth/index.ts"
      provides: "Auth domain public API"
      exports: ["getAuth", "auth", "getSession"]
  key_links:
    - from: "apps/server/src/index.ts"
      to: "packages/core/src/auth"
      via: "import { auth } from @gemhog/core/auth"
      pattern: "auth.handler"
---

<objective>
Simplify auth service by removing Effect wrapper

Purpose: better-auth sits at the HTTP boundary and is self-contained. The Effect
wrapper (AuthService, AuthLive) adds complexity without testability benefits.
Keep plain functions. Output: Simplified auth.service.ts with getAuth(), auth
proxy, and getSession() </objective>

<execution_context> @~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md </execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/CONVENTIONS.md
@.planning/phases/03.1-code-review-fixes/03.1-RESEARCH.md

# Current implementation (now uses static imports after 03.1-03)

@packages/core/src/auth/auth.service.ts @packages/core/src/auth/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Simplify auth.service.ts</name>
  <files>packages/core/src/auth/auth.service.ts</files>
  <action>
Rewrite packages/core/src/auth/auth.service.ts to remove Effect wrapper:

```typescript
import { checkout, polar, portal } from "@polar-sh/better-auth";
import { Polar } from "@polar-sh/sdk";
import { betterAuth } from "better-auth";
import { drizzleAdapter } from "better-auth/adapters/drizzle";
import { drizzle } from "drizzle-orm/node-postgres";
import { Redacted } from "effect";
import { env } from "@gemhog/env/server";
import * as schema from "./auth.sql";

// Create better-auth instance
const createAuth = () => {
  const db = drizzle(Redacted.value(env.DATABASE_URL), { schema });
  const polarClient = new Polar({
    accessToken: Redacted.value(env.POLAR_ACCESS_TOKEN),
    server: "sandbox",
  });

  return betterAuth({
    database: drizzleAdapter(db, { provider: "pg", schema }),
    trustedOrigins: [env.CORS_ORIGIN],
    emailAndPassword: { enabled: true },
    advanced: {
      defaultCookieAttributes: {
        sameSite: "none",
        secure: true,
        httpOnly: true,
      },
    },
    plugins: [
      polar({
        client: polarClient,
        createCustomerOnSignUp: true,
        enableCustomerPortal: true,
        use: [
          checkout({
            products: [{ productId: "your-product-id", slug: "pro" }],
            successUrl: env.POLAR_SUCCESS_URL,
            authenticatedUsersOnly: true,
          }),
          portal(),
        ],
      }),
    ],
  });
};

// Lazy singleton
let _auth: ReturnType<typeof createAuth> | null = null;
export const getAuth = () => {
  if (!_auth) {
    _auth = createAuth();
  }
  return _auth;
};

// Convenience proxy for backward compatibility
type BetterAuthInstance = ReturnType<typeof betterAuth>;
export const auth = new Proxy({} as BetterAuthInstance, {
  get(_target, prop) {
    return (getAuth() as unknown as Record<string | symbol, unknown>)[prop];
  },
});

// Plain async helper for getting session
export const getSession = (headers: Headers) =>
  getAuth().api.getSession({ headers });
```

Key changes:

- Remove `import { Context, Effect, Layer } from "effect"`
- Remove `AuthServiceInterface` type
- Remove `AuthService` Context.Tag
- Remove `AuthLive` Layer
- Keep getAuth(), auth proxy, getSession() as plain functions
- Use static import of env (Effect Config validates at import time) </action>
  <verify>
- grep "Context.Tag" packages/core/src/auth/auth.service.ts returns no results
- grep "Layer" packages/core/src/auth/auth.service.ts returns no results
- grep "export const getAuth" packages/core/src/auth/auth.service.ts returns
  match
- grep "export const auth" packages/core/src/auth/auth.service.ts returns match
  </verify> <done>auth.service.ts simplified to plain functions without Effect
  wrapper</done> </task>

<task type="auto">
  <name>Task 2: Update auth exports and tests</name>
  <files>
    packages/core/src/auth/index.ts
    packages/core/src/auth/auth.mock.ts
    packages/core/src/auth/auth.test.ts
  </files>
  <action>
1. Update packages/core/src/auth/index.ts:
   - Remove AuthService, AuthLive exports
   - Keep: getAuth, auth, getSession, AuthError, schema exports

2. Remove or update packages/core/src/auth/auth.mock.ts:
   - If it only provides AuthServiceTest Layer: delete it
   - If it has useful test utilities: keep relevant parts

3. Update packages/core/src/auth/auth.test.ts:
   - Remove tests that use AuthService/AuthLive Effect patterns
   - Update to test getAuth(), auth proxy, getSession() directly
   - Simple tests:
     - getAuth() returns singleton instance
     - auth proxy delegates to getAuth()
     - getSession calls better-auth API

Example test structure:

```typescript
import { describe, it, expect, vi, beforeEach } from "vitest";

// Note: Cannot easily unit test without mocking env
// These tests verify the structure, not behavior
describe("auth", () => {
  describe("getAuth", () => {
    it("should be a function", () => {
      expect(typeof getAuth).toBe("function");
    });
  });

  describe("auth proxy", () => {
    it("should be an object", () => {
      expect(typeof auth).toBe("object");
    });
  });

  describe("getSession", () => {
    it("should be a function", () => {
      expect(typeof getSession).toBe("function");
    });
  });
});
```

  </action>
  <verify>
- grep "AuthService" packages/core/src/auth/index.ts returns no results
- grep "AuthLive" packages/core/src/auth/index.ts returns no results
- pnpm check-types passes
  </verify>
  <done>Auth exports updated, tests simplified</done>
</task>

<task type="auto">
  <name>Task 3: Verify auth still works</name>
  <files>None (verification only)</files>
  <action>
1. Run type check:
   ```bash
   pnpm check-types
   ```

2. Run unit tests:

   ```bash
   pnpm test:unit
   ```

3. Run integration tests (auth needs database):

   ```bash
   pnpm db:start && pnpm test:integration
   ```

4. Verify apps/server can still import and use auth:
   - Check that apps/server/src/index.ts imports work
   - The auth.handler(request) pattern should still work </action> <verify>

- pnpm check-types exits 0
- pnpm test:unit passes
- pnpm test:integration passes
- grep "auth.handler" apps/server/src/index.ts returns match </verify>
  <done>Simplified auth works correctly, all tests pass</done> </task>

</tasks>

<verification>
```bash
# No Effect wrapper constructs
grep -E "AuthService|AuthLive|Context.Tag|Layer" packages/core/src/auth/

# Exports are correct

grep "export" packages/core/src/auth/index.ts

# Types pass

pnpm check-types

# Tests pass

pnpm test:unit && pnpm test:integration

```
</verification>

<success_criteria>
- AuthService Context.Tag removed
- AuthLive Layer removed
- getAuth(), auth, getSession() work as plain functions
- apps/server can still use auth.handler
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/03.1-code-review-fixes/03.1-04-SUMMARY.md`
</output>
```
