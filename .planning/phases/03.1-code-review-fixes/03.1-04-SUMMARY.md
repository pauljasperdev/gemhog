---
phase: 03.1-code-review-fixes
plan: 04
subsystem: auth
tags: [better-auth, effect, lazy-singleton, proxy-pattern]

# Dependency graph
requires:
  - phase: 03.1-03
    provides: Effect Config with Redacted values in @gemhog/env
provides:
  - Simplified auth.service.ts without Effect Context.Tag/Layer wrapper
  - Plain function exports (getAuth, auth, getSession)
  - Cleaner auth domain public API
affects: [apps/server, future-auth-consumers]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - lazy-singleton for better-auth instance
    - proxy-pattern for backward-compatible exports
    - deferred-require for testability

key-files:
  created: []
  modified:
    - packages/core/src/auth/auth.service.ts
    - packages/core/src/auth/index.ts
    - packages/core/src/auth/auth.test.ts
  deleted:
    - packages/core/src/auth/auth.mock.ts

key-decisions:
  - "Remove Effect wrapper (Context.Tag, Layer) - better-auth is self-contained at HTTP boundary"
  - "Keep deferred require() for env - enables unit tests without env validation"
  - "Delete auth.mock.ts - only provided Effect Layer mocks which are no longer needed"

patterns-established:
  - "Lazy singleton: create instance on first access, cache for reuse"
  - "Proxy pattern: backward-compatible export that delegates to singleton"

# Metrics
duration: 15min
completed: 2026-01-21
---

# Phase 3.1 Plan 4: Simplify Auth Summary

**Removed Effect Context.Tag/Layer wrapper from auth, keeping plain getAuth/auth/getSession functions with lazy singleton pattern**

## Performance

- **Duration:** 15 min
- **Started:** 2026-01-21T09:11:33Z
- **Completed:** 2026-01-21T09:26:26Z
- **Tasks:** 3
- **Files modified:** 4 (3 modified, 1 deleted)

## Accomplishments

- Removed AuthService Context.Tag and AuthLive Layer from auth.service.ts
- Deleted auth.mock.ts (only provided Effect Layer mocks)
- Simplified auth.test.ts to test plain function structure
- Updated index.ts exports to getAuth, auth, getSession
- All tests pass (unit and integration)

## Task Commits

Each task was committed atomically:

1. **Task 1 & 2: Simplify auth.service.ts and update exports** - `f09139c` (refactor)
   - Combined Tasks 1 and 2 since they're tightly coupled
   - Removed Context.Tag, Layer imports and usage
   - Deleted auth.mock.ts
   - Updated index.ts and auth.test.ts

2. **Task 3: Verify auth still works** - verification only, no commit needed
   - pnpm check-types: passes
   - pnpm test:unit: passes (6 tests)
   - pnpm test:integration: passes (2 tests)
   - auth.handler usage in apps/server confirmed

## Files Created/Modified

- `packages/core/src/auth/auth.service.ts` - Simplified to plain functions, removed Effect wrapper
- `packages/core/src/auth/index.ts` - Updated exports (getAuth, auth, getSession)
- `packages/core/src/auth/auth.test.ts` - Simplified to test plain functions
- `packages/core/src/auth/auth.mock.ts` - **Deleted** (only provided Effect Layer mocks)

## Decisions Made

1. **Remove Effect wrapper** - better-auth sits at HTTP boundary and is self-contained. The Effect wrapper (Context.Tag, Layer) added complexity without testability benefits since better-auth is not really mockable at the service level.

2. **Keep deferred require() for env** - Static import of @gemhog/env/server triggers env validation at module load time. Unit tests need to import auth module without triggering validation. Deferred require() solves this.

3. **Delete auth.mock.ts entirely** - The mock file only provided Effect Layer test doubles (AuthServiceTest, AuthServiceTestUnauthenticated). With the Effect wrapper removed, these are no longer needed.

4. **Keep Redacted.value() for sensitive values** - Even without the full Effect wrapper, we keep Redacted.value() for DATABASE_URL and POLAR_ACCESS_TOKEN since Effect Config provides these as Redacted<string>.

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] Static env import broke unit tests**
- **Found during:** Task 3 verification
- **Issue:** Initial implementation used static `import { env }` which triggers env validation at module load, causing unit tests to fail
- **Fix:** Changed to deferred require() pattern with type-only import
- **Files modified:** packages/core/src/auth/auth.service.ts
- **Verification:** pnpm test:unit passes
- **Committed in:** f09139c (amended into Task 1&2 commit)

---

**Total deviations:** 1 auto-fixed (blocking)
**Impact on plan:** Minor adjustment to env import pattern. Deferred require() is already an established pattern in the codebase.

## Issues Encountered

1. **Race condition with parallel agent** - Plan 03.1-03 was executing in parallel and modifying the same auth files. Files were repeatedly reset during my edits. Resolution: Waited for 03.1-03 to commit, then applied changes on top.

2. **Multiple commit attempts** - Due to the race condition, had to reset and recommit multiple times to get a clean commit state.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- Auth domain simplified and working correctly
- apps/server uses auth.handler pattern unchanged
- Ready for next plans (03.1-05 or Phase 4)
- No blockers

---
*Phase: 03.1-code-review-fixes*
*Completed: 2026-01-21*
