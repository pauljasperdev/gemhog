---
phase: 03.1-code-review-fixes
plan: 06
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/core/drizzle.config.ts
  - packages/core/package.json
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "drizzle.config.ts imports from @gemhog/env/server"
    - "drizzle.config.ts uses Redacted.value() for DATABASE_URL"
    - "dotenv dependency removed from packages/core/package.json"
  artifacts:
    - path: "packages/core/drizzle.config.ts"
      provides: "drizzle-kit config using centralized env"
      contains: "import.*@gemhog/env/server"
    - path: "packages/core/package.json"
      provides: "Package manifest without dotenv"
  key_links:
    - from: "packages/core/drizzle.config.ts"
      to: "@gemhog/env/server"
      via: "import statement"
      pattern: "import.*env.*from.*@gemhog/env/server"
---

<objective>
Fix drizzle.config.ts to use @gemhog/env/server instead of dotenv directly.

Purpose: Centralize environment variable handling - all packages should use
@gemhog/env, not dotenv directly. Output: drizzle.config.ts imports from
@gemhog/env/server, dotenv removed from packages/core </objective>

<execution_context> @~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md </execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03.1-code-review-fixes/03.1-VERIFICATION.md

# Current files

@packages/core/drizzle.config.ts @packages/core/package.json
@packages/env/src/server.ts </context>

<tasks>

<task type="auto">
  <name>Task 1: Update drizzle.config.ts to use @gemhog/env/server</name>
  <files>packages/core/drizzle.config.ts</files>
  <action>
    Replace the dotenv-based env loading with @gemhog/env/server:

    1. Remove: `import dotenv from "dotenv";`
    2. Remove: `dotenv.config({ path: "../../apps/server/.env" });`
    3. Add: `import { env } from "@gemhog/env/server";`
    4. Add: `import { Redacted } from "effect";`
    5. Change DATABASE_URL usage from `process.env.DATABASE_URL` to `Redacted.value(env.DATABASE_URL)`

    The resulting file should look like:
    ```typescript
    import { env } from "@gemhog/env/server";
    import { defineConfig } from "drizzle-kit";
    import { Redacted } from "effect";

    export default defineConfig({
      schema: "./src/*/*.sql.ts",
      out: "./src/migrations",
      dialect: "postgresql",
      dbCredentials: {
        url: Redacted.value(env.DATABASE_URL),
      },
    });
    ```

    NOTE: The reason dotenv was used before was that "@gemhog/env validates ALL server env vars" - but this is actually fine for drizzle-kit because the env vars should be set when running migrations. If env vars are missing, it will fail fast with a clear error message.

  </action>
  <verify>
    Run `pnpm check-types` from repo root - should pass (drizzle.config.ts compiles)
    Run `cd packages/core && pnpm db:generate` - should succeed if DATABASE_URL is set
  </verify>
  <done>drizzle.config.ts imports from @gemhog/env/server and uses Redacted.value(env.DATABASE_URL)</done>
</task>

<task type="auto">
  <name>Task 2: Remove dotenv from packages/core dependencies</name>
  <files>packages/core/package.json</files>
  <action>
    Remove the dotenv dependency from packages/core/package.json:

    1. Remove line: `"dotenv": "catalog:"` from dependencies section
    2. Run `pnpm install` to update lockfile

    The dotenv import is now removed from drizzle.config.ts, so this dependency is no longer needed.

  </action>
  <verify>
    Run `grep -c dotenv packages/core/package.json` - should return 0
    Run `pnpm install` - should succeed without errors
    Run `pnpm check-types` - should pass
  </verify>
  <done>dotenv dependency removed from packages/core/package.json</done>
</task>

</tasks>

<verification>
1. `grep -q "@gemhog/env/server" packages/core/drizzle.config.ts && echo "PASS: Uses @gemhog/env/server"` - should echo PASS
2. `grep -q "Redacted.value" packages/core/drizzle.config.ts && echo "PASS: Uses Redacted.value"` - should echo PASS
3. `! grep -q "dotenv" packages/core/drizzle.config.ts && echo "PASS: No dotenv import"` - should echo PASS
4. `! grep -q "dotenv" packages/core/package.json && echo "PASS: No dotenv dependency"` - should echo PASS
5. `pnpm check-types` - should exit 0
</verification>

<success_criteria>

- drizzle.config.ts imports env from @gemhog/env/server
- drizzle.config.ts uses Redacted.value() for DATABASE_URL
- dotenv completely removed from packages/core (no import, no dependency)
- TypeScript compilation passes </success_criteria>

<output>
After completion, create `.planning/phases/03.1-code-review-fixes/03.1-06-SUMMARY.md`
</output>
