---
phase: 03.1-code-review-fixes
plan: 07
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/core/src/auth/auth.service.ts
  - packages/core/package.json
  - packages/env/src/server.ts
  - apps/web/src/lib/auth-client.ts
  - apps/web/src/app/dashboard/dashboard.tsx
  - apps/web/package.json
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Auth service uses static import for @gemhog/env/server"
    - "Polar integration completely removed from auth.service.ts"
    - "Polar client removed from apps/web/src/lib/auth-client.ts"
    - "Dashboard no longer references Polar subscription features"
    - "@polar-sh packages removed from dependencies"
    - "POLAR env vars removed from packages/env"
  artifacts:
    - path: "packages/core/src/auth/auth.service.ts"
      provides: "Auth service without Polar, with static env import"
    - path: "apps/web/src/lib/auth-client.ts"
      provides: "Auth client without Polar plugin"
    - path: "apps/web/src/app/dashboard/dashboard.tsx"
      provides: "Dashboard without subscription features"
    - path: "packages/env/src/server.ts"
      provides: "Server env without POLAR vars"
  key_links:
    - from: "packages/core/src/auth/auth.service.ts"
      to: "@gemhog/env/server"
      via: "static import"
      pattern: "^import.*env.*from.*@gemhog/env/server"
---

<objective>
Complete auth cleanup: fix dynamic require() and remove all Polar integration.

Purpose:
1. Use static imports instead of dynamic require() for cleaner code
2. Remove dead Polar/payment code that was incomplete in 03.1-02

Output: Clean auth service with static imports, no Polar dependencies anywhere in codebase
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03.1-code-review-fixes/03.1-VERIFICATION.md

# Current files
@packages/core/src/auth/auth.service.ts
@packages/core/package.json
@packages/env/src/server.ts
@apps/web/src/lib/auth-client.ts
@apps/web/src/app/dashboard/dashboard.tsx
@apps/web/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove POLAR env vars from packages/env/server.ts</name>
  <files>packages/env/src/server.ts</files>
  <action>
    Remove Polar-related env var validations:

    1. Remove: `POLAR_ACCESS_TOKEN: Config.redacted("POLAR_ACCESS_TOKEN"),`
    2. Remove: `POLAR_SUCCESS_URL: Config.string("POLAR_SUCCESS_URL"),`

    The resulting ServerConfig should only have:
    - DATABASE_URL (redacted)
    - BETTER_AUTH_SECRET (redacted)
    - BETTER_AUTH_URL
    - CORS_ORIGIN
    - NODE_ENV (with default)
  </action>
  <verify>
    `grep -c POLAR packages/env/src/server.ts` should return 0
    `pnpm check-types` should pass
  </verify>
  <done>POLAR_ACCESS_TOKEN and POLAR_SUCCESS_URL removed from env validation</done>
</task>

<task type="auto">
  <name>Task 2: Rewrite auth.service.ts with static import, no Polar</name>
  <files>packages/core/src/auth/auth.service.ts</files>
  <action>
    Complete rewrite to:
    1. Replace dynamic require() with static import
    2. Remove all Polar imports and code
    3. Keep better-auth core functionality

    The new auth.service.ts should:
    ```typescript
    import { env } from "@gemhog/env/server";
    import { betterAuth } from "better-auth";
    import { drizzleAdapter } from "better-auth/adapters/drizzle";
    import { drizzle } from "drizzle-orm/node-postgres";
    import { Redacted } from "effect";
    import * as schema from "./auth.sql";

    // Create better-auth instance
    const createAuth = () => {
      const db = drizzle(Redacted.value(env.DATABASE_URL), { schema });

      return betterAuth({
        database: drizzleAdapter(db, { provider: "pg", schema }),
        trustedOrigins: [env.CORS_ORIGIN],
        emailAndPassword: { enabled: true },
        advanced: {
          defaultCookieAttributes: {
            sameSite: "none",
            secure: true,
            httpOnly: true,
          },
        },
      });
    };

    // Lazy singleton
    let _auth: ReturnType<typeof createAuth> | null = null;
    export const getAuth = () => {
      if (!_auth) {
        _auth = createAuth();
      }
      return _auth;
    };

    // Convenience proxy for backward compatibility
    type BetterAuthInstance = ReturnType<typeof betterAuth>;
    export const auth = new Proxy({} as BetterAuthInstance, {
      get(_target, prop) {
        return (getAuth() as unknown as Record<string | symbol, unknown>)[prop];
      },
    });

    // Plain async helper for getting session
    export const getSession = (headers: Headers) =>
      getAuth().api.getSession({ headers });
    ```

    Key changes:
    - Static `import { env } from "@gemhog/env/server"` at top level
    - Remove `const getEnv = () => require(...)` hack
    - Remove all @polar-sh imports
    - Remove Polar client creation
    - Remove polar plugin from betterAuth config
    - Keep plugins array empty (or remove entirely)

    NOTE: This makes the module validate env at import time. Tests that import this module will need DATABASE_URL etc set. This is acceptable because:
    - Unit tests should mock this module entirely
    - Integration tests should have env vars set
  </action>
  <verify>
    `grep -c "@polar-sh" packages/core/src/auth/auth.service.ts` should return 0
    `grep -c "require(" packages/core/src/auth/auth.service.ts` should return 0
    `grep -q "import { env } from" packages/core/src/auth/auth.service.ts` should succeed
    `pnpm check-types` should pass
  </verify>
  <done>auth.service.ts uses static import, no Polar code, no require() hack</done>
</task>

<task type="auto">
  <name>Task 3: Remove Polar from apps/web</name>
  <files>apps/web/src/lib/auth-client.ts, apps/web/src/app/dashboard/dashboard.tsx, apps/web/package.json</files>
  <action>
    1. Update auth-client.ts:
       - Remove: `import { polarClient } from "@polar-sh/better-auth";`
       - Remove: `plugins: [polarClient()],` from createAuthClient config

       Result:
       ```typescript
       import { env } from "@gemhog/env/web";
       import { createAuthClient } from "better-auth/react";

       export const authClient = createAuthClient({
         baseURL: env.NEXT_PUBLIC_SERVER_URL,
       });
       ```

    2. Update dashboard.tsx:
       - Remove customerState prop (no longer used)
       - Remove hasProSubscription logic
       - Remove subscription-related buttons
       - Remove the debug console.log (this also fixes SEC-003)

       Result:
       ```tsx
       "use client";
       import { useQuery } from "@tanstack/react-query";

       import { authClient } from "@/lib/auth-client";
       import { trpc } from "@/utils/trpc";

       export default function Dashboard({
         session: _session,
       }: {
         session: typeof authClient.$Infer.Session;
       }) {
         const privateData = useQuery(trpc.privateData.queryOptions());

         return (
           <>
             <p>API: {privateData.data?.message}</p>
           </>
         );
       }
       ```

    3. Update apps/web/package.json:
       - Remove: `"@polar-sh/better-auth": "catalog:",` from dependencies
       - Run `pnpm install` to update lockfile
  </action>
  <verify>
    `grep -c "@polar-sh" apps/web/src/lib/auth-client.ts` should return 0
    `grep -c "console.log" apps/web/src/app/dashboard/dashboard.tsx` should return 0
    `grep -c "@polar-sh" apps/web/package.json` should return 0
    `pnpm check-types` should pass
  </verify>
  <done>Polar completely removed from apps/web, debug logging removed</done>
</task>

<task type="auto">
  <name>Task 4: Remove @polar-sh packages from packages/core</name>
  <files>packages/core/package.json</files>
  <action>
    Remove Polar dependencies from packages/core/package.json:

    1. Remove: `"@polar-sh/better-auth": "catalog:",`
    2. Remove: `"@polar-sh/sdk": "^0.34.16",`
    3. Run `pnpm install` to update lockfile
  </action>
  <verify>
    `grep -c "@polar-sh" packages/core/package.json` should return 0
    `pnpm install` should succeed
    `pnpm check-types` should pass
  </verify>
  <done>@polar-sh/better-auth and @polar-sh/sdk removed from packages/core</done>
</task>

</tasks>

<verification>
1. `grep -rq "@polar-sh" packages/core packages/env apps/web/src apps/web/package.json && echo "FAIL" || echo "PASS: No @polar-sh references"` - should echo PASS
2. `grep -q "require(" packages/core/src/auth/auth.service.ts && echo "FAIL" || echo "PASS: No require() in auth.service.ts"` - should echo PASS
3. `grep -q "^import { env } from" packages/core/src/auth/auth.service.ts && echo "PASS: Static env import"` - should echo PASS
4. `grep -q "POLAR" packages/env/src/server.ts && echo "FAIL" || echo "PASS: No POLAR in env"` - should echo PASS
5. `grep -q "console.log" apps/web/src/app/dashboard/dashboard.tsx && echo "FAIL" || echo "PASS: No debug logging"` - should echo PASS
6. `pnpm check-types` - should exit 0
7. `pnpm test:unit` - should pass
</verification>

<success_criteria>
- auth.service.ts uses static `import { env } from "@gemhog/env/server"`
- No require() or dynamic imports in auth.service.ts
- All @polar-sh imports and code removed from entire codebase
- POLAR_ACCESS_TOKEN and POLAR_SUCCESS_URL removed from env validation
- Debug console.log removed from dashboard.tsx (fixes SEC-003)
- All TypeScript compilation passes
- All unit tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/03.1-code-review-fixes/03.1-07-SUMMARY.md`
</output>
