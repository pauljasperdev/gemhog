---
phase: 03.1-code-review-fixes
plan: 07
subsystem: auth
tags: [better-auth, env, static-import, polar-removal]

# Dependency graph
requires:
  - phase: 03.1-03
    provides: Effect Config env validation with @gemhog/env/server
  - phase: 03.1-04
    provides: Simplified auth service without Effect wrapper
provides:
  - Clean auth.service.ts with static env import
  - Complete Polar removal from codebase
  - Unit test env mocking pattern with vi.mock()
affects: [deployment, testing]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Static env import at module level (validates at import time)"
    - "vi.mock() for env module mocking in unit tests"

key-files:
  created: []
  modified:
    - packages/core/src/auth/auth.service.ts
    - packages/core/src/auth/auth.test.ts
    - packages/env/src/server.ts
    - apps/web/src/lib/auth-client.ts
    - apps/web/src/app/dashboard/dashboard.tsx
    - apps/web/package.json
    - packages/core/package.json

key-decisions:
  - "Static import for env validation at module load time"
  - "vi.mock() pattern for unit test env isolation"

patterns-established:
  - "Static env import: Use `import { env } from '@gemhog/env/server'` at module
    level"
  - "Unit test mocking: Use vi.mock() before importing modules that depend on
    env"

# Metrics
duration: 2min
completed: 2026-01-21
---

# Phase 3.1 Plan 07: Auth Cleanup Summary

**Complete auth cleanup: static env imports replacing require() hack, all Polar
integration removed from codebase**

## Performance

- **Duration:** 2 min
- **Started:** 2026-01-21T13:19:52Z
- **Completed:** 2026-01-21T13:20:55Z
- **Tasks:** 4
- **Files modified:** 7

## Accomplishments

- Replaced dynamic require() with static import in auth.service.ts
- Removed all @polar-sh packages and references from entire codebase
- Removed POLAR_ACCESS_TOKEN and POLAR_SUCCESS_URL from env validation
- Updated unit tests with vi.mock() pattern for env isolation

## Task Commits

Each task was committed atomically:

1. **Task 1: Remove POLAR env vars from packages/env/server.ts** - `645a2ec`
   (chore)
2. **Task 2: Rewrite auth.service.ts with static import, no Polar** - `cd2a10e`
   (refactor)
3. **Task 3: Remove Polar from apps/web** - `64d352c` (chore)
4. **Task 4: Remove @polar-sh packages from packages/core** - `86f7f07` (bundled
   with 03.1-08)

Note: Task 4 was completed as part of a prior execution pass (bundled in commit
86f7f07).

## Files Created/Modified

- `packages/core/src/auth/auth.service.ts` - Static env import, removed
  require() hack
- `packages/core/src/auth/auth.test.ts` - Added vi.mock() for env module
- `packages/env/src/server.ts` - Removed POLAR_ACCESS_TOKEN and
  POLAR_SUCCESS_URL
- `apps/web/src/lib/auth-client.ts` - Removed polarClient plugin
- `apps/web/src/app/dashboard/dashboard.tsx` - Removed subscription features and
  debug logging
- `apps/web/package.json` - Removed @polar-sh/better-auth dependency
- `packages/core/package.json` - Removed @polar-sh/better-auth and @polar-sh/sdk
  dependencies

## Decisions Made

1. **Static import for env validation** - Module loads validate env at import
   time rather than at runtime. Tests mock the env module before importing
   dependent modules.

2. **vi.mock() pattern for unit tests** - Unit tests use
   `vi.mock("@gemhog/env/server", () => ({ env: {...} }))` before importing
   modules that depend on env. This provides test isolation without requiring
   real env vars.

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] Fixed unused import in auth.test.ts**

- **Found during:** Verification
- **Issue:** `beforeAll` was imported but never used, causing TypeScript error
  TS6133
- **Fix:** Removed unused `beforeAll` import
- **Files modified:** packages/core/src/auth/auth.test.ts
- **Verification:** `pnpm check-types` passes
- **Committed in:** cd2a10e (part of Task 2 commit)

---

**Total deviations:** 1 auto-fixed (1 bug) **Impact on plan:** Minor cleanup fix
necessary for type checking. No scope creep.

## Issues Encountered

- Some work from this plan was already completed in prior execution passes
  (Tasks 1, 3, 4 had commits from earlier sessions)
- Task 2 work was present in working directory but uncommitted - committed as
  final step

## Next Phase Readiness

- Auth service is now clean with static imports
- All Polar code removed from codebase
- Unit tests properly mock env module
- Ready for plan 03.1-09 (final verification)

---

_Phase: 03.1-code-review-fixes_ _Completed: 2026-01-21_
