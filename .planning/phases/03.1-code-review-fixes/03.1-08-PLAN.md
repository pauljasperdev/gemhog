---
phase: 03.1-code-review-fixes
plan: 08
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/server/src/index.ts
  - apps/server/package.json
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "AI endpoint validates message payload with Zod schema"
    - "AI endpoint has rate limiting protection"
    - "Message count and content length are limited"
  artifacts:
    - path: "apps/server/src/index.ts"
      provides: "AI endpoint with input validation and rate limiting"
      contains: "z.array"
    - path: "apps/server/package.json"
      provides: "Server package with rate limiting dependency"
  key_links:
    - from: "apps/server/src/index.ts"
      to: "zod"
      via: "z.parse() or z.safeParse()"
      pattern: "\\.safeParse\\(|\\.parse\\("
---

<objective>
Fix security issues SEC-001 and SEC-002: Add input validation and rate limiting to AI endpoint.

Purpose: Protect AI endpoint from abuse - validate input payloads and limit request frequency
Output: AI endpoint with Zod validation for messages and rate limiting middleware
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03.1-code-review-fixes/03.1-VERIFICATION.md
@.planning/codebase/SECURITY-CHECKLIST.md

# Current files
@apps/server/src/index.ts
@apps/server/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add rate limiting dependency</name>
  <files>apps/server/package.json</files>
  <action>
    Add @hono/rate-limiter or hono-rate-limiter package for rate limiting.

    Hono has built-in rate limiting via middleware. Check if `hono` already includes it, or add a dedicated package.

    Option 1: Use Hono's built-in approach with a simple in-memory store
    Option 2: Add a rate-limiter package

    For simplicity, use in-memory rate limiting (acceptable for single-server deployment).

    If needed, add to dependencies:
    ```json
    "@hono-rate-limiter/core": "^0.3.0"
    ```

    Actually, Hono doesn't have built-in rate limiting. Create a simple in-memory rate limiter middleware directly in the code - no extra dependency needed for basic protection.

    Skip this task if implementing rate limiting inline.
  </action>
  <verify>
    `pnpm check-types` should pass
  </verify>
  <done>Rate limiting available (either via dependency or inline implementation)</done>
</task>

<task type="auto">
  <name>Task 2: Add Zod validation schema for AI messages</name>
  <files>apps/server/src/index.ts</files>
  <action>
    Add Zod schema to validate the AI endpoint payload:

    ```typescript
    import { z } from "zod";

    // Schema for AI message validation (SEC-001 fix)
    const MessageSchema = z.object({
      role: z.enum(["user", "assistant", "system"]),
      content: z.string().max(10000, "Message content too long"), // 10KB max per message
    });

    const AIRequestSchema = z.object({
      messages: z.array(MessageSchema)
        .max(50, "Too many messages") // Limit conversation history
        .min(1, "At least one message required"),
    });
    ```

    Then in the /ai endpoint:

    ```typescript
    app.post("/ai", async (c) => {
      const body = await c.req.json();

      // Validate input (SEC-001 fix)
      const parseResult = AIRequestSchema.safeParse(body);
      if (!parseResult.success) {
        return c.json(
          { error: "Invalid request", details: parseResult.error.flatten() },
          400
        );
      }

      const { messages } = parseResult.data;
      // ... rest of handler
    });
    ```
  </action>
  <verify>
    `grep -q "AIRequestSchema" apps/server/src/index.ts` should succeed
    `grep -q "safeParse" apps/server/src/index.ts` should succeed
    `pnpm check-types` should pass
  </verify>
  <done>AI endpoint validates messages with Zod schema, limits message count and content length</done>
</task>

<task type="auto">
  <name>Task 3: Add rate limiting to AI endpoint</name>
  <files>apps/server/src/index.ts</files>
  <action>
    Implement simple in-memory rate limiting for the AI endpoint:

    ```typescript
    // Simple in-memory rate limiter (SEC-002 fix)
    // For production with multiple servers, use Redis-based rate limiting
    const rateLimitStore = new Map<string, { count: number; resetTime: number }>();
    const RATE_LIMIT = 10; // requests per window
    const RATE_WINDOW = 60 * 1000; // 1 minute window

    const rateLimit = (identifier: string): boolean => {
      const now = Date.now();
      const record = rateLimitStore.get(identifier);

      if (!record || now > record.resetTime) {
        rateLimitStore.set(identifier, { count: 1, resetTime: now + RATE_WINDOW });
        return true;
      }

      if (record.count >= RATE_LIMIT) {
        return false;
      }

      record.count++;
      return true;
    };

    // Clean up old entries periodically
    setInterval(() => {
      const now = Date.now();
      for (const [key, value] of rateLimitStore.entries()) {
        if (now > value.resetTime) {
          rateLimitStore.delete(key);
        }
      }
    }, RATE_WINDOW);
    ```

    Then apply in the /ai endpoint:

    ```typescript
    app.post("/ai", async (c) => {
      // Rate limiting (SEC-002 fix)
      // Use IP as identifier (or session ID if authenticated)
      const clientId = c.req.header("x-forwarded-for") || c.req.header("x-real-ip") || "anonymous";
      if (!rateLimit(clientId)) {
        return c.json({ error: "Too many requests. Please try again later." }, 429);
      }

      // ... rest of handler (validation, AI call)
    });
    ```
  </action>
  <verify>
    `grep -q "rateLimit" apps/server/src/index.ts` should succeed
    `grep -q "429" apps/server/src/index.ts` should succeed
    `pnpm check-types` should pass
  </verify>
  <done>AI endpoint has rate limiting - 10 requests per minute per client IP</done>
</task>

</tasks>

<verification>
1. `grep -q "z.array" apps/server/src/index.ts && echo "PASS: Message array validation"` - should echo PASS
2. `grep -q "safeParse" apps/server/src/index.ts && echo "PASS: Uses safeParse"` - should echo PASS
3. `grep -q "rateLimit" apps/server/src/index.ts && echo "PASS: Rate limiting implemented"` - should echo PASS
4. `grep -q "429" apps/server/src/index.ts && echo "PASS: Returns 429 on rate limit"` - should echo PASS
5. `grep -q "400" apps/server/src/index.ts && echo "PASS: Returns 400 on validation error"` - should echo PASS
6. `pnpm check-types` - should exit 0
</verification>

<success_criteria>
- AI endpoint validates incoming messages with Zod schema
- Messages limited to 50 per request, 10KB per message
- Rate limiting protects AI endpoint (10 req/min per IP)
- Invalid requests return 400 with error details
- Rate-limited requests return 429
- TypeScript compilation passes
</success_criteria>

<output>
After completion, create `.planning/phases/03.1-code-review-fixes/03.1-08-SUMMARY.md`
</output>
