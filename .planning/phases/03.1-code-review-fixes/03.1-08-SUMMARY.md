---
phase: 03.1-code-review-fixes
plan: 08
subsystem: api
tags: [security, zod, rate-limiting, hono, ai-sdk]

# Dependency graph
requires:
  - phase: 03.1-code-review-fixes
    provides: Security review identifying SEC-001 and SEC-002
provides:
  - AI endpoint input validation with Zod schema
  - Rate limiting protection (10 req/min per IP)
  - Proper error responses (400 for validation, 429 for rate limit)
affects: [deployment, security-review]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Zod validation for AI SDK UIMessage format"
    - "In-memory rate limiting with periodic cleanup"
    - "Discriminated union for message part types"

key-files:
  created: []
  modified:
    - apps/server/src/index.ts

key-decisions:
  - "Use inline rate limiting instead of external package (simpler for single-server)"
  - "Validate UIMessage parts structure (not simple content string)"
  - "Allow unknown part types to pass through for forward compatibility"

patterns-established:
  - "Rate limit by IP with x-forwarded-for fallback"
  - "Return flattened Zod errors in 400 response"

# Metrics
duration: 4min
completed: 2026-01-21
---

# Phase 3.1 Plan 08: AI Endpoint Security Summary

**Zod validation for AI messages with rate limiting (10 req/min) - fixes SEC-001 and SEC-002**

## Performance

- **Duration:** 4 min
- **Started:** 2026-01-21T10:11:16Z
- **Completed:** 2026-01-21T10:15:09Z
- **Tasks:** 3 (combined into 1 commit)
- **Files modified:** 1

## Accomplishments

- Added Zod validation schema matching AI SDK v6 UIMessage format
- Implemented in-memory rate limiting (10 requests/minute per IP)
- Return 400 with flattened error details for invalid input
- Return 429 when rate limit exceeded
- Message count limited to 50, text parts limited to 10KB each

## Task Commits

All three tasks were implemented together as one cohesive change:

1. **Tasks 1-3: Add validation and rate limiting** - `801a00c` (fix)
   - Task 1: Rate limiting implemented inline (no extra dependency needed)
   - Task 2: Zod validation schema for UIMessage format
   - Task 3: Rate limiting middleware in /ai endpoint

**Plan metadata:** (pending)

## Files Created/Modified

- `apps/server/src/index.ts` - Added Zod schemas, rate limiter, and validation in /ai endpoint

## Decisions Made

1. **Inline rate limiting instead of package** - Simpler for single-server deployment, no external dependencies needed
2. **UIMessage parts validation** - AI SDK v6 uses `parts` array with `{type, text}` objects, not simple `{role, content}`
3. **Discriminated union for parts** - TextPartSchema, FilePartSchema, OtherPartSchema with passthrough for unknown types
4. **Fallback to "anonymous" for rate limiting** - If no IP headers present, use "anonymous" as identifier

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] Schema structure mismatch**

- **Found during:** Task 2 (Add Zod validation schema)
- **Issue:** Plan assumed simple `{role, content}` message format but AI SDK v6 uses UIMessage with `parts` array
- **Fix:** Created schema matching actual UIMessage format: `{id?, role, parts: [{type, text}], metadata?}`
- **Files modified:** apps/server/src/index.ts
- **Verification:** TypeScript compilation passes, validation works with frontend
- **Committed in:** 801a00c

---

**Total deviations:** 1 auto-fixed (blocking)
**Impact on plan:** Schema adjustment necessary for correctness - original plan used simplified format that wouldn't match actual API payloads.

## Issues Encountered

- Pre-commit hook requires Biome import organization - applied auto-fix before commit

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- SEC-001 (Input validation) - RESOLVED
- SEC-002 (Rate limiting) - RESOLVED
- AI endpoint now protected against:
  - Malformed payloads (400 error with details)
  - Request flooding (429 after 10 req/min)
  - Oversized messages (10KB limit per text part)
  - Excessive conversation history (50 message limit)

---

*Phase: 03.1-code-review-fixes*
*Completed: 2026-01-21*
