---
phase: 03.1-code-review-fixes
plan: 09
type: execute
wave: 2
depends_on: ["03.1-06", "03.1-07", "03.1-08"]
files_modified:
  - .planning/codebase/SECURITY-REVIEW.md
  - .planning/codebase/CONCERNS.md
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Security review completed for gap closure changes"
    - "SECURITY-REVIEW.md updated with new review session"
    - "All blocking security findings resolved or closed"
    - "pnpm verify passes"
  artifacts:
    - path: ".planning/codebase/SECURITY-REVIEW.md"
      provides: "Security audit trail with gap closure review"
    - path: ".planning/codebase/CONCERNS.md"
      provides: "Updated security summary counts"
  key_links:
    - from: "CONCERNS.md"
      to: "SECURITY-REVIEW.md"
      via: "Security summary reference"
      pattern: "SECURITY-REVIEW.md"
---

<objective>
Run security checklist review and full verification for gap closure changes.

Purpose: Ensure all security findings are addressed and codebase passes
verification Output: Updated SECURITY-REVIEW.md with gap closure review, all
tests passing </objective>

<execution_context> @~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md </execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/SECURITY-CHECKLIST.md
@.planning/codebase/SECURITY-REVIEW.md
@.planning/codebase/CONCERNS.md

# Gap closure plan summaries (will exist after wave 1)

@.planning/phases/03.1-code-review-fixes/03.1-06-SUMMARY.md
@.planning/phases/03.1-code-review-fixes/03.1-07-SUMMARY.md
@.planning/phases/03.1-code-review-fixes/03.1-08-SUMMARY.md </context>

<tasks>

<task type="auto">
  <name>Task 1: Run full verification pipeline</name>
  <files>none (command only)</files>
  <action>
    Run the complete verification pipeline to ensure all changes work together:

    ```bash
    pnpm db:start && pnpm verify
    ```

    This runs:
    - Static analysis (Biome lint + TypeScript type check)
    - Unit tests
    - Integration tests
    - E2E tests
    - Dependency security audit

    If any step fails, investigate and note the issue. The gap closure plans should have fixed all issues.

  </action>
  <verify>
    `pnpm verify` exits 0
  </verify>
  <done>Full verification pipeline passes</done>
</task>

<task type="auto">
  <name>Task 2: Run security checklist review</name>
  <files>.planning/codebase/SECURITY-REVIEW.md</files>
  <action>
    Follow the security review workflow from SECURITY-CHECKLIST.md:

    1. Determine scope (files changed in 03.1-06, 03.1-07, 03.1-08):
       - packages/core/drizzle.config.ts
       - packages/core/src/auth/auth.service.ts
       - packages/core/package.json
       - packages/env/src/server.ts
       - apps/web/src/lib/auth-client.ts
       - apps/web/src/app/dashboard/dashboard.tsx
       - apps/web/package.json
       - apps/server/src/index.ts

    2. Run dependency audit:
       ```bash
       pnpm security:audit
       ```

    3. Review code against relevant checklist categories:
       - Input Validation (SEC-001 should be fixed)
       - Rate Limiting (SEC-002 should be fixed)
       - Logging (SEC-003 should be fixed)
       - Secrets Management (verify env handling)
       - Authentication (verify auth service changes)

    4. Update SECURITY-REVIEW.md:
       - Add new review session at TOP of file (most recent first)
       - Mark SEC-001, SEC-002, SEC-003 as FIXED
       - Update Current Status Summary counts
       - Also close SEC-004 and SEC-005 (Polar code removed, no longer applicable)

    New review session template:
    ```markdown
    ## Review: 2026-01-21 - Gap Closure (03.1-06 through 03.1-09)

    **Reviewer:** Claude (agent)
    **Commit:** Gap closure plans addressing VERIFICATION.md findings
    **Scope:**
    - packages/core/drizzle.config.ts (env import change)
    - packages/core/src/auth/auth.service.ts (static import, Polar removal)
    - packages/env/src/server.ts (POLAR vars removed)
    - apps/web/src/lib/auth-client.ts (Polar removal)
    - apps/web/src/app/dashboard/dashboard.tsx (debug logging removed, Polar removal)
    - apps/server/src/index.ts (validation and rate limiting added)

    ### Dependency Audit

    [output of pnpm security:audit]

    ### Files Reviewed

    | File | Categories Checked | Result |
    |------|-------------------|--------|
    | apps/server/src/index.ts | Input Validation, Rate Limiting | PASS |
    | ... | ... | ... |

    ### Findings Resolved

    #### [SEC-001] High - Missing input validation on AI endpoint
    - **Status:** FIXED (03.1-08)
    - **Fix:** Added Zod schema validation for message array, limits on count and content length

    #### [SEC-002] High - No rate limiting
    - **Status:** FIXED (03.1-08)
    - **Fix:** Added in-memory rate limiter, 10 requests per minute per client IP

    #### [SEC-003] Medium - Debug logging exposes data
    - **Status:** FIXED (03.1-07)
    - **Fix:** Removed console.log from dashboard.tsx

    #### [SEC-004] Medium - Hardcoded placeholder productId
    - **Status:** CLOSED (03.1-07)
    - **Reason:** Polar integration removed entirely, code no longer exists

    #### [SEC-005] Low - Polar sandbox mode hardcoded
    - **Status:** CLOSED (03.1-07)
    - **Reason:** Polar integration removed entirely, code no longer exists

    ### Summary

    | Severity | Count | Status |
    |----------|-------|--------|
    | Critical | 0 | - |
    | High | 0 | - |
    | Medium | 0 | - |
    | Low | 0 | - |

    ### Sign-off

    - [x] Checked for pre-existing blocking findings (all resolved)
    - [x] Dependency audit passed
    - [x] All Critical/High/Medium resolved
    - [x] Ready for completion
    ```

    Update the "Current Status Summary" section at the top to reflect:
    - Critical: 0 Open, 0 Fixed
    - High: 0 Open, 2 Fixed
    - Medium: 0 Open, 2 Fixed
    - Low: 0 Open, 1 Closed (N/A)
    - Blocking findings exist: NO

  </action>
  <verify>
    `grep -q "FIXED" .planning/codebase/SECURITY-REVIEW.md` should succeed
    `grep -q "Blocking findings exist: NO" .planning/codebase/SECURITY-REVIEW.md` should succeed
  </verify>
  <done>SECURITY-REVIEW.md updated with gap closure review, all findings resolved</done>
</task>

<task type="auto">
  <name>Task 3: Update CONCERNS.md security summary</name>
  <files>.planning/codebase/CONCERNS.md</files>
  <action>
    Update the security summary in CONCERNS.md to reflect resolved findings:

    1. Update the summary table:
       ```markdown
       | Severity | Open | Fixed |
       |----------|------|-------|
       | Critical | 0 | 0 |
       | High | 0 | 2 |
       | Medium | 0 | 2 |
       | Low | 0 | 0 |
       ```

    2. Update "Blocking findings exist:" to NO

    3. Remove or update the "Open findings" list - all are now resolved

    4. Remove the Polar-related tech debt items:
       - "Hardcoded Polar product ID" - no longer applicable
       - "Hardcoded sandbox environment" - no longer applicable

    5. Update timestamp: "Last synced from SECURITY-REVIEW.md: 2026-01-21"

  </action>
  <verify>
    `grep -q "Blocking findings exist: NO" .planning/codebase/CONCERNS.md` should succeed
    `grep -q "High | 0 | 2" .planning/codebase/CONCERNS.md` should succeed
  </verify>
  <done>CONCERNS.md security summary updated, reflects all findings resolved</done>
</task>

</tasks>

<verification>
1. `pnpm verify` - should exit 0 (all tests pass)
2. `grep -q "Blocking findings exist: NO" .planning/codebase/SECURITY-REVIEW.md` - should succeed
3. `grep -q "Blocking findings exist: NO" .planning/codebase/CONCERNS.md` - should succeed
4. `grep -q "SEC-001.*FIXED" .planning/codebase/SECURITY-REVIEW.md` - should succeed
5. `grep -q "SEC-002.*FIXED" .planning/codebase/SECURITY-REVIEW.md` - should succeed
6. `grep -q "SEC-003.*FIXED" .planning/codebase/SECURITY-REVIEW.md` - should succeed
</verification>

<success_criteria>

- pnpm verify passes (static analysis, unit tests, integration tests, E2E tests,
  security audit)
- SECURITY-REVIEW.md has new review session documenting gap closure
- All 5 security findings marked as FIXED or CLOSED
- "Blocking findings exist: NO" in both SECURITY-REVIEW.md and CONCERNS.md
- Security summary counts updated in CONCERNS.md </success_criteria>

<output>
After completion, create `.planning/phases/03.1-code-review-fixes/03.1-09-SUMMARY.md`
</output>
