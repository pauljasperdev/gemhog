---
phase: 03.2-code-quality-tdd-practices
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/env/src/server.test.ts
  - packages/env/src/web.test.ts
autonomous: true

must_haves:
  truths:
    - "Unit tests verify server env schema fails when required vars missing"
    - "Unit tests verify web env schema fails when NEXT_PUBLIC_SERVER_URL
      missing"
    - "Unit tests verify schemas pass with all required vars"
  artifacts:
    - path: "packages/env/src/server.test.ts"
      provides: "Server env schema validation tests"
      min_lines: 40
    - path: "packages/env/src/web.test.ts"
      provides: "Web env schema validation tests"
      min_lines: 20
  key_links:
    - from: "packages/env/src/server.test.ts"
      to: "Effect Config"
      via: "ConfigProvider.fromMap for isolated testing"
      pattern: "ConfigProvider\\.fromMap"
---

<objective>
Add unit tests for env schema validation in packages/env.

Purpose: Verify that the Effect Config schemas correctly fail when required
environment variables are missing, and succeed when all required vars are
provided. This catches env configuration errors at test time rather than
runtime.

Output: `packages/env/src/server.test.ts` and `packages/env/src/web.test.ts`
with comprehensive schema validation tests. </objective>

<execution_context> @~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md </execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03.2-code-quality-tdd-practices/03.2-RESEARCH.md
@packages/env/src/server.ts
@packages/env/src/web.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create server env schema validation tests</name>
  <files>packages/env/src/server.test.ts</files>
  <action>
Create `packages/env/src/server.test.ts` with unit tests for the ServerConfig schema.

Use Effect ConfigProvider.fromMap to provide isolated env vars without touching
process.env.

Test cases:

1. Fails when DATABASE_URL is missing
2. Fails when BETTER_AUTH_SECRET is missing
3. Fails when BETTER_AUTH_URL is missing
4. Fails when CORS_ORIGIN is missing
5. Succeeds with all required vars
6. NODE_ENV defaults to "development" when not provided
7. Redacted values are properly wrapped (DATABASE_URL, BETTER_AUTH_SECRET)

Important: Do NOT import from `./server.ts` directly - that would trigger
validation with real env vars. Instead, recreate the Config definition in the
test file for isolated testing.

Pattern from RESEARCH.md:

```typescript
import { Config, ConfigProvider, Effect } from "effect";
import { describe, expect, it } from "vitest";

// Recreate config definition for isolated testing
const ServerConfig = Config.all({
  DATABASE_URL: Config.redacted("DATABASE_URL"),
  // ... etc
});

describe("ServerConfig schema", () => {
  it("should fail when DATABASE_URL is missing", async () => {
    const provider = ConfigProvider.fromMap(
      new Map([
        // all vars except DATABASE_URL
      ]),
    );
    await expect(
      Effect.runPromise(ServerConfig.pipe(Effect.withConfigProvider(provider))),
    ).rejects.toThrow();
  });
});
```

  </action>
  <verify>
Run: `pnpm test:unit -- --run packages/env/src/server.test.ts`
All tests should pass.
  </verify>
  <done>Server env schema has unit tests covering all required vars and defaults</done>
</task>

<task type="auto">
  <name>Task 2: Create web env schema validation tests</name>
  <files>packages/env/src/web.test.ts</files>
  <action>
Create `packages/env/src/web.test.ts` with unit tests for the WebConfig schema.

Test cases:

1. Fails when NEXT_PUBLIC_SERVER_URL is missing
2. Succeeds when NEXT_PUBLIC_SERVER_URL is provided

Pattern same as Task 1, but for WebConfig:

```typescript
const WebConfig = Config.all({
  NEXT_PUBLIC_SERVER_URL: Config.string("NEXT_PUBLIC_SERVER_URL"),
});
```

  </action>
  <verify>
Run: `pnpm test:unit -- --run packages/env/src/web.test.ts`
All tests should pass.
  </verify>
  <done>Web env schema has unit tests covering required vars</done>
</task>

</tasks>

<verification>
After both tasks:
1. `pnpm test:unit -- --run packages/env/` runs both test files
2. All tests pass
3. `pnpm check-types` passes (test files have no type errors)
</verification>

<success_criteria>

- packages/env/src/server.test.ts exists with 7+ test cases
- packages/env/src/web.test.ts exists with 2+ test cases
- All unit tests pass
- Tests use ConfigProvider.fromMap for isolation (not process.env)
  </success_criteria>

<output>
After completion, create `.planning/phases/03.2-code-quality-tdd-practices/03.2-02-SUMMARY.md`
</output>
