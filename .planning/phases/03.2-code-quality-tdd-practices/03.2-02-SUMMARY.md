---
phase: 03.2-code-quality-tdd-practices
plan: 02
subsystem: testing
tags: [effect, config, vitest, env-validation, unit-tests]

# Dependency graph
requires:
  - phase: 03.1
    provides: Effect Config env validation (packages/env)
provides:
  - Unit tests for server env schema validation
  - Unit tests for web env schema validation
  - ConfigProvider.fromMap isolated testing pattern
affects: [env-changes, config-validation, ci-pipeline]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - Effect ConfigProvider.fromMap for isolated testing
    - Redacted value assertion pattern

key-files:
  created:
    - packages/env/src/server.test.ts
    - packages/env/src/web.test.ts
  modified: []

key-decisions:
  - "Recreate Config definition in tests rather than importing from source (avoids env validation at import)"
  - "Use ConfigProvider.fromMap for isolated testing without touching process.env"

patterns-established:
  - "Effect Config schema testing: Create ConfigProvider from Map, run Effect with provider, assert success/failure"
  - "Redacted value testing: Use Redacted.isRedacted() and Redacted.value() for assertions"

# Metrics
duration: 3min
completed: 2026-01-21
---

# Phase 03.2 Plan 02: Env Schema Validation Tests Summary

**Unit tests for Effect Config env schemas using ConfigProvider.fromMap for isolated testing**

## Performance

- **Duration:** 3 min
- **Started:** 2026-01-21T19:20:04Z
- **Completed:** 2026-01-21T19:23:51Z
- **Tasks:** 2
- **Files created:** 2

## Accomplishments

- Created server.test.ts with 9 test cases covering all required vars and redacted value handling
- Created web.test.ts with 2 test cases (previously committed by another plan, verified existing)
- Established Effect ConfigProvider.fromMap pattern for isolated env testing
- All tests pass without requiring real environment variables

## Task Commits

Each task was committed atomically:

1. **Task 1: Create server env schema validation tests** - `aa3d392` (test)
2. **Task 2: Create web env schema validation tests** - Already committed by 03.2-03 in `83ff640`
3. **Fix formatting for verification** - `222b7c2` (style)

Note: web.test.ts was discovered to already be committed by plan 03.2-03. Task 2 verified the existing implementation meets requirements. Additional formatting fixes were needed for web.ts, web.test.ts, and planning intel files.

## Files Created/Modified

- `packages/env/src/server.test.ts` (141 lines) - 9 tests: 4 for missing required vars, 3 for valid config, 2 for redacted values
- `packages/env/src/web.test.ts` (37 lines) - 2 tests: 1 for missing NEXT_PUBLIC_SERVER_URL, 1 for success case

## Decisions Made

- **Recreate Config definition in tests:** Importing from ./server.ts or ./web.ts would trigger validation with real env vars. Recreating the Config.all() definition in tests enables isolated testing.
- **ConfigProvider.fromMap pattern:** Creates a provider from a plain Map object, enabling precise control over which env vars are "present" for each test without modifying process.env.

## Deviations from Plan

None - plan executed exactly as written.

Note: web.test.ts was found to already exist (committed by plan 03.2-03). This is not a deviation but a parallel execution artifact. The existing implementation matches the plan requirements.

## Issues Encountered

- Initial commit (372537f) did not include server.test.ts due to pre-staged changes from another session. Resolved by re-staging and committing correctly.
- Discovered web.test.ts was already committed by plan 03.2-03 - verified it meets requirements rather than overwriting.
- Formatting issues in web.ts, web.test.ts (from another session's changes) and intel JSON files caused `pnpm verify` to fail. Fixed with Biome formatting.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- All env schema validation tests in place
- Tests can be run with `pnpm test:unit -- --run packages/env/`
- Ready for integration tests of startup failure on missing env vars (if planned)

---
*Phase: 03.2-code-quality-tdd-practices*
*Completed: 2026-01-21*
