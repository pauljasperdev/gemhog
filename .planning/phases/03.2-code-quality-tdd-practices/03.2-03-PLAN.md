---
phase: 03.2-code-quality-tdd-practices
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/tests/e2e/fixtures.ts
  - apps/web/tests/e2e/home.e2e.test.ts
autonomous: true

must_haves:
  truths:
    - "E2E tests fail when page has console errors"
    - "E2E tests fail when page has JavaScript exceptions"
    - "E2E tests capture real application errors, not just URL checks"
  artifacts:
    - path: "apps/web/tests/e2e/fixtures.ts"
      provides: "Playwright test fixture with error detection"
      exports: ["test", "expect"]
      min_lines: 25
    - path: "apps/web/tests/e2e/home.e2e.test.ts"
      provides: "E2E tests using error-detecting fixture"
      contains: "from \"./fixtures\""
  key_links:
    - from: "apps/web/tests/e2e/home.e2e.test.ts"
      to: "apps/web/tests/e2e/fixtures.ts"
      via: "import { test, expect }"
      pattern: "from \"\\./fixtures\""
---

<objective>
Add E2E test fixture that detects page errors and console errors.

Purpose: Current E2E tests only check URL/visibility and pass even when the app has runtime errors. This fixture captures console.error and page exceptions, failing the test when errors occur. This follows TDD - tests should fail first to capture regressions.

Output: `apps/web/tests/e2e/fixtures.ts` with error-detecting test fixture, and updated `home.e2e.test.ts` using the fixture.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03.2-code-quality-tdd-practices/03.2-RESEARCH.md
@apps/web/tests/e2e/home.e2e.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Playwright test fixture with error detection</name>
  <files>apps/web/tests/e2e/fixtures.ts</files>
  <action>
Create `apps/web/tests/e2e/fixtures.ts` that extends Playwright's base test with error detection.

The fixture should:
1. Collect all console.error messages via `page.on("console")`
2. Collect all page exceptions via `page.on("pageerror")`
3. After each test completes, assert that the errors array is empty
4. Export both `test` and `expect` for use by test files

Implementation from RESEARCH.md:
```typescript
import { test as base, expect } from "@playwright/test";

export const test = base.extend({
  page: async ({ page }, use) => {
    const errors: string[] = [];

    page.on("console", (msg) => {
      if (msg.type() === "error") {
        errors.push(`[console] ${msg.text()}`);
      }
    });

    page.on("pageerror", (error) => {
      errors.push(`[page] ${error.message}`);
    });

    await use(page);

    expect(errors, "No page errors expected").toStrictEqual([]);
  },
});

export { expect };
```

Note: Some console errors may be expected (e.g., Next.js hydration warnings in dev). If needed, add filtering for known acceptable errors, but start strict and loosen only if false positives appear.
  </action>
  <verify>
Run: `ls apps/web/tests/e2e/fixtures.ts` - file exists
Check: File exports `test` and `expect`
  </verify>
  <done>Error-detecting Playwright fixture created</done>
</task>

<task type="auto">
  <name>Task 2: Update E2E tests to use error-detecting fixture</name>
  <files>apps/web/tests/e2e/home.e2e.test.ts</files>
  <action>
Update `apps/web/tests/e2e/home.e2e.test.ts` to import from the new fixtures file.

Changes:
1. Replace `import { expect, test } from "@playwright/test"` with `import { test, expect } from "./fixtures"`
2. Remove the outdated comment `// apps/web/tests/e2e/home.spec.ts` (old filename)
3. Optionally add a comment explaining that the fixture detects errors

The existing test logic stays the same - the fixture handles error detection automatically.

After this change, if the app has console errors or page exceptions when navigating to "/", the test will fail.

TDD note: If the test fails after this change, that's CORRECT behavior - it means we've captured a real regression. The fix would be in app code, not the test.
  </action>
  <verify>
Run: `pnpm test:e2e` - tests run (may fail if app has errors - that's expected TDD behavior)
Check: Test file imports from "./fixtures" not "@playwright/test"
  </verify>
  <done>E2E tests use error-detecting fixture</done>
</task>

</tasks>

<verification>
After both tasks:
1. `apps/web/tests/e2e/fixtures.ts` exists and exports test/expect
2. `apps/web/tests/e2e/home.e2e.test.ts` imports from "./fixtures"
3. `pnpm test:e2e` runs (pass or fail based on app errors)
4. If test fails, the failure message includes captured errors

TDD expectation: The test MAY fail after these changes. That's correct - we're capturing real errors. The fix belongs in application code, not test code.
</verification>

<success_criteria>
- fixtures.ts created with page error detection
- home.e2e.test.ts uses the fixture
- E2E test runner executes without configuration errors
- If app has errors, test fails with descriptive error messages
</success_criteria>

<output>
After completion, create `.planning/phases/03.2-code-quality-tdd-practices/03.2-03-SUMMARY.md`

Note in summary: If E2E tests now fail due to app errors, this is INTENDED. The test is working correctly by detecting errors. Document what errors are captured so they can be fixed in a follow-up task.
</output>
