---
phase: 03.2-code-quality-tdd-practices
plan: 05
subsystem: testing
tags: [vitest, integration-tests, process-spawn, env-validation, effect-config]

# Dependency graph
requires:
  - phase: 03.1-03
    provides: Effect Config env validation in packages/env
  - phase: 03.2-02
    provides: Unit tests for env schema validation
provides:
  - Server startup failure integration tests (4 env vars)
  - Web build failure integration test (NEXT_PUBLIC_SERVER_URL)
  - Process spawn pattern for startup validation testing
affects: [deployment, ci-cd, env-docs]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - Process spawn for startup integration tests
    - Temp directory with symlinks to bypass .env file loading

key-files:
  created:
    - apps/server/src/startup.int.test.ts
    - apps/web/src/startup.int.test.ts
  modified: []

key-decisions:
  - "Use tsx from local node_modules/.bin for server startup"
  - "Use temp directory with symlinks to bypass Next.js .env loading"

patterns-established:
  - "Startup integration tests: spawn actual process, verify non-zero exit on missing env"
  - "Next.js env testing: symlink project without .env to temp dir"

# Metrics
duration: 6min
completed: 2026-01-21
---

# Phase 3.2 Plan 5: Startup Failure Integration Tests Summary

**Process-level integration tests verifying server and web apps fail fast when required env vars are missing**

## Performance

- **Duration:** 6 min
- **Started:** 2026-01-21T19:29:29Z
- **Completed:** 2026-01-21T19:35:44Z
- **Tasks:** 2
- **Files modified:** 2

## Accomplishments

- Server startup integration tests verify failure for DATABASE_URL, BETTER_AUTH_SECRET, BETTER_AUTH_URL, CORS_ORIGIN
- Web build integration test verifies failure for NEXT_PUBLIC_SERVER_URL
- Tests spawn actual processes (tsx, next build) - not mocked unit tests
- Error output assertions confirm the missing variable name appears in stderr

## Task Commits

Each task was committed atomically:

1. **Task 1: Create server startup failure integration test** - `7f644f2` (test)
2. **Task 2: Create web startup failure integration test** - `45aee11` (test)

## Files Created/Modified

- `apps/server/src/startup.int.test.ts` - Spawns tsx process with missing env vars, verifies non-zero exit codes (78 lines, 4 tests)
- `apps/web/src/startup.int.test.ts` - Creates temp dir with symlinks, spawns next build, verifies failure (98 lines, 1 test)

## Decisions Made

1. **Use tsx from local node_modules/.bin** - The spawned process needs PATH but tsx isn't globally available; use workspace-hoisted local binary
2. **Use temp directory with symlinks for web test** - Next.js automatically reads .env files from cwd; symlink all files except .env to temp directory to test missing env scenario

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

1. **tsx not found in spawned process** - Initial attempt used `npx tsx` which failed because the spawned shell had limited PATH. Resolved by using direct path to `node_modules/.bin/tsx`.

2. **Next.js reads .env files automatically** - Initial web test passed because Next.js loaded NEXT_PUBLIC_SERVER_URL from apps/web/.env. Resolved by creating temp directory with symlinks to all project files except .env.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- All 5 plans in Phase 3.2 are complete
- Full verification pipeline passes (static, unit, integration, e2e, security audit)
- Ready to proceed to Phase 4 (Deployment Infrastructure)

---
*Phase: 03.2-code-quality-tdd-practices*
*Completed: 2026-01-21*
