---
phase: 03.2-code-quality-tdd-practices
plan: 06
subsystem: env
tags: [effect-ts, config, validation, next.js]

# Dependency graph
requires:
  - phase: 03.1-code-review-fixes
    provides: Effect Config pattern for server env validation
provides:
  - Documented why Effect Config cannot be used for web.ts
  - Confirmed plain function approach is correct for Next.js client code
affects: []

# Tech tracking
tech-stack:
  added: []
  patterns: [direct-process-env-for-nextjs-client]

key-files:
  created: []
  modified:
    - packages/env/src/web.ts
    - packages/env/src/web.test.ts

key-decisions:
  - "Effect Config cannot be used for web.ts - Next.js client code needs direct process.env access"
  - "Plain getEnv() function is correct approach for NEXT_PUBLIC_* variables"

patterns-established:
  - "server.ts: Effect Config.all (server-only code)"
  - "web.ts: plain function with direct process.env (client+server code)"

# Metrics
duration: 7min
completed: 2026-01-22
---

# Phase 3.2 Plan 06: Gap Closure Investigation Summary

**Effect Config cannot be used for web.ts - Next.js requires direct process.env.NEXT_PUBLIC_* access for build-time inlining**

## Performance

- **Duration:** 7 min
- **Started:** 2026-01-22T11:26:00Z
- **Completed:** 2026-01-22T11:33:00Z
- **Tasks:** 3 + 1 fix
- **Files modified:** 2

## Accomplishments

- Investigated why Effect Config doesn't work for web.ts
- Confirmed the original plain function implementation was correct
- Documented the technical reason in code comments
- All tests pass (unit, integration, E2E)

## Task Commits

1. **Task 1: Attempt Effect Config in web.ts** - `45f9421` (refactor)
2. **Task 2: Update web.test.ts to use ConfigProvider** - `b62604a` (test)
3. **Task 3: Verify full test suite** - Failed (E2E tests broke)
4. **Fix: Revert to plain function** - `a19ec96` (fix)

**Plan metadata:** `a4fb221` (docs: complete plan)

## Files Created/Modified

- `packages/env/src/web.ts` - Kept plain getEnv() function (Effect Config breaks E2E)
- `packages/env/src/web.test.ts` - Kept process.env manipulation pattern

## Decisions Made

1. **Effect Config CANNOT be used for web.ts** - The plan's assumption was incorrect. Effect Config reads from `process.env` at runtime, but Next.js client-side code runs in the browser where `process.env` doesn't exist. The browser-bundled code throws an error at import time.

2. **Plain function with direct process.env is correct** - Next.js specifically looks for `process.env.NEXT_PUBLIC_*` patterns and inlines them at build time. Effect's Config module uses its own mechanism that doesn't get this special treatment.

3. **Asymmetric patterns are intentional** - server.ts uses Effect Config because it only runs on the server. web.ts uses plain function because it runs in both server and browser contexts.

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] Effect Config breaks E2E tests**
- **Found during:** Task 3 (Verify full test suite)
- **Issue:** E2E tests failed with "Missing data at NEXT_PUBLIC_SERVER_URL" error in browser
- **Root cause:** Effect Config reads process.env at runtime, but browser doesn't have process.env
- **Fix:** Reverted web.ts to plain getEnv() function with direct process.env access
- **Files modified:** packages/env/src/web.ts, packages/env/src/web.test.ts
- **Verification:** All E2E tests pass
- **Committed in:** `a19ec96`

---

**Total deviations:** 1 auto-fixed (bug fix)
**Impact on plan:** Plan objective was based on incorrect assumption. The original implementation was correct.

## Issues Encountered

The plan was created based on a misunderstanding. The comment in web.ts was actually correct - Effect Config doesn't work for Next.js client-side code. The asymmetry between server.ts and web.ts is intentional and correct:

- **server.ts** - Server-only code, can use Effect Config
- **web.ts** - Client+server code, must use direct process.env for Next.js inlining

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- Gap closure complete (confirmed original implementation was correct)
- All tests pass (unit, integration, E2E)
- Ready for Phase 4 (Deployment Infrastructure)

---
*Phase: 03.2-code-quality-tdd-practices*
*Plan: 06 (gap closure)*
*Completed: 2026-01-22*
