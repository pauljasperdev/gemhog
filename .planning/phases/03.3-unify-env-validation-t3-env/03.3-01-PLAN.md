---
phase: 03.3-unify-env-validation-t3-env
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/env/package.json
  - packages/env/src/server.ts
  - packages/env/src/server.test.ts
  - packages/core/src/auth/auth.service.ts
  - packages/core/drizzle.config.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Server env validates at import time using t3-env"
    - "Missing required env var throws descriptive error"
    - "NODE_ENV defaults to 'development' when not set"
    - "Consumers access env vars as plain strings (no Redacted.value())"
  artifacts:
    - path: "packages/env/src/server.ts"
      provides: "Server env validation with t3-env"
      exports: ["env", "ServerEnv"]
    - path: "packages/env/src/server.test.ts"
      provides: "Unit tests for server env schema"
      contains: "vi.resetModules"
    - path: "packages/core/src/auth/auth.service.ts"
      provides: "Auth service without Redacted.value()"
      contains: "env.DATABASE_URL"
    - path: "packages/core/drizzle.config.ts"
      provides: "Drizzle config without Redacted.value()"
      contains: "url: env.DATABASE_URL"
  key_links:
    - from: "packages/env/src/server.ts"
      to: "@t3-oss/env-core"
      via: "createEnv import"
      pattern: "createEnv.*@t3-oss/env-core"
    - from: "packages/core/src/auth/auth.service.ts"
      to: "packages/env/src/server.ts"
      via: "env import"
      pattern: "from.*@gemhog/env/server"
---

<objective>
Replace Effect Config with t3-env in server.ts and update all consumers.

Purpose: Unify env validation approach (t3-env for both server and web), removing Effect Config dependency from packages/env.

Output: server.ts using @t3-oss/env-core, tests using vi.resetModules pattern, consumers accessing env vars as plain strings.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Research
@.planning/phases/03.3-unify-env-validation-t3-env/03.3-RESEARCH.md

# Current implementation
@packages/env/package.json
@packages/env/src/server.ts
@packages/env/src/server.test.ts
@packages/core/src/auth/auth.service.ts
@packages/core/drizzle.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update dependencies and implement server.ts with t3-env</name>
  <files>
    packages/env/package.json
    packages/env/src/server.ts
  </files>
  <action>
1. Update packages/env/package.json:
   - Remove "effect" from dependencies
   - Add "@t3-oss/env-core": "^0.13.10"
   - Add "zod": "catalog:" (already in pnpm catalog as ^4.1.13)
   - Keep "dotenv": "catalog:"

2. Replace packages/env/src/server.ts with t3-env implementation:
```typescript
import "dotenv/config";
import { createEnv } from "@t3-oss/env-core";
import { z } from "zod";

export const env = createEnv({
  server: {
    DATABASE_URL: z.string().min(1),
    BETTER_AUTH_SECRET: z.string().min(32),
    BETTER_AUTH_URL: z.url(),
    CORS_ORIGIN: z.url(),
    NODE_ENV: z
      .enum(["development", "production", "test"])
      .default("development"),
  },
  runtimeEnv: process.env,
  emptyStringAsUndefined: true,
});

export type ServerEnv = typeof env;
```

Note: No redaction (t3-env does not support it). Server vars are never exposed to client - acceptable tradeoff per RESEARCH.md.
  </action>
  <verify>
Run `pnpm install` to update lockfile. Verify no TypeScript errors with `pnpm check-types`.
  </verify>
  <done>
packages/env uses @t3-oss/env-core, effect dependency removed, server.ts validates with Zod schemas.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update server tests and consumers</name>
  <files>
    packages/env/src/server.test.ts
    packages/core/src/auth/auth.service.ts
    packages/core/drizzle.config.ts
  </files>
  <action>
1. Rewrite packages/env/src/server.test.ts to use vi.resetModules pattern:
```typescript
import { afterEach, beforeEach, describe, expect, it, vi } from "vitest";

describe("server env validation", () => {
  const originalEnv = process.env;

  beforeEach(() => {
    vi.resetModules();
    process.env = { ...originalEnv };
  });

  afterEach(() => {
    process.env = originalEnv;
  });

  describe("missing required vars", () => {
    it("should fail when DATABASE_URL is missing", async () => {
      delete process.env.DATABASE_URL;
      await expect(import("./server.js")).rejects.toThrow();
    });

    it("should fail when BETTER_AUTH_SECRET is missing", async () => {
      delete process.env.BETTER_AUTH_SECRET;
      await expect(import("./server.js")).rejects.toThrow();
    });

    it("should fail when BETTER_AUTH_URL is missing", async () => {
      delete process.env.BETTER_AUTH_URL;
      await expect(import("./server.js")).rejects.toThrow();
    });

    it("should fail when CORS_ORIGIN is missing", async () => {
      delete process.env.CORS_ORIGIN;
      await expect(import("./server.js")).rejects.toThrow();
    });
  });

  describe("valid config", () => {
    it("should succeed with all required vars", async () => {
      process.env.DATABASE_URL = "postgresql://localhost:5432/test";
      process.env.BETTER_AUTH_SECRET = "super-secret-key-at-least-32-chars";
      process.env.BETTER_AUTH_URL = "http://localhost:3000";
      process.env.CORS_ORIGIN = "http://localhost:3001";

      const { env } = await import("./server.js");

      expect(env.BETTER_AUTH_URL).toBe("http://localhost:3000");
      expect(env.CORS_ORIGIN).toBe("http://localhost:3001");
    });

    it("should default NODE_ENV to 'development' when not provided", async () => {
      process.env.DATABASE_URL = "postgresql://localhost:5432/test";
      process.env.BETTER_AUTH_SECRET = "super-secret-key-at-least-32-chars";
      process.env.BETTER_AUTH_URL = "http://localhost:3000";
      process.env.CORS_ORIGIN = "http://localhost:3001";
      delete process.env.NODE_ENV;

      const { env } = await import("./server.js");

      expect(env.NODE_ENV).toBe("development");
    });

    it("should use provided NODE_ENV when specified", async () => {
      process.env.DATABASE_URL = "postgresql://localhost:5432/test";
      process.env.BETTER_AUTH_SECRET = "super-secret-key-at-least-32-chars";
      process.env.BETTER_AUTH_URL = "http://localhost:3000";
      process.env.CORS_ORIGIN = "http://localhost:3001";
      process.env.NODE_ENV = "production";

      const { env } = await import("./server.js");

      expect(env.NODE_ENV).toBe("production");
    });
  });
});
```

2. Update packages/core/src/auth/auth.service.ts:
   - Remove `import { Redacted } from "effect";`
   - Change `Redacted.value(env.DATABASE_URL)` to `env.DATABASE_URL`

3. Update packages/core/drizzle.config.ts:
   - Remove `import { Redacted } from "effect";`
   - Change `Redacted.value(env.DATABASE_URL)` to `env.DATABASE_URL`
  </action>
  <verify>
Run `pnpm test:unit` to verify server.test.ts passes. Run `pnpm check-types` to verify no TypeScript errors.
  </verify>
  <done>
Server tests use vi.resetModules pattern, auth.service.ts and drizzle.config.ts no longer use Redacted.value().
  </done>
</task>

</tasks>

<verification>
1. `pnpm install` - lockfile updated
2. `pnpm check-types` - no TypeScript errors
3. `pnpm test:unit` - server.test.ts passes (6 tests)
4. `grep -r "Redacted" packages/core/` - no matches
5. `grep "effect" packages/env/package.json` - no matches
</verification>

<success_criteria>
- packages/env/package.json has @t3-oss/env-core, zod, dotenv (no effect)
- server.ts uses createEnv from @t3-oss/env-core
- server.test.ts uses vi.resetModules pattern
- auth.service.ts accesses env.DATABASE_URL directly
- drizzle.config.ts accesses env.DATABASE_URL directly
- All unit tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/03.3-unify-env-validation-t3-env/03.3-01-SUMMARY.md`
</output>
