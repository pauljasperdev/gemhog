---
phase: 03.3-unify-env-validation-t3-env
plan: 01
subsystem: env
tags: [t3-env, zod, env-validation, vitest]

# Dependency graph
requires:
  - phase: 03.2-code-quality-tdd
    provides: env validation tests, server.ts with Effect Config
provides:
  - Server env validation using t3-env and Zod
  - Consumers access env vars as plain strings (no Redacted.value())
  - Server tests use vi.resetModules pattern
affects: [04-deployment, web-env-migration]

# Tech tracking
tech-stack:
  added: ["@t3-oss/env-core ^0.13.10", "zod catalog:"]
  removed: ["effect ^3.19"]
  patterns: ["createEnv from t3-env", "vi.resetModules for env testing"]

key-files:
  modified:
    - packages/env/package.json
    - packages/env/src/server.ts
    - packages/env/src/server.test.ts
    - packages/core/src/auth/auth.service.ts
    - packages/core/drizzle.config.ts
    - pnpm-lock.yaml

key-decisions:
  - "Remove Effect dependency from packages/env - t3-env unifies validation approach"
  - "No redaction - t3-env doesn't support it, server vars never exposed to client"
  - "Use vi.resetModules + dynamic import for test isolation"

patterns-established:
  - "t3-env createEnv pattern for server env validation"
  - "vi.resetModules + process.env mutation for env schema testing"
  - "Plain string access for env vars (no Redacted.value())"

# Metrics
duration: 5min
completed: 2026-01-22
---

# Phase 3.3 Plan 01: Server Env Migration Summary

**t3-env replaces Effect Config for server.ts validation with Zod schemas, consumers use plain strings**

## Performance

- **Duration:** 5 min
- **Started:** 2026-01-22T11:31:23Z
- **Completed:** 2026-01-22T11:36:14Z
- **Tasks:** 2
- **Files modified:** 6

## Accomplishments

- Replaced Effect Config with @t3-oss/env-core in packages/env
- Server env validates at import time using Zod schemas
- Tests use vi.resetModules pattern for module isolation
- Consumers (auth.service.ts, drizzle.config.ts) access env vars as plain strings

## Task Commits

Each task was committed atomically:

1. **Task 1: Update dependencies and implement server.ts with t3-env** - `93df0f1` (feat)
2. **Task 2: Update server tests and consumers** - `52c3725` (refactor)

## Files Created/Modified

- `packages/env/package.json` - Replaced effect with @t3-oss/env-core and zod
- `packages/env/src/server.ts` - Rewrote using createEnv from t3-env
- `packages/env/src/server.test.ts` - Rewrote using vi.resetModules pattern
- `packages/core/src/auth/auth.service.ts` - Removed Redacted.value()
- `packages/core/drizzle.config.ts` - Removed Redacted.value()
- `pnpm-lock.yaml` - Updated dependencies

## Decisions Made

- **Remove Effect from packages/env:** Unified env validation approach (t3-env for both server and web)
- **No redaction:** t3-env doesn't support it, but server vars are never exposed to client - acceptable tradeoff
- **Use vi.resetModules:** Tests manipulate process.env and use dynamic import() for isolation

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] Fixed lodash-es dependency vulnerability**
- **Found during:** Verification step (pnpm verify)
- **Issue:** Transitive dependency lodash-es via mermaid had prototype pollution vulnerability
- **Fix:** Added pnpm override `"lodash-es": ">=4.17.23"` in package.json
- **Files modified:** package.json, pnpm-lock.yaml
- **Verification:** pnpm audit returns "No known vulnerabilities found"
- **Committed in:** Separate fix commit

---

**Total deviations:** 1 auto-fixed (blocking)
**Impact on plan:** Essential for security audit to pass. No scope creep.

## Issues Encountered

**lodash-es vulnerability discovered and fixed:**
- Transitive dependency: streamdown > mermaid > lodash-es
- Vulnerability: Prototype pollution in `_.unset` and `_.omit` (GHSA-xxjr-mmjv-4gpg)
- Fix: Added pnpm override `"lodash-es": ">=4.17.23"` in package.json
- Status: FIXED - pnpm audit passes with no vulnerabilities

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- Server env uses t3-env, ready for unification with web env
- Web env already uses plain function (confirmed in 03.2-06)
- Next plan can migrate web.ts to @t3-oss/env-nextjs

---
*Phase: 03.3-unify-env-validation-t3-env*
*Completed: 2026-01-22*
