---
phase: 03.3-unify-env-validation-t3-env
plan: 02
type: execute
wave: 2
depends_on: ["03.3-01"]
files_modified:
  - packages/env/package.json
  - packages/env/src/web.ts
  - packages/env/src/web.test.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Web env validates at import time using t3-env"
    - "Missing NEXT_PUBLIC_SERVER_URL throws descriptive error"
    - "Web env works in Next.js browser context (no process.env at runtime)"
  artifacts:
    - path: "packages/env/src/web.ts"
      provides: "Client env validation with t3-env"
      exports: ["env", "WebEnv"]
    - path: "packages/env/src/web.test.ts"
      provides: "Unit tests for web env schema"
      contains: "vi.resetModules"
  key_links:
    - from: "packages/env/src/web.ts"
      to: "@t3-oss/env-nextjs"
      via: "createEnv import"
      pattern: "createEnv.*@t3-oss/env-nextjs"
---

<objective>
Replace plain validation function with t3-env in web.ts.

Purpose: Complete the unified env validation approach by migrating web.ts to @t3-oss/env-nextjs, matching server.ts pattern.

Output: web.ts using @t3-oss/env-nextjs with explicit runtimeEnv for Next.js build-time inlining.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Research
@.planning/phases/03.3-unify-env-validation-t3-env/03.3-RESEARCH.md

# Prior plan (server.ts migration)
@.planning/phases/03.3-unify-env-validation-t3-env/03.3-01-SUMMARY.md

# Current implementation
@packages/env/src/web.ts
@packages/env/src/web.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update web.ts with t3-env and update tests</name>
  <files>
    packages/env/package.json
    packages/env/src/web.ts
    packages/env/src/web.test.ts
  </files>
  <action>
1. Add @t3-oss/env-nextjs to packages/env/package.json:
   - Add "@t3-oss/env-nextjs": "^0.13.10"
   (zod already added in plan 01)

2. Replace packages/env/src/web.ts with t3-env implementation:
```typescript
import { createEnv } from "@t3-oss/env-nextjs";
import { z } from "zod";

export const env = createEnv({
  client: {
    NEXT_PUBLIC_SERVER_URL: z.url(),
  },
  runtimeEnv: {
    NEXT_PUBLIC_SERVER_URL: process.env.NEXT_PUBLIC_SERVER_URL,
  },
  emptyStringAsUndefined: true,
});

export type WebEnv = typeof env;
```

CRITICAL: runtimeEnv must explicitly destructure NEXT_PUBLIC_SERVER_URL. Do NOT use `runtimeEnv: process.env` - Next.js needs explicit access for build-time inlining.

3. Update packages/env/src/web.test.ts to match t3-env error format:
```typescript
import { afterEach, beforeEach, describe, expect, it, vi } from "vitest";

describe("web env validation", () => {
  const originalEnv = process.env;

  beforeEach(() => {
    vi.resetModules();
    process.env = { ...originalEnv };
  });

  afterEach(() => {
    process.env = originalEnv;
  });

  it("should fail when NEXT_PUBLIC_SERVER_URL is missing", async () => {
    delete process.env.NEXT_PUBLIC_SERVER_URL;

    await expect(import("./web.js")).rejects.toThrow();
  });

  it("should fail when NEXT_PUBLIC_SERVER_URL is empty string", async () => {
    process.env.NEXT_PUBLIC_SERVER_URL = "";

    await expect(import("./web.js")).rejects.toThrow();
  });

  it("should fail when NEXT_PUBLIC_SERVER_URL is not a valid URL", async () => {
    process.env.NEXT_PUBLIC_SERVER_URL = "not-a-url";

    await expect(import("./web.js")).rejects.toThrow();
  });

  it("should succeed when NEXT_PUBLIC_SERVER_URL is a valid URL", async () => {
    process.env.NEXT_PUBLIC_SERVER_URL = "http://localhost:3000";

    const { env } = await import("./web.js");

    expect(env.NEXT_PUBLIC_SERVER_URL).toBe("http://localhost:3000");
  });
});
```
  </action>
  <verify>
Run `pnpm install` to update lockfile. Run `pnpm test:unit` to verify web.test.ts passes (4 tests). Run `pnpm check-types` for TypeScript verification.
  </verify>
  <done>
web.ts uses @t3-oss/env-nextjs with explicit runtimeEnv, tests verify validation behavior including empty string handling.
  </done>
</task>

<task type="auto">
  <name>Task 2: Run full verification pipeline</name>
  <files></files>
  <action>
Run the full verification pipeline to ensure all changes work together:

1. `pnpm db:start` - Start Docker database
2. `pnpm verify` - Full pipeline (static, unit, integration, e2e, security)

Expected results:
- Static analysis passes (Biome + TypeScript)
- Unit tests pass (including server.test.ts and web.test.ts)
- Integration tests pass (database connection)
- E2E tests pass (Next.js app loads)
- Security audit passes (no vulnerabilities)
  </action>
  <verify>
`pnpm verify` exits with code 0 (all checks pass).
  </verify>
  <done>
Full verification pipeline passes - t3-env migration complete.
  </done>
</task>

</tasks>

<verification>
1. `pnpm install` - lockfile updated with @t3-oss/env-nextjs
2. `pnpm check-types` - no TypeScript errors
3. `pnpm test:unit` - all unit tests pass (server + web)
4. `pnpm db:start && pnpm verify` - full pipeline passes
5. `grep "@t3-oss/env" packages/env/package.json` - both packages present
6. `grep "effect" packages/env/package.json` - no matches (removed)
</verification>

<success_criteria>
- packages/env/package.json has @t3-oss/env-core AND @t3-oss/env-nextjs
- web.ts uses createEnv from @t3-oss/env-nextjs
- web.ts has explicit runtimeEnv (not process.env spread)
- web.test.ts has 4 tests covering missing, empty, invalid, valid cases
- Full verification pipeline passes
</success_criteria>

<output>
After completion, create `.planning/phases/03.3-unify-env-validation-t3-env/03.3-02-SUMMARY.md`
</output>
