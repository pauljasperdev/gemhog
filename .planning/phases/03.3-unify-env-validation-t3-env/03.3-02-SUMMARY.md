---
phase: 03.3-unify-env-validation-t3-env
plan: 02
subsystem: config
tags: [t3-env, env-nextjs, zod, next.js, environment-validation]

# Dependency graph
requires:
  - phase: 03.3-01
    provides: t3-env pattern established for server.ts
provides:
  - Unified env validation using t3-env for both server and web
  - Web env validates at import time with descriptive errors
  - Next.js build-time inlining via explicit runtimeEnv
affects: [apps/web, deployment]

# Tech tracking
tech-stack:
  added: ["@t3-oss/env-nextjs"]
  patterns: ["t3-env createEnv for client env validation"]

key-files:
  created: []
  modified:
    - packages/env/package.json
    - packages/env/src/web.ts
    - packages/env/src/web.test.ts

key-decisions:
  - "Use explicit runtimeEnv destructuring (not process.env spread) for Next.js build-time inlining"
  - "Use z.url() for URL validation (consistent with server.ts)"
  - "4 test cases: missing, empty string, invalid URL, valid URL"

patterns-established:
  - "t3-env with explicit runtimeEnv for Next.js client env"
  - "vi.resetModules + dynamic import for env module testing"

# Metrics
duration: 3min
completed: 2026-01-22
---

# Phase 03.3 Plan 02: Web Env Migration Summary

**Client env validation unified with @t3-oss/env-nextjs, explicit runtimeEnv for Next.js build-time inlining**

## Performance

- **Duration:** 3 min
- **Started:** 2026-01-22T12:42:00Z
- **Completed:** 2026-01-22T12:45:00Z
- **Tasks:** 2
- **Files modified:** 4

## Accomplishments

- Replaced plain validation function with t3-env createEnv pattern
- Added URL validation using Zod z.url() schema
- Expanded test coverage from 2 tests to 4 (missing, empty, invalid, valid)
- Full verification pipeline passes (static, unit, integration, e2e, security)

## Task Commits

Each task was committed atomically:

1. **Task 1: Update web.ts with t3-env and update tests** - `cacd67b` (feat)
2. **Task 2: Run full verification pipeline** - No commit (verification only)

## Files Created/Modified

- `packages/env/package.json` - Added @t3-oss/env-nextjs dependency
- `packages/env/src/web.ts` - Replaced plain function with t3-env createEnv
- `packages/env/src/web.test.ts` - Added empty string and invalid URL test cases
- `pnpm-lock.yaml` - Updated with new dependency

## Decisions Made

1. **Explicit runtimeEnv destructuring** - Must use `{ NEXT_PUBLIC_SERVER_URL: process.env.NEXT_PUBLIC_SERVER_URL }` rather than `process.env` spread for Next.js build-time inlining to work correctly

2. **URL validation with z.url()** - Consistent with server.ts pattern, provides better error messages than string validation

3. **emptyStringAsUndefined: true** - Consistent with server.ts, treats empty strings as missing values

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] Formatted .planning/intel/ files**

- **Found during:** Task 2 (verification pipeline)
- **Issue:** Pre-existing formatting issues in intel files caused Biome to fail
- **Fix:** Ran `pnpm biome format --write .planning/intel/`
- **Files modified:** .planning/intel/conventions.json, .planning/intel/index.json
- **Verification:** `pnpm verify` passes
- **Note:** Not committed as these are auto-generated codebase intelligence files

---

**Total deviations:** 1 auto-fixed (blocking)
**Impact on plan:** Formatting fix was necessary for verification to pass. No scope creep.

## Issues Encountered

None - plan executed as specified.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

- Phase 03.3 complete - env validation unified with t3-env
- Both server.ts and web.ts now use t3-env pattern
- Ready for Phase 4 (SST foundation)

**Benefits realized:**

- Consistent env validation approach across server and client
- Zod schemas provide type-safe env access
- Import-time validation catches env issues early
- Descriptive error messages for missing/invalid env vars

---

_Phase: 03.3-unify-env-validation-t3-env_
_Completed: 2026-01-22_
