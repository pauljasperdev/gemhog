# Phase 3.3: Unify Env Validation with t3-env - Research

**Researched:** 2026-01-22
**Domain:** Environment variable validation, t3-env, Zod
**Confidence:** HIGH

## Summary

This research investigates how to replace the current mixed env validation approach (Effect Config for server, plain function for web) with unified t3-env across all packages. The original t3-env implementation (before commit 249d66a) provides a solid reference, and the t3-env library itself is well-suited for this use case.

The key insight is that t3-env was specifically designed to handle the exact problem we face: validating server-side env vars (with dotenv) and client-side NEXT_PUBLIC_* vars (which Next.js inlines at build time). The library uses `@t3-oss/env-core` for server packages and `@t3-oss/env-nextjs` for Next.js apps, providing a consistent API while respecting each environment's constraints.

**Primary recommendation:** Restore t3-env using the original implementation (pre-249d66a) as the baseline, with minor updates for Zod 4 compatibility and improved testing patterns.

## Standard Stack

The established libraries/tools for this domain:

### Core

| Library | Version | Purpose | Why Standard |
|---------|---------|---------|--------------|
| @t3-oss/env-core | ^0.13.10 | Server-side env validation | Standard for non-Next.js packages, works with dotenv |
| @t3-oss/env-nextjs | ^0.13.10 | Next.js client/server env validation | Handles NEXT_PUBLIC_* build-time inlining |
| zod | catalog: (^4.1.13) | Schema validation | Project standard, required peer dependency for t3-env |
| dotenv | catalog: (^17.2.2) | Load .env files (server only) | Required for server.ts to read .env files |

### Supporting

| Library | Version | Purpose | When to Use |
|---------|---------|---------|-------------|
| typescript | ^5.0.0 | Type inference | Required peer dependency for t3-env type safety |

### Alternatives Considered

| Instead of | Could Use | Tradeoff |
|------------|-----------|----------|
| t3-env | Effect Config | Effect Config breaks Next.js E2E (browser doesn't have process.env at runtime) |
| t3-env | Plain validation functions | Works but loses type inference, Zod integration, and skipValidation option |
| t3-env | znv | Less ecosystem adoption, no Next.js-specific package |

**Installation:**

```bash
pnpm add @t3-oss/env-core @t3-oss/env-nextjs dotenv zod -w packages/env
```

## Architecture Patterns

### Recommended Project Structure

```
packages/env/
├── src/
│   ├── server.ts       # @t3-oss/env-core for server packages
│   ├── server.test.ts  # Unit tests for server schema validation
│   ├── web.ts          # @t3-oss/env-nextjs for Next.js client
│   └── web.test.ts     # Unit tests for web schema validation
└── package.json
```

### Pattern 1: Server Env with @t3-oss/env-core

**What:** Use `createEnv()` from `@t3-oss/env-core` with `server` schema and `runtimeEnv: process.env`

**When to use:** Server-side packages that need env validation (Hono server, background jobs, etc.)

**Example (from pre-249d66a):**

```typescript
// Source: git show 249d66a^:packages/env/src/server.ts
import "dotenv/config";
import { createEnv } from "@t3-oss/env-core";
import { z } from "zod";

export const env = createEnv({
  server: {
    DATABASE_URL: z.string().min(1),
    BETTER_AUTH_SECRET: z.string().min(32),
    BETTER_AUTH_URL: z.url(),
    CORS_ORIGIN: z.url(),
    NODE_ENV: z
      .enum(["development", "production", "test"])
      .default("development"),
  },
  runtimeEnv: process.env,
  emptyStringAsUndefined: true,
});
```

### Pattern 2: Client Env with @t3-oss/env-nextjs

**What:** Use `createEnv()` from `@t3-oss/env-nextjs` with `client` schema and explicit `runtimeEnv`

**When to use:** Next.js apps that need NEXT_PUBLIC_* environment variables

**Example (from pre-249d66a):**

```typescript
// Source: git show 249d66a^:packages/env/src/web.ts
import { createEnv } from "@t3-oss/env-nextjs";
import { z } from "zod";

export const env = createEnv({
  client: {
    NEXT_PUBLIC_SERVER_URL: z.url(),
  },
  runtimeEnv: {
    NEXT_PUBLIC_SERVER_URL: process.env.NEXT_PUBLIC_SERVER_URL,
  },
  emptyStringAsUndefined: true,
});
```

**Critical:** For Next.js, `runtimeEnv` must explicitly destructure each NEXT_PUBLIC_* variable. This is because Next.js replaces `process.env.NEXT_PUBLIC_*` with literal values at build time - you cannot use `runtimeEnv: process.env` like server.ts does.

### Pattern 3: Build-Time Validation in next.config.ts

**What:** Import env module in next.config.ts to validate at build time

**When to use:** Always - catches missing env vars before deployment

**Example:**

```typescript
// Source: https://env.t3.gg/docs/nextjs
// apps/web/next.config.ts
import "./src/env"; // or wherever your env file is

const nextConfig = {
  // ...
};

export default nextConfig;
```

### Anti-Patterns to Avoid

- **Using `skipValidation: true` in production:** Only use for Docker builds or CI/lint. Note that defaults are NOT applied when validation is skipped.
- **Using `runtimeEnv: process.env` for NEXT_PUBLIC_* vars:** Won't work in browser - Next.js needs explicit destructuring.
- **Mixing validation approaches:** Don't use Effect Config for server and t3-env for web - maintain consistency.

## Don't Hand-Roll

Problems that look simple but have existing solutions:

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Env validation | Custom validation functions | t3-env createEnv() | Type-safe, handles empty strings, Zod integration |
| Server/client separation | Manual checks | t3-env server/client schemas | Prevents leaking server vars to client |
| Build-time validation | Manual startup checks | Import in next.config.ts | Catches errors before deployment |
| Empty string handling | Custom checks | emptyStringAsUndefined: true | Standard pattern, catches common CI issues |

**Key insight:** t3-env handles the complex interaction between dotenv (server), Next.js build-time replacement (client), and Zod validation. Hand-rolling this is error-prone.

## Common Pitfalls

### Pitfall 1: Sensitive Values Not Redacted

**What goes wrong:** DATABASE_URL, BETTER_AUTH_SECRET show in console.log/error output

**Why it happens:** t3-env does NOT have built-in console log redaction like Effect Config.redacted()

**How to avoid:**
1. Never log the entire `env` object
2. Use destructuring to only access what you need
3. Server variables are never exposed to client (t3-env enforces this)

**Warning signs:** Secrets appearing in error stack traces or logs

### Pitfall 2: skipValidation Skips Defaults

**What goes wrong:** When using `skipValidation: true`, default values (like `NODE_ENV: "development"`) are NOT applied

**Why it happens:** skipValidation skips both validation AND parsing/transformation

**How to avoid:**
1. Only use skipValidation for lint/Docker builds where you don't need the env values
2. For tests, use `vi.resetModules()` and process.env manipulation instead

**Warning signs:** `undefined` values when expecting defaults

### Pitfall 3: Test Import Triggers Validation

**What goes wrong:** Tests fail because importing the env module triggers validation with real process.env

**Why it happens:** t3-env validates at import time (same as Effect Config)

**How to avoid:**
1. Use `vi.resetModules()` before setting up test env vars
2. Use dynamic `import()` after modifying process.env
3. Don't import the production env module in test files directly

**Warning signs:** Tests that pass locally but fail in CI

### Pitfall 4: Next.js runtimeEnv Requirements

**What goes wrong:** Client env vars show as undefined in browser

**Why it happens:** Next.js replaces `process.env.NEXT_PUBLIC_*` at build time - you must explicitly access them

**How to avoid:**
1. Always explicitly list each NEXT_PUBLIC_* var in runtimeEnv
2. Don't use `runtimeEnv: process.env` for Next.js apps

**Warning signs:** Vars work in dev but undefined in production

### Pitfall 5: Zod 4 URL Validation

**What goes wrong:** URLs that worked before now fail validation

**Why it happens:** Zod 4's `z.url()` uses `new URL()` constructor instead of regex

**How to avoid:**
1. Use `z.url()` (top-level) instead of deprecated `z.string().url()`
2. Ensure URLs include protocol (http:// or https://)

**Warning signs:** "Invalid URL" errors on previously valid strings

## Code Examples

Verified patterns from official sources and project history:

### Server Env with t3-env (Updated for Zod 4)

```typescript
// packages/env/src/server.ts
// Source: Based on git show 249d66a^:packages/env/src/server.ts
import "dotenv/config";
import { createEnv } from "@t3-oss/env-core";
import { z } from "zod";

export const env = createEnv({
  server: {
    DATABASE_URL: z.string().min(1),
    BETTER_AUTH_SECRET: z.string().min(32),
    BETTER_AUTH_URL: z.url(),
    CORS_ORIGIN: z.url(),
    NODE_ENV: z
      .enum(["development", "production", "test"])
      .default("development"),
  },
  runtimeEnv: process.env,
  emptyStringAsUndefined: true,
});

export type ServerEnv = typeof env;
```

### Web Env with t3-env (Updated for Zod 4)

```typescript
// packages/env/src/web.ts
// Source: Based on git show 249d66a^:packages/env/src/web.ts
import { createEnv } from "@t3-oss/env-nextjs";
import { z } from "zod";

export const env = createEnv({
  client: {
    NEXT_PUBLIC_SERVER_URL: z.url(),
  },
  runtimeEnv: {
    NEXT_PUBLIC_SERVER_URL: process.env.NEXT_PUBLIC_SERVER_URL,
  },
  emptyStringAsUndefined: true,
});

export type WebEnv = typeof env;
```

### Testing Server Env Schema

```typescript
// packages/env/src/server.test.ts
// Source: Pattern from project history + t3-env testing guidance
import { afterEach, beforeEach, describe, expect, it, vi } from "vitest";

describe("server env validation", () => {
  const originalEnv = process.env;

  beforeEach(() => {
    vi.resetModules();
    process.env = { ...originalEnv };
  });

  afterEach(() => {
    process.env = originalEnv;
  });

  it("should fail when DATABASE_URL is missing", async () => {
    delete process.env.DATABASE_URL;
    // Must use dynamic import after modifying process.env
    await expect(import("./server.js")).rejects.toThrow("DATABASE_URL");
  });

  it("should succeed with all required vars", async () => {
    process.env.DATABASE_URL = "postgresql://localhost:5432/test";
    process.env.BETTER_AUTH_SECRET = "super-secret-key-at-least-32-chars";
    process.env.BETTER_AUTH_URL = "http://localhost:3000";
    process.env.CORS_ORIGIN = "http://localhost:3001";

    const { env } = await import("./server.js");

    expect(env.BETTER_AUTH_URL).toBe("http://localhost:3000");
    expect(env.NODE_ENV).toBe("development"); // default applied
  });
});
```

### Testing Web Env Schema

```typescript
// packages/env/src/web.test.ts
// Source: Current web.test.ts pattern
import { afterEach, beforeEach, describe, expect, it, vi } from "vitest";

describe("web env validation", () => {
  const originalEnv = process.env;

  beforeEach(() => {
    vi.resetModules();
    process.env = { ...originalEnv };
  });

  afterEach(() => {
    process.env = originalEnv;
  });

  it("should fail when NEXT_PUBLIC_SERVER_URL is missing", async () => {
    delete process.env.NEXT_PUBLIC_SERVER_URL;

    await expect(import("./web.js")).rejects.toThrow(
      "NEXT_PUBLIC_SERVER_URL",
    );
  });

  it("should succeed when NEXT_PUBLIC_SERVER_URL is provided", async () => {
    process.env.NEXT_PUBLIC_SERVER_URL = "http://localhost:3000";

    const { env } = await import("./web.js");

    expect(env.NEXT_PUBLIC_SERVER_URL).toBe("http://localhost:3000");
  });
});
```

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| z.string().url() | z.url() | Zod 4 (2025) | New top-level function, old is deprecated |
| z.nativeEnum() | z.enum() | Zod 4 (2025) | Unified API for all enums |
| message param | error param | Zod 4 (2025) | Error customization syntax changed |

**Deprecated/outdated:**

- `z.string().url()`: Use `z.url()` instead (Zod 4)
- `z.string().email()`: Use `z.email()` instead (Zod 4)
- Effect Config for browser env: Doesn't work with Next.js E2E

## Open Questions

Things that couldn't be fully resolved:

1. **Secret Redaction**
   - What we know: t3-env does NOT have built-in redaction like Effect Config.redacted()
   - What's unclear: Whether we need to add custom redaction or if server/client separation is sufficient
   - Recommendation: Accept this limitation - server vars are never exposed to client, and we should avoid logging the entire env object

2. **dotenv Dependency**
   - What we know: server.ts needs `import "dotenv/config"` to load .env files
   - What's unclear: Whether dotenv should be a dependency or devDependency
   - Recommendation: Keep as dependency (CODE_REVIEW.md Issue 2 asks about this) - it's needed at runtime for server

## Sources

### Primary (HIGH confidence)

- [T3 Env Core Documentation](https://env.t3.gg/docs/core) - API reference, configuration options
- [T3 Env Next.js Documentation](https://env.t3.gg/docs/nextjs) - Next.js-specific patterns, runtimeEnv requirements
- [T3 Env Customization](https://env.t3.gg/docs/customization) - skipValidation, onValidationError, emptyStringAsUndefined
- Git history: `git show 249d66a^:packages/env/` - Original t3-env implementation

### Secondary (MEDIUM confidence)

- [Zod 4 Migration Guide](https://zod.dev/v4/changelog) - z.url() changes, deprecations
- [T3 Env GitHub](https://github.com/t3-oss/t3-env) - Version info, installation

### Tertiary (LOW confidence)

- [GitHub Issue #155](https://github.com/t3-oss/t3-env/issues/155) - skipValidation behavior with defaults
- [AnswerOverflow discussion](https://www.answeroverflow.com/m/1111542866427256882) - Vitest testing patterns

## Metadata

**Confidence breakdown:**

- Standard stack: HIGH - Official docs + project history confirm approach
- Architecture: HIGH - Original implementation exists in git history
- Pitfalls: HIGH - Documented issues + project experience (Effect Config browser failure)
- Testing: MEDIUM - Pattern from web.test.ts works, but server tests need adaptation from Effect-based approach

**Research date:** 2026-01-22
**Valid until:** 60 days (t3-env is stable, unlikely to have breaking changes)
