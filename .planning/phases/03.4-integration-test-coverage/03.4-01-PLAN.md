---
phase: 03.4-integration-test-coverage
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/core/drizzle.config.ts
  - packages/core/src/drizzle/migrations.int.test.ts
autonomous: true

must_haves:
  truths:
    - "pnpm db:migrate works from monorepo root with only DATABASE_URL set"
    - "Migration tests verify schema tables exist after apply"
    - "Migration tracking table (__drizzle_migrations) is populated"
  artifacts:
    - path: "packages/core/drizzle.config.ts"
      provides: "Drizzle-kit config that only requires DATABASE_URL"
      contains: "dotenv/config"
    - path: "packages/core/src/drizzle/migrations.int.test.ts"
      provides: "Migration application tests"
      min_lines: 40
  key_links:
    - from: "packages/core/drizzle.config.ts"
      to: "process.env.DATABASE_URL"
      via: "dotenv direct load"
      pattern: "process\\.env\\.DATABASE_URL"
---

<objective>
Fix drizzle.config.ts env loading and add migration tests

Purpose: Enable db:migrate to work from monorepo root without requiring all server env vars, and verify migrations apply correctly via integration tests.

Output: Fixed drizzle.config.ts using dotenv directly, new migrations.int.test.ts that verifies schema state after migration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03.4-integration-test-coverage/03.4-CONTEXT.md
@.planning/phases/03.4-integration-test-coverage/03.4-RESEARCH.md
@packages/core/drizzle.config.ts
@packages/core/src/migrations/0000_initial_schema.sql
@packages/env/src/server.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix drizzle.config.ts to use dotenv directly</name>
  <files>packages/core/drizzle.config.ts</files>
  <action>
Replace @gemhog/env/server import with dotenv/config.

Current problem: @gemhog/env/server validates DATABASE_URL, BETTER_AUTH_SECRET, BETTER_AUTH_URL, CORS_ORIGIN together. drizzle-kit only needs DATABASE_URL.

Implementation:
1. Import "dotenv/config" at top
2. Read DATABASE_URL from process.env directly
3. Throw explicit error if DATABASE_URL is not set
4. Remove @gemhog/env/server import

Note: dotenv is already a dependency of packages/core (used transitively). The import will load .env from the monorepo root when running pnpm db:migrate.
  </action>
  <verify>Run `cd /home/lima/repo && DATABASE_URL=postgresql://postgres:password@localhost:5432/gemhog pnpm db:migrate --config packages/core/drizzle.config.ts` (or just `pnpm db:migrate` if .env is set). Should NOT fail with "Invalid environment variables" mentioning BETTER_AUTH_SECRET etc.</verify>
  <done>drizzle.config.ts uses dotenv/config and only requires DATABASE_URL</done>
</task>

<task type="auto">
  <name>Task 2: Add migration application integration test</name>
  <files>packages/core/src/drizzle/migrations.int.test.ts</files>
  <action>
Create new integration test file that verifies migrations apply correctly.

Implementation:
1. Create packages/core/src/drizzle/migrations.int.test.ts
2. Import drizzle from drizzle-orm/node-postgres
3. Import migrate from drizzle-orm/node-postgres/migrator
4. Create pg.Pool in beforeAll, close in afterAll
5. Test case 1: Apply migrations, verify user/session/account/verification tables exist via information_schema
6. Test case 2: Verify __drizzle_migrations table has entries

Per CONTEXT.md: Use PostgreSQL 16.x (same as production), verify via information_schema queries.

Note: Do NOT test rollback - RESEARCH.md confirms drizzle-kit has no built-in rollback. Focus on apply testing.
  </action>
  <verify>Run `pnpm test:integration --filter=@gemhog/core` and verify migrations.int.test.ts passes</verify>
  <done>migrations.int.test.ts exists with 2 test cases that verify schema state after migration</done>
</task>

</tasks>

<verification>
1. Run `pnpm db:migrate` from monorepo root - should succeed without env validation errors
2. Run `pnpm test:integration` - migrations.int.test.ts should pass
3. Type check passes: `pnpm check-types`
</verification>

<success_criteria>
- pnpm db:migrate works with only DATABASE_URL in environment
- migrations.int.test.ts has 2+ test cases covering migration apply and tracking
- All tests pass including new migration tests
</success_criteria>

<output>
After completion, create `.planning/phases/03.4-integration-test-coverage/03.4-01-SUMMARY.md`
</output>
