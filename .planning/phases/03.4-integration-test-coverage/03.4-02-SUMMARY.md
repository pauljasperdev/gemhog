---
phase: 03.4-integration-test-coverage
plan: 02
subsystem: testing
tags: [effect, vitest, integration-tests, database]
requires: []
provides: [effect-vitest-pattern, database-layer-tests]
affects: [03.4-03, 03.4-04]
tech-stack:
  added:
    - "@effect/vitest@^0.27.0"
  patterns:
    - "@effect/vitest layer() for Effect test context"
    - "PgClient.layer() with explicit URL for test isolation"
    - "SqlClient.SqlClient for Effect-based queries"
key-files:
  created: []
  modified:
    - packages/core/src/drizzle/connection.int.test.ts
    - packages/core/package.json
decisions:
  - Use PgClient.layer() over layerConfig() for tests
  - Use Redacted.make() for explicit URL in test layer
metrics:
  duration: "3 min"
  completed: "2026-01-22"
---

# Phase 3.4 Plan 02: Update connection.int.test.ts to use @effect/vitest layer() pattern

**One-liner:** Refactored database connection tests to use @effect/vitest layer() with Effect-based SqlClient queries

## What Was Done

Refactored `connection.int.test.ts` from manual pg.Pool creation to Effect-based testing using `@effect/vitest`. The tests now use the official Effect testing library with proper layer provision.

### Task Completion

| Task | Name | Commit | Status |
|------|------|--------|--------|
| 1 | Add @effect/vitest dependency | 03f3e8e | Complete |
| 2 | Refactor connection.int.test.ts to use @effect/vitest | 581255b | Complete |

### Key Changes

1. **Added @effect/vitest ^0.27.0** as devDependency to packages/core
   - Provides `layer()` and `it.effect()` test helpers

2. **Refactored connection.int.test.ts**
   - Replaced manual `pg.Pool` with `PgClient.layer()` Effect layer
   - Used `Redacted.make()` for explicit URL (bypasses Config.redacted)
   - Tests use `SqlClient.SqlClient` for Effect-based queries
   - `layer()` handles setup/teardown automatically

### Before/After

**Before (manual):**
```typescript
let pool: pg.Pool;
let db: ReturnType<typeof drizzle>;

beforeAll(() => {
  pool = new pg.Pool({ connectionString });
  db = drizzle(pool);
});

afterAll(async () => {
  await pool.end();
});

it("should connect", async () => {
  const result = await db.execute(sql`SELECT 1`);
});
```

**After (Effect):**
```typescript
const TestPgLive = PgClient.layer({
  url: Redacted.make(process.env.DATABASE_URL ?? "..."),
});

layer(TestPgLive)("Effect layer", (it) => {
  it.effect("should connect", () =>
    Effect.gen(function* () {
      const sql = yield* SqlClient.SqlClient;
      const result = yield* sql`SELECT 1`;
    })
  );
});
```

## Decisions Made

| Decision | Rationale | Impact |
|----------|-----------|--------|
| Use PgClient.layer() over layerConfig() | layerConfig() requires ConfigProvider; layer() accepts direct config | Simpler test setup |
| Use Redacted.make() for URL | PgClient expects Redacted type for url field | Type safety |
| Keep describe() wrapper | Maintains test organization and compatibility with existing test output | Consistent output |

## Deviations from Plan

None - plan executed exactly as written.

## Verification Results

- Type check passes: `pnpm check-types`
- Integration tests pass: `pnpm test:integration` (connection.int.test.ts passes)
- File imports @effect/vitest: Confirmed via grep
- No manual pg.Pool: Confirmed via grep

## Next Phase Readiness

**Required for 03.4-03 (Auth integration tests):**
- Database connectivity verified through Effect layers

**Required for 03.4-04 (tRPC procedure tests):**
- Effect testing pattern established
