---
phase: 03.4-integration-test-coverage
plan: 04
type: execute
wave: 2
depends_on: ["03.4-01"]
files_modified:
  - packages/api/src/routers/procedures.int.test.ts
  - packages/api/src/example.test.ts
autonomous: true

must_haves:
  truths:
    - "healthCheck procedure returns OK without authentication"
    - "privateData procedure returns user data with valid session"
    - "privateData procedure throws UNAUTHORIZED without session"
  artifacts:
    - path: "packages/api/src/routers/procedures.int.test.ts"
      provides: "tRPC procedure integration tests"
      min_lines: 50
  key_links:
    - from: "packages/api/src/routers/procedures.int.test.ts"
      to: "packages/api/src/routers/index.ts"
      via: "appRouter import"
      pattern: "import.*appRouter"
---

<objective>
Add tRPC procedure integration tests

Purpose: Test all tRPC procedures (healthCheck, privateData) using createCaller pattern with mock context. This validates procedure logic and authorization work correctly.

Output: New procedures.int.test.ts with real tests for all procedures, placeholder example.test.ts removed or repurposed.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03.4-integration-test-coverage/03.4-CONTEXT.md
@.planning/phases/03.4-integration-test-coverage/03.4-RESEARCH.md
@packages/api/src/routers/index.ts
@packages/api/src/index.ts
@packages/api/src/context.ts
@packages/api/src/example.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create tRPC procedure integration tests</name>
  <files>packages/api/src/routers/procedures.int.test.ts</files>
  <action>
Create integration tests for all tRPC procedures using createCaller pattern.

Per CONTEXT.md decisions:
- Use mock context for auth (fake user/session object, not real sessions)
- Test ALL procedures (full coverage, not just sampling)
- Verify unauthorized access returns correct auth errors

Implementation:
1. Create procedures.int.test.ts in packages/api/src/routers/
2. Import appRouter from "./index"
3. Import TRPCError from "@trpc/server"

Test cases to implement:

describe("healthCheck (public)")
  - it("should return OK without session") - createCaller({ session: null }), call healthCheck()

describe("privateData (protected)")
  - it("should return data with valid session") - createCaller with mock session, call privateData()
  - it("should throw UNAUTHORIZED without session") - createCaller({ session: null }), expect privateData() to throw TRPCError with code UNAUTHORIZED

Mock session shape (from context.ts types):
```typescript
const mockSession = {
  user: {
    id: "test-user-id",
    name: "Test User",
    email: "test@example.com",
    emailVerified: true,
    image: null,
    createdAt: new Date(),
    updatedAt: new Date(),
  },
  session: {
    id: "test-session-id",
    token: "test-token",
    expiresAt: new Date(Date.now() + 86400000), // 24h from now
    userId: "test-user-id",
    createdAt: new Date(),
    updatedAt: new Date(),
    ipAddress: null,
    userAgent: null,
  },
};
```

Note: These tests use the deprecated router.createCaller() API - this is acceptable per RESEARCH.md, it still works.
  </action>
  <verify>Run `pnpm test:integration --filter=@gemhog/api` (or filter pattern for api package) and verify all tests pass</verify>
  <done>procedures.int.test.ts has 3 test cases covering both procedures with and without auth</done>
</task>

<task type="auto">
  <name>Task 2: Remove placeholder example.test.ts</name>
  <files>packages/api/src/example.test.ts</files>
  <action>
Delete the placeholder example.test.ts file since we now have real procedure tests.

Current content is just:
```typescript
describe("example", () => {
  it("should pass a basic test", () => {
    expect(1 + 1).toBe(2);
  });
});
```

This provides no value now that we have real tests.
  </action>
  <verify>File is deleted. Run `pnpm test:integration --filter=@gemhog/api` to confirm tests still pass.</verify>
  <done>example.test.ts is deleted, only real procedure tests remain</done>
</task>

</tasks>

<verification>
1. Run `pnpm test:integration` - procedures.int.test.ts passes
2. Verify example.test.ts is deleted
3. Type check passes: `pnpm check-types`
4. All integration tests across all packages pass
</verification>

<success_criteria>
- procedures.int.test.ts has 3 test cases covering healthCheck and privateData
- Tests verify both success paths and authorization errors
- Placeholder example.test.ts is removed
- All integration tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/03.4-integration-test-coverage/03.4-04-SUMMARY.md`
</output>
