---
phase: 03.4-integration-test-coverage
plan: 06
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/src/startup.int.test.ts
  - apps/server/src/startup.int.test.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Web startup test uses pnpm build instead of temp directory with symlinks"
    - "Server startup test uses pnpm build or direct tsx invocation without complex setup"
    - "Tests prevent .env auto-loading via DOTENV_CONFIG_PATH or similar"
    - "Test code is significantly simpler (fewer lines, no fs operations)"
  artifacts:
    - path: "apps/web/src/startup.int.test.ts"
      provides: "Simplified web startup failure test"
      max_lines: 50
    - path: "apps/server/src/startup.int.test.ts"
      provides: "Simplified server startup failure test"
      max_lines: 60
---

<objective>
Simplify startup integration tests to use actual build commands

Purpose: Replace complex temp directory + symlink approach with simpler tests that run actual build commands with controlled environment.

Output: Refactored startup tests that are easier to understand and maintain.

**Gap identified:** Current tests create temp directories with symlinks to test missing env vars - overly complex when we can just run `pnpm build` with controlled env.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@apps/web/src/startup.int.test.ts
@apps/server/src/startup.int.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Simplify web startup test</name>
  <files>apps/web/src/startup.int.test.ts</files>
  <action>
Refactor the web startup test to use a simpler approach.

Current approach (complex):
- Creates temp directory
- Symlinks all files except .env
- Runs next build from temp dir
- Cleans up temp dir

New approach (simple):
```typescript
import { exec } from "node:child_process";
import { promisify } from "node:util";
import path from "node:path";
import { describe, expect, it } from "vitest";

const execAsync = promisify(exec);

describe("web startup", () => {
  const webDir = path.resolve(__dirname, "..");

  it("should fail build when NEXT_PUBLIC_SERVER_URL is missing", async () => {
    try {
      await execAsync("pnpm build", {
        cwd: webDir,
        env: {
          PATH: process.env.PATH,
          HOME: process.env.HOME,
          // Prevent Next.js from reading .env files
          DOTENV_CONFIG_PATH: "/nonexistent",
          // Don't set NEXT_PUBLIC_SERVER_URL
        },
      });
      // If build succeeds, fail the test
      expect.fail("Build should have failed with missing env vars");
    } catch (error) {
      // Build failed as expected
      const stderr = (error as { stderr?: string }).stderr || "";
      const stdout = (error as { stdout?: string }).stdout || "";
      const output = stdout + stderr;
      expect(output).toContain("NEXT_PUBLIC_SERVER_URL");
    }
  }, 60000); // Build can take time
});
```

**Key changes:**
- Remove temp directory creation
- Remove symlink logic
- Remove cleanup
- Use execAsync with try/catch
- Set DOTENV_CONFIG_PATH=/nonexistent to prevent .env loading

**Note:** Next.js may still read .env despite DOTENV_CONFIG_PATH. If so, we may need to set `NODE_ENV=test` and ensure no .env.test exists, or use `--no-env` flag if available in Next.js version.
  </action>
  <verify>Run `pnpm test:integration` and verify the web startup test still passes</verify>
  <done>apps/web/src/startup.int.test.ts simplified, no temp directory or symlinks</done>
</task>

<task type="auto">
  <name>Task 2: Simplify server startup test</name>
  <files>apps/server/src/startup.int.test.ts</files>
  <action>
Review and simplify the server startup test if it uses similar complex patterns.

If it already uses a simple approach (just spawning tsx with controlled env), keep it.
If it uses temp directories or complex setup, simplify similar to web test.

The server test should:
1. Spawn tsx or pnpm build with minimal env
2. Expect failure when DATABASE_URL or other required vars are missing
3. Verify error message mentions the missing var
4. No temp directories or symlinks needed

```typescript
// Simplified pattern
const result = await execAsync("pnpm build", {
  cwd: serverDir,
  env: {
    PATH: process.env.PATH,
    DOTENV_CONFIG_PATH: "/nonexistent",
    // Missing required vars
  },
});
```
  </action>
  <verify>Run `pnpm test:integration` and verify server startup test still passes</verify>
  <done>apps/server/src/startup.int.test.ts simplified (if changes needed)</done>
</task>

</tasks>

<verification>
1. Run `pnpm test:integration` - startup tests pass
2. Verify no temp directory creation in test code
3. Verify no symlink operations in test code
4. Test files are under max_lines limit
5. Type check passes: `pnpm check-types`
</verification>

<success_criteria>
- Startup tests use actual build commands (pnpm build or tsx)
- No temp directory creation or symlinks
- Tests properly prevent .env auto-loading
- Code is significantly simpler
- All tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/03.4-integration-test-coverage/03.4-06-SUMMARY.md`
</output>
