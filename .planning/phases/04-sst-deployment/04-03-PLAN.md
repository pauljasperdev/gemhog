---
phase: 04-sst-deployment
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - apps/server/src/app.ts
  - apps/server/src/lambda.ts
  - apps/server/src/serve.ts
  - apps/server/src/index.ts
  - apps/server/package.json
autonomous: true

must_haves:
  truths:
    - "Hono app is extracted to a shared module importable by both entrypoints"
    - "Lambda entrypoint exports handler with conditional streaming"
    - "Local dev entrypoint serves the app on port 3000"
    - "Local development works with pnpm dev:server"
  artifacts:
    - path: "apps/server/src/app.ts"
      provides: "Shared Hono application"
      exports: ["app"]
    - path: "apps/server/src/lambda.ts"
      provides: "Lambda handler entrypoint"
      exports: ["handler"]
    - path: "apps/server/src/serve.ts"
      provides: "Local development entrypoint"
      min_lines: 10
  key_links:
    - from: "apps/server/src/lambda.ts"
      to: "apps/server/src/app.ts"
      via: "app import"
      pattern: "from.*./app"
    - from: "apps/server/src/serve.ts"
      to: "apps/server/src/app.ts"
      via: "app import"
      pattern: "from.*./app"
---

<objective>
Refactor Hono server to support both Lambda deployment and local development.

Purpose: The current index.ts combines app creation and serve() in one file. For SST deployment, we need separate entrypoints: lambda.ts for AWS Lambda (with streaming), serve.ts for local dev. Extract the shared app to app.ts.

Output: Three server files - app.ts (shared), lambda.ts (Lambda handler), serve.ts (local dev).
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-sst-deployment/04-CONTEXT.md
@.planning/phases/04-sst-deployment/04-RESEARCH.md
@.planning/phases/04-sst-deployment/04-01-SUMMARY.md
@apps/server/src/index.ts
@apps/server/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract Hono app to apps/server/src/app.ts</name>
  <files>apps/server/src/app.ts</files>
  <action>
Create `apps/server/src/app.ts` by extracting the Hono app from index.ts:

Move ALL of the following from index.ts to app.ts:
- All imports (except @hono/node-server serve)
- Message validation schemas (TextPartSchema, FilePartSchema, etc.)
- Rate limiting code (rateLimitStore, RATE_LIMIT, RATE_WINDOW, rateLimit function)
- Rate limit cleanup setInterval
- Hono app creation (`const app = new Hono()`)
- All middleware (logger, cors)
- All routes (auth, trpc, ai, health)

Export the app:
```typescript
export { app };
```

The app should be fully configured and ready to use. Only the entrypoint (serve/lambda) differs.

Why extract: RESEARCH.md Pitfall 5 - "Current index.ts has app creation + serve() in same file" causes build errors in Lambda.
  </action>
  <verify>
```bash
# File exists and exports app
grep "export.*app" apps/server/src/app.ts
```
  </verify>
  <done>Hono app extracted to app.ts with all routes and middleware</done>
</task>

<task type="auto">
  <name>Task 2: Create Lambda entrypoint at apps/server/src/lambda.ts</name>
  <files>apps/server/src/lambda.ts</files>
  <action>
Create `apps/server/src/lambda.ts` for AWS Lambda deployment:

```typescript
import { handle, streamHandle } from "@hono/aws-lambda";
import { app } from "./app";

// Conditional handler: streaming not supported in sst dev
// SST_DEV is set when running `sst dev` for local Lambda emulation
// Production Lambda uses streamHandle for AI streaming responses
export const handler = process.env.SST_DEV ? handle(app) : streamHandle(app);
```

Why conditional per RESEARCH.md Pitfall 1:
- `sst dev` uses a proxy that doesn't support AWS streaming protocol
- Production Lambda needs streaming for AI chat responses
- SST_DEV env var is set automatically by SST during development
  </action>
  <verify>
```bash
# File exists with handler export
grep "export.*handler" apps/server/src/lambda.ts
```
  </verify>
  <done>Lambda handler created with conditional streaming support</done>
</task>

<task type="auto">
  <name>Task 3: Create local dev entrypoint at apps/server/src/serve.ts and update package.json</name>
  <files>apps/server/src/serve.ts, apps/server/src/index.ts, apps/server/package.json</files>
  <action>
1. Create `apps/server/src/serve.ts` for local development:

```typescript
import { serve } from "@hono/node-server";
import { app } from "./app";

serve(
  {
    fetch: app.fetch,
    port: 3000,
  },
  (info) => {
    console.log(`Server is running on http://localhost:${info.port}`);
  },
);
```

2. Delete `apps/server/src/index.ts` (all code moved to app.ts and serve.ts)

3. Update `apps/server/package.json`:
   - Change `"main": "src/index.ts"` to `"main": "src/serve.ts"`
   - Change dev script: `"dev": "tsx watch src/serve.ts"`
   - Keep start script pointing to dist (will need build update later)

This ensures `pnpm dev:server` continues to work for local development.
  </action>
  <verify>
```bash
# serve.ts exists
cat apps/server/src/serve.ts

# index.ts is deleted
ls apps/server/src/index.ts 2>&1 | grep -q "No such file" && echo "index.ts deleted" || echo "ERROR: index.ts still exists"

# package.json updated
grep -A1 '"dev"' apps/server/package.json

# Local dev still works (start server, check health, stop)
timeout 5s pnpm dev:server &
sleep 2
curl -s http://localhost:3000/ | grep -q "OK" && echo "Health check passed" || echo "Health check failed"
pkill -f "tsx watch" 2>/dev/null || true
```
  </verify>
  <done>Local dev entrypoint created, index.ts deleted, package.json updated, pnpm dev:server works</done>
</task>

</tasks>

<verification>
```bash
# All three server files exist
ls apps/server/src/app.ts apps/server/src/lambda.ts apps/server/src/serve.ts

# Type check passes
pnpm check-types

# Local development works
timeout 5s pnpm dev:server &
sleep 2
curl -s http://localhost:3000/
pkill -f "tsx watch" 2>/dev/null || true
```
</verification>

<success_criteria>
- apps/server/src/app.ts exports Hono app with all routes/middleware
- apps/server/src/lambda.ts exports handler with conditional streaming
- apps/server/src/serve.ts runs local Node server on port 3000
- apps/server/src/index.ts is deleted (all code moved)
- pnpm dev:server starts the server successfully
- Type check passes
</success_criteria>

<output>
After completion, create `.planning/phases/04-sst-deployment/04-03-SUMMARY.md`
</output>
