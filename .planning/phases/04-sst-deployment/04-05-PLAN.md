---
phase: 04-sst-deployment
plan: 05
type: execute
wave: 3
depends_on: ["04-04"]
files_modified:
  - .planning/codebase/STACK.md
  - .planning/codebase/CONCERNS.md
  - .planning/codebase/ARCHITECTURE.md
autonomous: false

must_haves:
  truths:
    - "SST type generation succeeds with `sst types`"
    - "All SST secrets are set for the target stage"
    - "sst deploy completes without errors"
    - "API health endpoint returns OK"
    - "Web app loads in browser"
  artifacts:
    - path: ".sst/platform/config.d.ts"
      provides: "Generated SST types"
      min_lines: 10
  key_links:
    - from: "infra/api.ts"
      to: "apps/server/src/lambda.handler"
      via: "Lambda handler"
      pattern: "handler.*lambda.handler"
---

<objective>
Verify SST deployment works and update documentation.

Purpose: Ensure the SST infrastructure deploys correctly to AWS. This is a checkpoint plan - after automation sets up types and verifies configuration, user performs actual deployment and confirms both apps work.

Output: Working deployment, updated documentation reflecting SST infrastructure.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-sst-deployment/04-CONTEXT.md
@.planning/phases/04-sst-deployment/04-RESEARCH.md
@.planning/phases/04-sst-deployment/04-04-SUMMARY.md
@sst.config.ts
@infra/api.ts
@infra/web.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Generate SST types and verify configuration</name>
  <files>.sst/</files>
  <action>
Generate SST types to verify the configuration is valid:

```bash
pnpm exec sst types
```

This command:
- Validates sst.config.ts syntax
- Generates TypeScript types in .sst/platform/
- Catches configuration errors before deployment

If errors occur, fix them before proceeding to deployment.

Also run type check to ensure infra code compiles:
```bash
pnpm check-types
```
  </action>
  <verify>
```bash
# Types generated
ls .sst/platform/config.d.ts

# Type check passes (infra code uses SST globals)
pnpm check-types
```
  </verify>
  <done>SST types generated, configuration valid, type check passes</done>
</task>

<task type="auto">
  <name>Task 2: Update documentation for SST deployment</name>
  <files>.planning/codebase/STACK.md, .planning/codebase/CONCERNS.md, .planning/codebase/ARCHITECTURE.md</files>
  <action>
Update codebase documentation to reflect SST infrastructure:

1. In `.planning/codebase/STACK.md`, add to Infrastructure section:
   - SST v3 - Infrastructure as code
   - @hono/aws-lambda - Lambda adapter
   - Note about infra/ folder structure

2. In `.planning/codebase/CONCERNS.md`:
   - Remove "Missing environment validation for AI key" - now fixed
   - Add note about Cloudflare configuration requirements (CLOUDFLARE_ZONE_ID, API token)

3. In `.planning/codebase/ARCHITECTURE.md`:
   - Update "Production" section to describe SST deployment
   - Document infra/ folder and its purpose
   - Add deployment data flow
  </action>
  <verify>
```bash
# Documentation updated
grep -l "SST" .planning/codebase/STACK.md .planning/codebase/ARCHITECTURE.md
```
  </verify>
  <done>Documentation updated with SST infrastructure details</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
SST infrastructure configuration:
- sst.config.ts with app config and dynamic imports
- infra/secrets.ts with SST secrets
- infra/neon.ts with database Linkable
- infra/api.ts with Hono Lambda and Router
- infra/web.ts with Next.js component
- Lambda handler with conditional streaming
  </what-built>
  <how-to-verify>
**Prerequisites (user must set up):**

1. Set SST secrets for your stage (e.g., dev):
   ```bash
   pnpm exec sst secret set DatabaseUrl "postgresql://..." --stage dev
   pnpm exec sst secret set DatabaseUrlPooler "postgresql://...?pgbouncer=true" --stage dev
   pnpm exec sst secret set BetterAuthSecret "your-32-char-secret" --stage dev
   pnpm exec sst secret set GoogleApiKey "your-google-api-key" --stage dev
   ```

2. Set Cloudflare environment variables:
   ```bash
   export CLOUDFLARE_API_TOKEN="your-cloudflare-api-token"
   export CLOUDFLARE_DEFAULT_ACCOUNT_ID="your-account-id"
   export CLOUDFLARE_ZONE_ID="your-zone-id"
   ```

**Deploy:**

```bash
pnpm exec sst deploy --stage dev
```

**Verify:**

1. Check API health:
   ```bash
   curl https://api.dev.gemhog.com/
   # Should return: OK
   ```

2. Check web app:
   - Open https://dev.gemhog.com in browser
   - Homepage should load
   - Sign up / sign in should work

3. Check AI endpoint (requires auth):
   - Sign in to the app
   - Navigate to /ai
   - Send a test message
   - Response should stream back

**If issues:**
- Check CloudWatch logs for Lambda errors
- Run `pnpm exec sst console` for debugging UI
- Verify secrets are set: `pnpm exec sst secret list --stage dev`
  </how-to-verify>
  <resume-signal>Type "deployed" with the deployed URLs, or describe issues encountered</resume-signal>
</task>

</tasks>

<verification>
User verification required - deployment success confirmed by human.
</verification>

<success_criteria>
- SST types generate without errors
- Documentation updated with SST details
- User confirms deployment succeeds
- API health endpoint returns OK
- Web app loads and auth works
- AI streaming works in deployed Lambda
</success_criteria>

<output>
After completion, create `.planning/phases/04-sst-deployment/04-05-SUMMARY.md`
</output>
